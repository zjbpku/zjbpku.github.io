# æ·±å…¥ Compose ç¼–è¯‘å™¨ï¼šSlot Table ä¸ä½ç½®è®°å¿†åŒ–

> **å‘å¸ƒæ—¥æœŸ**: 2024-04-25  
> **é˜…è¯»æ—¶é—´**: çº¦ 30 åˆ†é’Ÿ  
> **æ ‡ç­¾**: Compose Compiler, Slot Table, Gap Buffer, Positional Memoization

å½“ä½ å†™ä¸‹ä¸€ä¸ªç®€å•çš„ `@Composable` å‡½æ•°æ—¶ï¼ŒCompose ç¼–è¯‘å™¨åœ¨èƒŒååšäº†å¤§é‡å·¥ä½œã€‚ç†è§£è¿™äº›åº•å±‚æœºåˆ¶ä¸ä»…èƒ½å¸®åŠ©ä½ å†™å‡ºæ›´é«˜æ•ˆçš„ä»£ç ï¼Œè¿˜èƒ½è®©ä½ åœ¨é‡åˆ°æ€§èƒ½é—®é¢˜æ—¶çŸ¥é“ä»ä½•ä¸‹æ‰‹ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ Compose ç¼–è¯‘å™¨çš„æ ¸å¿ƒï¼š**Slot Table** æ•°æ®ç»“æ„å’Œ**ä½ç½®è®°å¿†åŒ–ï¼ˆPositional Memoizationï¼‰**æœºåˆ¶ã€‚

## ğŸ“š å®˜æ–¹å‚è€ƒ

- [Thinking in Compose - Android Developers](https://developer.android.com/jetpack/compose/mental-model)
- [Compose Runtime Source Code](https://cs.android.com/androidx/platform/frameworks/support/+/androidx-main:compose/runtime/)

## ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦ Slot Tableï¼Ÿ

ä¼ ç»Ÿçš„ UI æ¡†æ¶ï¼ˆå¦‚ Android View ç³»ç»Ÿï¼‰ä½¿ç”¨**å¯¹è±¡æ ‘**æ¥è¡¨ç¤º UI ç»“æ„ã€‚æ¯ä¸ª View æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒæŒæœ‰è‡ªå·±çš„çŠ¶æ€ï¼Œé€šè¿‡çˆ¶å­å¼•ç”¨å½¢æˆæ ‘å½¢ç»“æ„ã€‚è¿™ç§æ–¹å¼ç›´è§‚ä½†æœ‰å‡ ä¸ªé—®é¢˜ï¼š

- **å†…å­˜å¼€é”€å¤§**ï¼šæ¯ä¸ª View å¯¹è±¡éƒ½æœ‰è‡ªå·±çš„å†…å­˜åˆ†é…
- **GC å‹åŠ›**ï¼šé¢‘ç¹åˆ›å»º/é”€æ¯ View ä¼šè§¦å‘åƒåœ¾å›æ”¶
- **æ›´æ–°æ•ˆç‡ä½**ï¼šéœ€è¦éå†æ•´æ£µæ ‘æ¥æ‰¾åˆ°éœ€è¦æ›´æ–°çš„èŠ‚ç‚¹

Compose é‡‡ç”¨äº†å®Œå…¨ä¸åŒçš„æ–¹å¼ï¼šå®ƒä¸åˆ›å»º UI å¯¹è±¡æ ‘ï¼Œè€Œæ˜¯å°†æ‰€æœ‰ UI ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªæ‰å¹³çš„æ•°ç»„ç»“æ„ä¸­â€”â€”è¿™å°±æ˜¯ **Slot Table**ã€‚

> ğŸ’¡ **æ ¸å¿ƒæ´å¯Ÿ**  
> Slot Table æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª**çº¿æ€§åŒ–çš„ UI æè¿°**ã€‚å®ƒæŠŠæ ‘å½¢ç»“æ„"å‹æ‰"æˆæ•°ç»„ï¼Œç”¨ä½ç½®ä¿¡æ¯æ¥éšå¼è¡¨è¾¾çˆ¶å­å…³ç³»ã€‚è¿™ç§è®¾è®¡å€Ÿé‰´äº†ç¼–è¯‘å™¨å’Œæ•°æ®åº“é¢†åŸŸçš„æŠ€æœ¯ã€‚

## äºŒã€Slot Table çš„æ•°æ®ç»“æ„

Slot Table ç”±ä¸¤ä¸ªä¸»è¦æ•°ç»„ç»„æˆï¼š

1. **Groups Array**ï¼šå­˜å‚¨ç»“æ„ä¿¡æ¯ï¼ˆå“ªäº› Composable è¢«è°ƒç”¨ã€å®ƒä»¬çš„å±‚çº§å…³ç³»ï¼‰
2. **Slots Array**ï¼šå­˜å‚¨æ•°æ®ï¼ˆçŠ¶æ€å€¼ã€remember çš„å€¼ã€å‚æ•°ç­‰ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Slot Table                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Groups Array (ç»“æ„ä¿¡æ¯)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ G0 â”‚ G1 â”‚ G2 â”‚ G3 â”‚    â”‚    â”‚    â”‚ G4 â”‚ G5 â”‚ G6 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜       â”‚
â”‚                        â†‘ Gap                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Slots Array (æ•°æ®)                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ S0 â”‚ S1 â”‚ S2 â”‚    â”‚    â”‚    â”‚ S3 â”‚ S4 â”‚ S5 â”‚ S6 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜       â”‚
â”‚                   â†‘ Gap                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Group çš„ç»“æ„

æ¯ä¸ª Group ä»£è¡¨ä¸€æ¬¡ Composable è°ƒç”¨æˆ–ä¸€ä¸ªé€»è¾‘åˆ†ç»„ï¼ŒåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

```kotlin
// ç®€åŒ–çš„ Group ç»“æ„ï¼ˆå®é™…å®ç°æ›´å¤æ‚ï¼‰
internal class Group {
    val key: Int           // å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºåŒ¹é…
    val dataAnchor: Int    // æŒ‡å‘ Slots Array ä¸­æ•°æ®çš„èµ·å§‹ä½ç½®
    val parentAnchor: Int  // çˆ¶ Group çš„ç´¢å¼•
    val size: Int          // å­ Group çš„æ•°é‡
    val nodeCount: Int     // åŒ…å«çš„ LayoutNode æ•°é‡
}
```

> ğŸ“š **æºç å‚è€ƒ**  
> [SlotTable.kt - Compose Runtime](https://cs.android.com/androidx/platform/frameworks/support/+/androidx-main:compose/runtime/runtime/src/commonMain/kotlin/androidx/compose/runtime/SlotTable.kt)

## ä¸‰ã€Gap Buffer ç®—æ³•

Slot Table ä½¿ç”¨ **Gap Buffer** ç®—æ³•æ¥é«˜æ•ˆå¤„ç†æ’å…¥å’Œåˆ é™¤æ“ä½œã€‚è¿™ä¸ªç®—æ³•æœ€åˆæ¥è‡ªæ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆå¦‚ Emacsï¼‰ï¼Œç”¨äºå¤„ç†å…‰æ ‡ä½ç½®çš„æ–‡æœ¬ç¼–è¾‘ã€‚

### Gap Buffer çš„å·¥ä½œåŸç†

Gap Buffer åœ¨æ•°ç»„ä¸­ç»´æŠ¤ä¸€ä¸ª"ç©ºéš™"ï¼ˆGapï¼‰ï¼Œæ‰€æœ‰çš„æ’å…¥/åˆ é™¤æ“ä½œéƒ½åœ¨ Gap çš„ä½ç½®è¿›è¡Œï¼š

```
åˆå§‹çŠ¶æ€ï¼š
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ A â”‚ B â”‚ C â”‚   â”‚   â”‚   â”‚ D â”‚ E â”‚ F â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
            â†‘ Gap (cursor)

åœ¨ C åæ’å…¥ Xï¼šï¼ˆO(1) æ“ä½œï¼‰
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ A â”‚ B â”‚ C â”‚ X â”‚   â”‚   â”‚ D â”‚ E â”‚ F â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
                â†‘ Gap moved

ç§»åŠ¨åˆ° E åæ’å…¥ Yï¼šï¼ˆéœ€è¦å…ˆç§»åŠ¨ Gapï¼‰
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ A â”‚ B â”‚ C â”‚ X â”‚ D â”‚ E â”‚ Y â”‚   â”‚ F â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
                            â†‘ Gap
```

Gap Buffer çš„ä¼˜åŠ¿åœ¨äºï¼š

- **å±€éƒ¨æ€§åŸåˆ™**ï¼šè¿ç»­çš„æ’å…¥/åˆ é™¤æ“ä½œï¼ˆå¦‚ Recomposition æ—¶ï¼‰é€šå¸¸å‘ç”Ÿåœ¨ç›¸é‚»ä½ç½®ï¼ŒGap ä¸éœ€è¦é¢‘ç¹ç§»åŠ¨
- **O(1) å±€éƒ¨æ“ä½œ**ï¼šåœ¨ Gap ä½ç½®çš„æ’å…¥/åˆ é™¤æ˜¯å¸¸æ•°æ—¶é—´
- **å†…å­˜è¿ç»­**ï¼šæ•°æ®å­˜å‚¨åœ¨è¿ç»­å†…å­˜ä¸­ï¼Œç¼“å­˜å‹å¥½

> ğŸ”¬ **ä¸ºä»€ä¹ˆé€‰æ‹© Gap Bufferï¼Ÿ**  
> Compose çš„ Recomposition å…·æœ‰å¾ˆå¼ºçš„**å±€éƒ¨æ€§**ï¼šå½“çŠ¶æ€å˜åŒ–æ—¶ï¼Œé€šå¸¸åªæœ‰ä¸€å°éƒ¨åˆ† UI éœ€è¦æ›´æ–°ï¼Œè€Œä¸”è¿™äº›æ›´æ–°å¾€å¾€æ˜¯è¿ç»­çš„ã€‚Gap Buffer æ­£å¥½åˆ©ç”¨äº†è¿™ä¸€ç‰¹æ€§ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æä¾› O(1) çš„æ›´æ–°æ€§èƒ½ã€‚

## å››ã€ä½ç½®è®°å¿†åŒ–ï¼ˆPositional Memoizationï¼‰

è¿™æ˜¯ Compose æœ€æ ¸å¿ƒçš„åˆ›æ–°ä¹‹ä¸€ã€‚ä¼ ç»Ÿçš„è®°å¿†åŒ–ï¼ˆMemoizationï¼‰åŸºäº**å‚æ•°å€¼**æ¥ç¼“å­˜ç»“æœï¼Œè€Œ Compose çš„ä½ç½®è®°å¿†åŒ–åŸºäº**è°ƒç”¨ä½ç½®**ã€‚

### ä¼ ç»Ÿè®°å¿†åŒ– vs ä½ç½®è®°å¿†åŒ–

```kotlin
// ä¼ ç»Ÿè®°å¿†åŒ–ï¼šåŸºäºå‚æ•°å€¼
val cache = mutableMapOf<Args, Result>()
fun memoized(args: Args): Result {
    return cache.getOrPut(args) { compute(args) }
}

// ä½ç½®è®°å¿†åŒ–ï¼šåŸºäºè°ƒç”¨ä½ç½®
@Composable
fun Example() {
    // å³ä½¿å‚æ•°ç›¸åŒï¼Œè¿™ä¸¤ä¸ª remember å­˜å‚¨åœ¨ä¸åŒä½ç½®
    val state1 = remember { mutableStateOf(0) }  // ä½ç½® A
    val state2 = remember { mutableStateOf(0) }  // ä½ç½® B
    // state1 å’Œ state2 æ˜¯ç‹¬ç«‹çš„ï¼
}
```

### ç¼–è¯‘å™¨å¦‚ä½•å®ç°ä½ç½®è®°å¿†åŒ–

Compose ç¼–è¯‘å™¨ä¼šä¸ºæ¯ä¸ª `@Composable` å‡½æ•°æ³¨å…¥é¢å¤–çš„å‚æ•°å’Œä»£ç ï¼š

```kotlin
// ä½ å†™çš„ä»£ç 
@Composable
fun Greeting(name: String) {
    Text("Hello, $name")
}

// ç¼–è¯‘å™¨è½¬æ¢åï¼ˆç®€åŒ–ç‰ˆï¼‰
fun Greeting(
    name: String,
    $composer: Composer,    // æ³¨å…¥çš„ Composer
    $changed: Int            // å‚æ•°å˜åŒ–æ ‡è®°
) {
    $composer.startRestartGroup(123456789)  // å”¯ä¸€çš„ Group Key
    
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥è·³è¿‡
    if ($changed == 0 && $composer.skipping) {
        $composer.skipToGroupEnd()
    } else {
        Text("Hello, $name", $composer, 0)
    }
    
    $composer.endRestartGroup()?.updateScope { 
        Greeting(name, $composer, $changed or 1) 
    }
}
```

### Group Key çš„ç”Ÿæˆ

ç¼–è¯‘å™¨ä¸ºæ¯ä¸ª Composable è°ƒç”¨ç”Ÿæˆå”¯ä¸€çš„ **Group Key**ï¼Œè¿™ä¸ª Key åŸºäºï¼š

- æºæ–‡ä»¶è·¯å¾„
- è¡Œå·å’Œåˆ—å·
- è°ƒç”¨é¡ºåº

```kotlin
// è¿™ä¸¤ä¸ª Text æœ‰ä¸åŒçš„ Group Key
@Composable
fun TwoTexts() {
    Text("First")   // Key: hash("TwoTexts.kt:5:4")
    Text("Second")  // Key: hash("TwoTexts.kt:6:4")
}
```

> âš ï¸ **æ¡ä»¶è¯­å¥çš„é™·é˜±**  
> ä½ç½®è®°å¿†åŒ–æ„å‘³ç€**è°ƒç”¨é¡ºåºå¾ˆé‡è¦**ã€‚å¦‚æœåœ¨æ¡ä»¶è¯­å¥ä¸­è°ƒç”¨ Composableï¼Œæ¡ä»¶å˜åŒ–å¯èƒ½å¯¼è‡´ä½ç½®é”™ä¹±ã€‚

```kotlin
// âŒ å±é™©ï¼šæ¡ä»¶å˜åŒ–ä¼šå¯¼è‡´çŠ¶æ€é”™ä¹±
@Composable
fun Problematic(showFirst: Boolean) {
    if (showFirst) {
        Counter()  // ä½ç½® 0
    }
    Counter()      // showFirst=true æ—¶ä½ç½® 1ï¼Œfalse æ—¶ä½ç½® 0ï¼
}

// âœ… ä½¿ç”¨ key æ˜ç¡®èº«ä»½
@Composable
fun Safe(showFirst: Boolean) {
    if (showFirst) {
        key("first") { Counter() }
    }
    key("second") { Counter() }
}
```

## äº”ã€Recomposition çš„æ‰§è¡Œè¿‡ç¨‹

å½“çŠ¶æ€å˜åŒ–è§¦å‘ Recomposition æ—¶ï¼ŒCompose æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

```
Recomposition æµç¨‹

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  State Changed  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Find Invalid    â”‚  â† æ‰¾åˆ°è¯»å–è¯¥çŠ¶æ€çš„ Scope
â”‚ RecomposeScope  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Seek to Group   â”‚  â† ç§»åŠ¨ Gap åˆ°å¯¹åº”ä½ç½®
â”‚ in Slot Table   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Re-execute      â”‚  â† é‡æ–°æ‰§è¡Œ Composable
â”‚ Composable      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Compare & Diff  â”‚  â† æ¯”è¾ƒæ–°æ—§æ•°æ®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Update Slot     â”‚  â† æ›´æ–°å˜åŒ–çš„éƒ¨åˆ†
â”‚ Table           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Apply Changes   â”‚  â† åº”ç”¨åˆ° LayoutNode
â”‚ to UI           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Composer çš„è¯»å†™æ¨¡å¼

Composer åœ¨æ‰§è¡Œ Composable æ—¶æœ‰ä¸¤ç§æ¨¡å¼ï¼š

```kotlin
internal class Composer {
    var inserting: Boolean = false
    
    // inserting = true: é¦–æ¬¡ç»„åˆï¼Œå†™å…¥æ–°æ•°æ®
    // inserting = false: é‡ç»„ï¼Œè¯»å–å¹¶æ¯”è¾ƒ
    
    fun <T> remember(calculation: () -> T): T {
        return if (inserting) {
            // é¦–æ¬¡ï¼šè®¡ç®—å¹¶å­˜å‚¨
            val value = calculation()
            updateValue(value)
            value
        } else {
            // é‡ç»„ï¼šä» Slot Table è¯»å–
            nextSlot() as T
        }
    }
}
```

## å…­ã€$changed å‚æ•°ä¸è·³è¿‡ä¼˜åŒ–

ç¼–è¯‘å™¨æ³¨å…¥çš„ `$changed` å‚æ•°æ˜¯ä¸€ä¸ªä½æ©ç ï¼Œç”¨äºè¿½è¸ªå“ªäº›å‚æ•°å‘ç”Ÿäº†å˜åŒ–ï¼š

```kotlin
// $changed ä½æ©ç ç»“æ„
// æ¯ä¸ªå‚æ•°å ç”¨ 3 ä½ï¼š
// - bit 0: æ˜¯å¦"è„"ï¼ˆéœ€è¦æ£€æŸ¥ï¼‰
// - bit 1-2: ç¨³å®šæ€§ä¿¡æ¯

@Composable
fun Example(
    a: Int,      // bits 0-2
    b: String,   // bits 3-5
    c: User      // bits 6-8
)

// è°ƒç”¨æ—¶ï¼š
Example(
    a = 1,
    b = "hello",
    c = user,
    $composer = composer,
    $changed = 0b_000_001_000  // åªæœ‰ b å˜åŒ–äº†
)
```

é€šè¿‡ `$changed` å‚æ•°ï¼ŒCompose å¯ä»¥åœ¨ä¸æ‰§è¡Œå‡½æ•°ä½“çš„æƒ…å†µä¸‹åˆ¤æ–­æ˜¯å¦éœ€è¦é‡ç»„ï¼š

```kotlin
// ç¼–è¯‘å™¨ç”Ÿæˆçš„è·³è¿‡é€»è¾‘
if ($changed and 0b111_111_111 == 0 && $composer.skipping) {
    // æ‰€æœ‰å‚æ•°éƒ½æ²¡å˜ï¼Œè·³è¿‡æ•´ä¸ªå‡½æ•°
    $composer.skipToGroupEnd()
    return
}
```

> ğŸ“š **æ·±å…¥é˜…è¯»**  
> - [Jetpack Compose Internals - Jorge Castillo](https://jorgecastillo.dev/book/)
> - [Under the hood of Jetpack Compose - Android Developers Blog](https://medium.com/androiddevelopers/under-the-hood-of-jetpack-compose-part-2-of-2-37b2c20c852)

## ä¸ƒã€å®é™…åº”ç”¨ï¼šä¼˜åŒ–ä½ çš„ä»£ç 

ç†è§£äº†è¿™äº›åŸç†ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºæ›´é«˜æ•ˆçš„ Compose ä»£ç ï¼š

### 1. åˆ©ç”¨ä½ç½®è®°å¿†åŒ–

```kotlin
// âœ… å¥½ï¼šremember çš„å€¼ä¼šè¢«æ­£ç¡®ä¿ç•™
@Composable
fun GoodExample() {
    val state = remember { ExpensiveObject() }
    // state åªåœ¨é¦–æ¬¡ç»„åˆæ—¶åˆ›å»º
}

// âŒ å·®ï¼šæ¯æ¬¡é‡ç»„éƒ½åˆ›å»ºæ–°å¯¹è±¡
@Composable
fun BadExample() {
    val state = ExpensiveObject()  // æ²¡æœ‰ rememberï¼
}
```

### 2. ä¿æŒè°ƒç”¨é¡ºåºç¨³å®š

```kotlin
// âœ… å¥½ï¼šä½¿ç”¨ key ä¿æŒèº«ä»½
@Composable
fun ItemList(items: List<Item>) {
    Column {
        items.forEach { item ->
            key(item.id) {  // æ˜ç¡®çš„èº«ä»½
                ItemRow(item)
            }
        }
    }
}

// âŒ å·®ï¼šä¾èµ–éšå¼ä½ç½®
@Composable
fun ItemList(items: List<Item>) {
    Column {
        items.forEach { item ->
            ItemRow(item)  // åˆ—è¡¨é‡æ’åºä¼šå¯¼è‡´çŠ¶æ€é”™ä¹±
        }
    }
}
```

### 3. å‡å°‘ Group æ•°é‡

```kotlin
// âœ… å¥½ï¼šå†…è”ç®€å•é€»è¾‘
@Composable
fun Efficient(text: String) {
    Text(
        text = text,
        color = if (text.isEmpty()) Color.Gray else Color.Black
    )
}

// âŒ å·®ï¼šä¸å¿…è¦çš„åµŒå¥— Composable
@Composable
fun Inefficient(text: String) {
    TextWithColor(text)  // é¢å¤–çš„ Group å¼€é”€
}

@Composable
fun TextWithColor(text: String) {
    Text(
        text = text,
        color = if (text.isEmpty()) Color.Gray else Color.Black
    )
}
```

## å…«ã€è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹ç¼–è¯‘å™¨è¾“å‡º

ä½ å¯ä»¥é…ç½® Compose ç¼–è¯‘å™¨è¾“å‡ºä¸­é—´ä»£ç ï¼š

```kotlin
// build.gradle.kts
composeCompiler {
    reportsDestination = layout.buildDirectory.dir("compose_reports")
    metricsDestination = layout.buildDirectory.dir("compose_metrics")
}
```

### ä½¿ç”¨ Layout Inspector

Android Studio çš„ Layout Inspector å¯ä»¥æ˜¾ç¤º Recomposition è®¡æ•°ï¼Œå¸®åŠ©ä½ æ‰¾åˆ°é¢‘ç¹é‡ç»„çš„ç»„ä»¶ã€‚

## æ€»ç»“

Compose ç¼–è¯‘å™¨çš„æ ¸å¿ƒè®¾è®¡ï¼š

- **Slot Table**ï¼šç”¨æ‰å¹³æ•°ç»„å­˜å‚¨ UI ä¿¡æ¯ï¼Œé¿å…å¯¹è±¡æ ‘çš„å¼€é”€
- **Gap Buffer**ï¼šåˆ©ç”¨å±€éƒ¨æ€§åŸåˆ™ï¼Œæä¾› O(1) çš„å±€éƒ¨æ›´æ–°
- **ä½ç½®è®°å¿†åŒ–**ï¼šåŸºäºè°ƒç”¨ä½ç½®ç¼“å­˜æ•°æ®ï¼Œè€Œéå‚æ•°å€¼
- **$changed å‚æ•°**ï¼šä½æ©ç è¿½è¸ªå‚æ•°å˜åŒ–ï¼Œæ”¯æŒè·³è¿‡ä¼˜åŒ–

ç†è§£è¿™äº›åº•å±‚æœºåˆ¶ï¼Œèƒ½å¸®åŠ©ä½ ï¼š

- å†™å‡ºæ›´é«˜æ•ˆçš„ Compose ä»£ç 
- é¿å…å¸¸è§çš„æ€§èƒ½é™·é˜±
- åœ¨é‡åˆ°é—®é¢˜æ—¶çŸ¥é“å¦‚ä½•è°ƒè¯•

## ğŸ“š æ¨èé˜…è¯»

- [Compose Performance - Android Developers](https://developer.android.com/jetpack/compose/performance)
- [Compose Runtime Deep Dive - Android Dev Summit](https://www.youtube.com/watch?v=Q9MtlmmN4Q0)
- [Jetpack Compose Internals Book](https://jorgecastillo.dev/book/)

---

*Â© 2024 Fidroid. [è¿”å›é¦–é¡µ](../index.html)*

