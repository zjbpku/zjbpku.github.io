<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compose ä¸ View äº’æ“ä½œå®Œå…¨æŒ‡å—ï¼šæ¸è¿›å¼è¿ç§»çš„æ­£ç¡®å§¿åŠ¿ - Fidroid</title>
    <meta name="description" content="æ·±å…¥å­¦ä¹  Compose ä¸ View çš„åŒå‘äº’æ“ä½œï¼ŒæŒæ¡ AndroidViewã€ComposeView çš„ä½¿ç”¨ï¼Œä»¥åŠæ¸è¿›å¼è¿ç§»çš„æœ€ä½³å®è·µã€‚">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.8;
            color: #e5e7eb;
            background: #020617;
        }
        .navbar {
            background: rgba(15,23,42,0.98);
            backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }
        .nav-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #38bdf8;
            text-decoration: none;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .back-link { color: #9ca3af; text-decoration: none; font-size: 0.9rem; }
        .back-link:hover { color: #38bdf8; }

        .article-header {
            padding: 120px 20px 60px;
            background: radial-gradient(circle at top left, #22c55e 0, transparent 50%),
                        radial-gradient(circle at bottom right, #3b82f6 0, transparent 55%),
                        #020617;
            text-align: center;
        }
        .article-header h1 {
            max-width: 800px;
            margin: 0 auto 1rem;
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            color: #fff;
        }
        .article-meta { color: #9ca3af; font-size: 0.9rem; margin-bottom: 1.5rem; }
        .article-tags { display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem; }
        .article-tag {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            background: rgba(15,23,42,0.85);
            border: 1px solid rgba(34,197,94,0.4);
            color: #4ade80;
        }

        .article-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 60px 20px 80px;
        }
        .article-content h2 {
            font-size: 1.6rem;
            margin: 2.5rem 0 1rem;
            color: #f9fafb;
            border-left: 4px solid #22c55e;
            padding-left: 1rem;
        }
        .article-content h3 { font-size: 1.25rem; margin: 2rem 0 0.75rem; color: #e5e7eb; }
        .article-content p { margin-bottom: 1.25rem; color: #d1d5db; }
        .article-content ul, .article-content ol { margin: 1rem 0 1.5rem 1.5rem; color: #d1d5db; }
        .article-content li { margin-bottom: 0.5rem; }
        .article-content strong { color: #f9fafb; }
        .article-content a { color: #38bdf8; text-decoration: underline; }

        pre {
            background: #0f172a;
            border: 1px solid rgba(34,197,94,0.3);
            border-radius: 12px;
            padding: 1.25rem;
            overflow-x: auto;
            margin: 1.5rem 0;
            font-size: 0.85rem;
            line-height: 1.6;
        }
        code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; color: #e5e7eb; }
        .code-keyword { color: #c084fc; }
        .code-func { color: #38bdf8; }
        .code-type { color: #4ade80; }
        .code-string { color: #fb7185; }
        .code-comment { color: #6b7280; font-style: italic; }
        .code-number { color: #fbbf24; }

        .callout {
            background: rgba(34,197,94,0.1);
            border: 1px solid rgba(34,197,94,0.3);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            margin: 1.5rem 0;
        }
        .callout-title { font-weight: 600; color: #4ade80; margin-bottom: 0.5rem; }
        .callout p { margin-bottom: 0; color: #d1d5db; }

        .callout-warning {
            background: rgba(251,146,60,0.1);
            border: 1px solid rgba(251,146,60,0.3);
        }
        .callout-warning .callout-title { color: #fb923c; }

        .comparison-table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; font-size: 0.9rem; }
        .comparison-table th, .comparison-table td { border: 1px solid rgba(148,163,184,0.3); padding: 0.75rem 1rem; text-align: left; }
        .comparison-table th { background: rgba(15,23,42,0.8); color: #f9fafb; }
        .comparison-table td { color: #d1d5db; }

        .footer {
            background: #020617;
            border-top: 1px solid #111827;
            padding: 2rem;
            text-align: center;
            color: #6b7280;
        }
        .footer a { color: #38bdf8; text-decoration: none; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="logo">Fidroid</a>
            <a href="../index.html#articles" class="back-link">â† è¿”å›åšå®¢åˆ—è¡¨</a>
        </div>
    </nav>

    <header class="article-header">
        <h1>Compose ä¸ View äº’æ“ä½œå®Œå…¨æŒ‡å—ï¼šæ¸è¿›å¼è¿ç§»çš„æ­£ç¡®å§¿åŠ¿</h1>
        <p class="article-meta">2024-05-08 Â· 26 min Â· äº’æ“ä½œ</p>
        <div class="article-tags">
            <span class="article-tag">AndroidView</span>
            <span class="article-tag">ComposeView</span>
            <span class="article-tag">Interoperability</span>
            <span class="article-tag">Migration</span>
        </div>
    </header>

    <article class="article-content">
        <p>åœ¨ç°å®é¡¹ç›®ä¸­ï¼Œå¾ˆå°‘æœ‰æœºä¼šä»é›¶å¼€å§‹æ„å»ºä¸€ä¸ªçº¯ Compose åº”ç”¨ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç°æœ‰çš„ View ç³»ç»Ÿä¸­é€æ­¥å¼•å…¥ Composeï¼Œæˆ–è€…åœ¨ Compose ä¸­ä½¿ç”¨æˆç†Ÿçš„ View ç»„ä»¶ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ Compose ä¸ View çš„åŒå‘äº’æ“ä½œã€‚</p>

        <h2>ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦äº’æ“ä½œï¼Ÿ</h2>
        <p>Compose è™½ç„¶æ˜¯ Android UI çš„æœªæ¥ï¼Œä½†ç°å®ä¸­æœ‰å¾ˆå¤šåœºæ™¯éœ€è¦ä¸ View ç³»ç»Ÿå…±å­˜ï¼š</p>
        <ul>
            <li><strong>æ¸è¿›å¼è¿ç§»</strong>ï¼šå¤§å‹é¡¹ç›®æ— æ³•ä¸€æ¬¡æ€§é‡å†™</li>
            <li><strong>å¤ç”¨ç°æœ‰ç»„ä»¶</strong>ï¼šMapViewã€WebViewã€ExoPlayer ç­‰æˆç†Ÿç»„ä»¶</li>
            <li><strong>ç¬¬ä¸‰æ–¹ SDK</strong>ï¼šå¾ˆå¤š SDK ä»åŸºäº View ç³»ç»Ÿ</li>
            <li><strong>å›¢é˜Ÿè¿‡æ¸¡æœŸ</strong>ï¼šéƒ¨åˆ†æˆå‘˜è¿˜åœ¨å­¦ä¹  Compose</li>
        </ul>

        <div class="callout">
            <p class="callout-title">ğŸ’¡ Google å®˜æ–¹å»ºè®®</p>
            <p>é‡‡ç”¨æ¸è¿›å¼è¿ç§»ç­–ç•¥ï¼Œä»æ–°åŠŸèƒ½å¼€å§‹ä½¿ç”¨ Composeï¼Œé€æ­¥æ›¿æ¢æ—§ä»£ç ï¼Œè€Œéå¤§è§„æ¨¡é‡å†™ã€‚</p>
        </div>

        <h2>äºŒã€åœ¨ Compose ä¸­ä½¿ç”¨ Viewï¼ˆAndroidViewï¼‰</h2>
        <p><code>AndroidView</code> æ˜¯åœ¨ Compose ä¸­åµŒå…¥ä¼ ç»Ÿ View çš„æ¡¥æ¢ã€‚</p>

        <h3>åŸºæœ¬ç”¨æ³•</h3>

<pre><code><span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">LegacyButtonInCompose</span>() {
    <span class="code-func">AndroidView</span>(
        factory = { context ->
            <span class="code-comment">// åˆ›å»º Viewï¼Œåªæ‰§è¡Œä¸€æ¬¡</span>
            <span class="code-func">Button</span>(context).<span class="code-func">apply</span> {
                text = <span class="code-string">"æˆ‘æ˜¯ä¼ ç»Ÿ Button"</span>
            }
        },
        modifier = <span class="code-type">Modifier</span>
            .<span class="code-func">fillMaxWidth</span>()
            .<span class="code-func">padding</span>(<span class="code-number">16</span>.dp)
    )
}</code></pre>

        <h3>æ›´æ–° View çŠ¶æ€</h3>
        <p>ä½¿ç”¨ <code>update</code> å‚æ•°å“åº” Compose çŠ¶æ€å˜åŒ–ï¼š</p>

<pre><code><span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">CounterWithLegacyView</span>() {
    <span class="code-keyword">var</span> count <span class="code-keyword">by</span> <span class="code-func">remember</span> { <span class="code-func">mutableStateOf</span>(<span class="code-number">0</span>) }

    <span class="code-func">Column</span> {
        <span class="code-func">AndroidView</span>(
            factory = { context ->
                <span class="code-func">TextView</span>(context).<span class="code-func">apply</span> {
                    textSize = <span class="code-number">24f</span>
                }
            },
            update = { textView ->
                <span class="code-comment">// count å˜åŒ–æ—¶æ›´æ–° View</span>
                textView.text = <span class="code-string">"Count: $count"</span>
            }
        )

        <span class="code-func">Button</span>(onClick = { count++ }) {
            <span class="code-func">Text</span>(<span class="code-string">"å¢åŠ "</span>)
        }
    }
}</code></pre>

        <h3>å®æˆ˜ï¼šåµŒå…¥ WebView</h3>

<pre><code><span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">WebViewContainer</span>(url: <span class="code-type">String</span>) {
    <span class="code-keyword">var</span> webView: <span class="code-type">WebView</span>? = <span class="code-keyword">null</span>

    <span class="code-func">AndroidView</span>(
        factory = { context ->
            <span class="code-func">WebView</span>(context).<span class="code-func">apply</span> {
                webViewClient = <span class="code-func">WebViewClient</span>()
                settings.javaScriptEnabled = <span class="code-keyword">true</span>
                webView = <span class="code-keyword">this</span>
            }
        },
        update = { view ->
            view.<span class="code-func">loadUrl</span>(url)
        },
        modifier = <span class="code-type">Modifier</span>.<span class="code-func">fillMaxSize</span>()
    )

    <span class="code-comment">// å¤„ç†è¿”å›é”®</span>
    <span class="code-func">BackHandler</span> {
        webView?.<span class="code-func">let</span> {
            <span class="code-keyword">if</span> (it.<span class="code-func">canGoBack</span>()) {
                it.<span class="code-func">goBack</span>()
            }
        }
    }
}</code></pre>

        <h3>å®æˆ˜ï¼šåµŒå…¥ MapView</h3>

<pre><code><span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">GoogleMapView</span>(
    modifier: <span class="code-type">Modifier</span> = <span class="code-type">Modifier</span>,
    onMapReady: (<span class="code-type">GoogleMap</span>) -> <span class="code-type">Unit</span>
) {
    <span class="code-keyword">val</span> context = <span class="code-func">LocalContext</span>.current
    <span class="code-keyword">val</span> mapView = <span class="code-func">remember</span> { <span class="code-func">MapView</span>(context) }
    <span class="code-keyword">val</span> lifecycle = <span class="code-func">LocalLifecycleOwner</span>.current.lifecycle

    <span class="code-comment">// ç®¡ç† MapView ç”Ÿå‘½å‘¨æœŸ</span>
    <span class="code-func">DisposableEffect</span>(lifecycle) {
        <span class="code-keyword">val</span> observer = <span class="code-func">LifecycleEventObserver</span> { _, event ->
            <span class="code-keyword">when</span> (event) {
                <span class="code-type">Lifecycle.Event</span>.ON_CREATE -> mapView.<span class="code-func">onCreate</span>(<span class="code-func">Bundle</span>())
                <span class="code-type">Lifecycle.Event</span>.ON_START -> mapView.<span class="code-func">onStart</span>()
                <span class="code-type">Lifecycle.Event</span>.ON_RESUME -> mapView.<span class="code-func">onResume</span>()
                <span class="code-type">Lifecycle.Event</span>.ON_PAUSE -> mapView.<span class="code-func">onPause</span>()
                <span class="code-type">Lifecycle.Event</span>.ON_STOP -> mapView.<span class="code-func">onStop</span>()
                <span class="code-type">Lifecycle.Event</span>.ON_DESTROY -> mapView.<span class="code-func">onDestroy</span>()
                <span class="code-keyword">else</span> -> {}
            }
        }
        lifecycle.<span class="code-func">addObserver</span>(observer)
        <span class="code-func">onDispose</span> {
            lifecycle.<span class="code-func">removeObserver</span>(observer)
        }
    }

    <span class="code-func">AndroidView</span>(
        factory = {
            mapView.<span class="code-func">apply</span> {
                <span class="code-func">getMapAsync</span> { googleMap ->
                    <span class="code-func">onMapReady</span>(googleMap)
                }
            }
        },
        modifier = modifier
    )
}</code></pre>

        <h2>ä¸‰ã€åœ¨ View ä¸­ä½¿ç”¨ Composeï¼ˆComposeViewï¼‰</h2>
        <p><code>ComposeView</code> è®©ä½ å¯ä»¥åœ¨ä¼ ç»Ÿ View å¸ƒå±€ä¸­åµŒå…¥ Compose UIã€‚</p>

        <h3>åœ¨ Activity ä¸­ä½¿ç”¨</h3>

<pre><code><span class="code-keyword">class</span> <span class="code-type">MainActivity</span> : <span class="code-type">AppCompatActivity</span>() {
    <span class="code-keyword">override fun</span> <span class="code-func">onCreate</span>(savedInstanceState: <span class="code-type">Bundle</span>?) {
        <span class="code-keyword">super</span>.<span class="code-func">onCreate</span>(savedInstanceState)

        <span class="code-comment">// æ–¹å¼ä¸€ï¼šsetContent æ‰©å±•å‡½æ•°ï¼ˆæ¨èï¼‰</span>
        <span class="code-func">setContent</span> {
            <span class="code-func">MyAppTheme</span> {
                <span class="code-func">MainScreen</span>()
            }
        }

        <span class="code-comment">// æ–¹å¼äºŒï¼šä½¿ç”¨ ComposeView</span>
        <span class="code-keyword">val</span> composeView = <span class="code-func">ComposeView</span>(<span class="code-keyword">this</span>).<span class="code-func">apply</span> {
            <span class="code-func">setContent</span> {
                <span class="code-func">MyAppTheme</span> {
                    <span class="code-func">MainScreen</span>()
                }
            }
        }
        <span class="code-func">setContentView</span>(composeView)
    }
}</code></pre>

        <h3>åœ¨ Fragment ä¸­ä½¿ç”¨</h3>

<pre><code><span class="code-keyword">class</span> <span class="code-type">ProfileFragment</span> : <span class="code-type">Fragment</span>() {

    <span class="code-keyword">override fun</span> <span class="code-func">onCreateView</span>(
        inflater: <span class="code-type">LayoutInflater</span>,
        container: <span class="code-type">ViewGroup</span>?,
        savedInstanceState: <span class="code-type">Bundle</span>?
    ): <span class="code-type">View</span> {
        <span class="code-keyword">return</span> <span class="code-func">ComposeView</span>(<span class="code-func">requireContext</span>()).<span class="code-func">apply</span> {
            <span class="code-comment">// è®¾ç½® ViewCompositionStrategy</span>
            <span class="code-func">setViewCompositionStrategy</span>(
                <span class="code-type">ViewCompositionStrategy</span>.DisposeOnViewTreeLifecycleDestroyed
            )
            <span class="code-func">setContent</span> {
                <span class="code-func">MyAppTheme</span> {
                    <span class="code-func">ProfileScreen</span>()
                }
            }
        }
    }
}</code></pre>

        <h3>åœ¨ XML å¸ƒå±€ä¸­æ··ç”¨</h3>

<pre><code><span class="code-comment">&lt;!-- fragment_hybrid.xml --&gt;</span>
&lt;<span class="code-type">LinearLayout</span>
    android:layout_width=<span class="code-string">"match_parent"</span>
    android:layout_height=<span class="code-string">"match_parent"</span>
    android:orientation=<span class="code-string">"vertical"</span>&gt;

    &lt;<span class="code-type">TextView</span>
        android:id=<span class="code-string">"@+id/title"</span>
        android:layout_width=<span class="code-string">"wrap_content"</span>
        android:layout_height=<span class="code-string">"wrap_content"</span>
        android:text=<span class="code-string">"ä¼ ç»Ÿ TextView"</span> /&gt;

    &lt;<span class="code-type">androidx.compose.ui.platform.ComposeView</span>
        android:id=<span class="code-string">"@+id/compose_view"</span>
        android:layout_width=<span class="code-string">"match_parent"</span>
        android:layout_height=<span class="code-string">"wrap_content"</span> /&gt;

    &lt;<span class="code-type">Button</span>
        android:id=<span class="code-string">"@+id/legacy_button"</span>
        android:layout_width=<span class="code-string">"wrap_content"</span>
        android:layout_height=<span class="code-string">"wrap_content"</span>
        android:text=<span class="code-string">"ä¼ ç»Ÿ Button"</span> /&gt;

&lt;/<span class="code-type">LinearLayout</span>&gt;</code></pre>

<pre><code><span class="code-keyword">class</span> <span class="code-type">HybridFragment</span> : <span class="code-type">Fragment</span>(R.layout.fragment_hybrid) {

    <span class="code-keyword">override fun</span> <span class="code-func">onViewCreated</span>(view: <span class="code-type">View</span>, savedInstanceState: <span class="code-type">Bundle</span>?) {
        <span class="code-keyword">super</span>.<span class="code-func">onViewCreated</span>(view, savedInstanceState)

        view.<span class="code-func">findViewById</span>&lt;<span class="code-type">ComposeView</span>&gt;(R.id.compose_view).<span class="code-func">apply</span> {
            <span class="code-func">setViewCompositionStrategy</span>(
                <span class="code-type">ViewCompositionStrategy</span>.DisposeOnViewTreeLifecycleDestroyed
            )
            <span class="code-func">setContent</span> {
                <span class="code-func">ComposeContent</span>()
            }
        }
    }
}</code></pre>

        <h2>å››ã€ViewCompositionStrategyï¼šç”Ÿå‘½å‘¨æœŸç­–ç•¥</h2>
        <p><code>ViewCompositionStrategy</code> æ§åˆ¶ Composition ä½•æ—¶è¢«é‡Šæ”¾ï¼Œé€‰æ‹©æ­£ç¡®çš„ç­–ç•¥éå¸¸é‡è¦ï¼š</p>

        <table class="comparison-table">
            <thead>
                <tr>
                    <th>ç­–ç•¥</th>
                    <th>é‡Šæ”¾æ—¶æœº</th>
                    <th>é€‚ç”¨åœºæ™¯</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>DisposeOnDetachedFromWindow</code></td>
                    <td>View ä»çª—å£åˆ†ç¦»æ—¶</td>
                    <td>é»˜è®¤ç­–ç•¥ï¼Œé€‚ç”¨äº Activity</td>
                </tr>
                <tr>
                    <td><code>DisposeOnDetachedFromWindowOrReleasedFromPool</code></td>
                    <td>åˆ†ç¦»æˆ–ä» RecyclerView æ± é‡Šæ”¾æ—¶</td>
                    <td>RecyclerView ä¸­ä½¿ç”¨</td>
                </tr>
                <tr>
                    <td><code>DisposeOnViewTreeLifecycleDestroyed</code></td>
                    <td>ViewTreeLifecycleOwner é”€æ¯æ—¶</td>
                    <td><strong>Fragment æ¨è</strong></td>
                </tr>
                <tr>
                    <td><code>DisposeOnLifecycleDestroyed</code></td>
                    <td>æŒ‡å®š Lifecycle é”€æ¯æ—¶</td>
                    <td>è‡ªå®šä¹‰ç”Ÿå‘½å‘¨æœŸ</td>
                </tr>
            </tbody>
        </table>

        <h3>Fragment ä¸­çš„é™·é˜±</h3>

<pre><code><span class="code-comment">// âŒ é”™è¯¯ï¼šé»˜è®¤ç­–ç•¥åœ¨ Fragment ä¸­å¯èƒ½å¯¼è‡´é—®é¢˜</span>
<span class="code-keyword">class</span> <span class="code-type">BadFragment</span> : <span class="code-type">Fragment</span>() {
    <span class="code-keyword">override fun</span> <span class="code-func">onCreateView</span>(...): <span class="code-type">View</span> {
        <span class="code-keyword">return</span> <span class="code-func">ComposeView</span>(<span class="code-func">requireContext</span>()).<span class="code-func">apply</span> {
            <span class="code-comment">// é»˜è®¤ä½¿ç”¨ DisposeOnDetachedFromWindow</span>
            <span class="code-comment">// Fragment view é‡å»ºæ—¶å¯èƒ½å‡ºé—®é¢˜</span>
            <span class="code-func">setContent</span> { ... }
        }
    }
}

<span class="code-comment">// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ­£ç¡®çš„ç­–ç•¥</span>
<span class="code-keyword">class</span> <span class="code-type">GoodFragment</span> : <span class="code-type">Fragment</span>() {
    <span class="code-keyword">override fun</span> <span class="code-func">onCreateView</span>(...): <span class="code-type">View</span> {
        <span class="code-keyword">return</span> <span class="code-func">ComposeView</span>(<span class="code-func">requireContext</span>()).<span class="code-func">apply</span> {
            <span class="code-func">setViewCompositionStrategy</span>(
                <span class="code-type">ViewCompositionStrategy</span>.DisposeOnViewTreeLifecycleDestroyed
            )
            <span class="code-func">setContent</span> { ... }
        }
    }
}</code></pre>

        <h2>äº”ã€çŠ¶æ€åŒæ­¥ä¸æ•°æ®ä¼ é€’</h2>

        <h3>Compose çŠ¶æ€ â†’ View</h3>

<pre><code><span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">ComposeToView</span>(items: <span class="code-type">List</span>&lt;<span class="code-type">String</span>&gt;) {
    <span class="code-func">AndroidView</span>(
        factory = { context ->
            <span class="code-func">RecyclerView</span>(context).<span class="code-func">apply</span> {
                adapter = <span class="code-func">SimpleAdapter</span>()
                layoutManager = <span class="code-func">LinearLayoutManager</span>(context)
            }
        },
        update = { recyclerView ->
            <span class="code-comment">// Compose çŠ¶æ€å˜åŒ–æ—¶æ›´æ–° RecyclerView</span>
            (recyclerView.adapter <span class="code-keyword">as</span> <span class="code-type">SimpleAdapter</span>).<span class="code-func">submitList</span>(items)
        }
    )
}</code></pre>

        <h3>View äº‹ä»¶ â†’ Compose</h3>

<pre><code><span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">ViewToCompose</span>() {
    <span class="code-keyword">var</span> selectedDate <span class="code-keyword">by</span> <span class="code-func">remember</span> { <span class="code-func">mutableStateOf</span>&lt;<span class="code-type">Long</span>?&gt;(<span class="code-keyword">null</span>) }

    <span class="code-func">Column</span> {
        <span class="code-func">Text</span>(<span class="code-string">"é€‰ä¸­æ—¥æœŸ: ${selectedDate?.let { formatDate(it) } ?: "æœªé€‰æ‹©"}"</span>)

        <span class="code-func">AndroidView</span>(
            factory = { context ->
                <span class="code-func">CalendarView</span>(context).<span class="code-func">apply</span> {
                    <span class="code-func">setOnDateChangeListener</span> { _, year, month, day ->
                        <span class="code-comment">// View äº‹ä»¶æ›´æ–° Compose çŠ¶æ€</span>
                        selectedDate = <span class="code-func">Calendar</span>.<span class="code-func">getInstance</span>().<span class="code-func">apply</span> {
                            <span class="code-func">set</span>(year, month, day)
                        }.timeInMillis
                    }
                }
            }
        )
    }
}</code></pre>

        <h3>åŒå‘æ•°æ®ç»‘å®šæ¨¡å¼</h3>

<pre><code><span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">TwoWayBinding</span>() {
    <span class="code-keyword">var</span> text <span class="code-keyword">by</span> <span class="code-func">remember</span> { <span class="code-func">mutableStateOf</span>(<span class="code-string">""</span>) }

    <span class="code-func">Column</span> {
        <span class="code-comment">// Compose TextField</span>
        <span class="code-func">OutlinedTextField</span>(
            value = text,
            onValueChange = { text = it },
            label = { <span class="code-func">Text</span>(<span class="code-string">"Compose è¾“å…¥"</span>) }
        )

        <span class="code-func">Spacer</span>(modifier = <span class="code-type">Modifier</span>.<span class="code-func">height</span>(<span class="code-number">16</span>.dp))

        <span class="code-comment">// Legacy EditText</span>
        <span class="code-func">AndroidView</span>(
            factory = { context ->
                <span class="code-func">EditText</span>(context).<span class="code-func">apply</span> {
                    hint = <span class="code-string">"View è¾“å…¥"</span>
                    <span class="code-func">addTextChangedListener</span>(<span class="code-keyword">object</span> : <span class="code-type">TextWatcher</span> {
                        <span class="code-keyword">override fun</span> <span class="code-func">afterTextChanged</span>(s: <span class="code-type">Editable</span>?) {
                            <span class="code-keyword">val</span> newText = s?.<span class="code-func">toString</span>() ?: <span class="code-string">""</span>
                            <span class="code-keyword">if</span> (newText != text) {
                                text = newText
                            }
                        }
                        <span class="code-keyword">override fun</span> <span class="code-func">beforeTextChanged</span>(...) {}
                        <span class="code-keyword">override fun</span> <span class="code-func">onTextChanged</span>(...) {}
                    })
                }
            },
            update = { editText ->
                <span class="code-keyword">if</span> (editText.text.<span class="code-func">toString</span>() != text) {
                    editText.<span class="code-func">setText</span>(text)
                }
            }
        )
    }
}</code></pre>

        <h2>å…­ã€Fragment ä¸ Navigation é›†æˆ</h2>

        <h3>åœ¨ Navigation Fragment ä¸­ä½¿ç”¨ Compose</h3>

<pre><code><span class="code-comment">// ä½¿ç”¨ navigation-compose ä¸ fragment æ··åˆ</span>
<span class="code-keyword">class</span> <span class="code-type">NavHostFragment</span> : <span class="code-type">Fragment</span>() {

    <span class="code-keyword">override fun</span> <span class="code-func">onCreateView</span>(
        inflater: <span class="code-type">LayoutInflater</span>,
        container: <span class="code-type">ViewGroup</span>?,
        savedInstanceState: <span class="code-type">Bundle</span>?
    ): <span class="code-type">View</span> {
        <span class="code-keyword">return</span> <span class="code-func">ComposeView</span>(<span class="code-func">requireContext</span>()).<span class="code-func">apply</span> {
            <span class="code-func">setViewCompositionStrategy</span>(
                <span class="code-type">ViewCompositionStrategy</span>.DisposeOnViewTreeLifecycleDestroyed
            )
            <span class="code-func">setContent</span> {
                <span class="code-keyword">val</span> navController = <span class="code-func">rememberNavController</span>()
                
                <span class="code-func">NavHost</span>(navController, startDestination = <span class="code-string">"home"</span>) {
                    <span class="code-func">composable</span>(<span class="code-string">"home"</span>) { <span class="code-func">HomeScreen</span>(navController) }
                    <span class="code-func">composable</span>(<span class="code-string">"detail/{id}"</span>) { <span class="code-func">DetailScreen</span>(it) }
                }
            }
        }
    }
}</code></pre>

        <h2>ä¸ƒã€è¿ç§»ç­–ç•¥</h2>

        <h3>ç­–ç•¥ä¸€ï¼šè‡ªåº•å‘ä¸Šï¼ˆæ¨èï¼‰</h3>
        <p>ä»æœ€å°çš„ UI ç»„ä»¶å¼€å§‹ï¼Œé€æ­¥å‘ä¸Šè¿ç§»ï¼š</p>

<pre><code><span class="code-comment">Phase 1: åŸºç¡€ç»„ä»¶</span>
Button, TextField, Card â†’ Compose

<span class="code-comment">Phase 2: å¤åˆç»„ä»¶</span>
ListItem, FormField â†’ Compose

<span class="code-comment">Phase 3: å±å¹•ç»„ä»¶</span>
æ•´ä¸ª Screen â†’ Compose

<span class="code-comment">Phase 4: å¯¼èˆª</span>
Navigation â†’ Compose Navigation</code></pre>

<pre><code><span class="code-comment">// Phase 1: æ›¿æ¢å•ä¸ªç»„ä»¶</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">ComposeButton</span>(
    text: <span class="code-type">String</span>,
    onClick: () -> <span class="code-type">Unit</span>
) {
    <span class="code-func">Button</span>(onClick = onClick) {
        <span class="code-func">Text</span>(text)
    }
}

<span class="code-comment">// åœ¨ View ä¸­ä½¿ç”¨</span>
<span class="code-keyword">class</span> <span class="code-type">LegacyActivity</span> : <span class="code-type">AppCompatActivity</span>() {
    <span class="code-keyword">override fun</span> <span class="code-func">onCreate</span>(savedInstanceState: <span class="code-type">Bundle</span>?) {
        <span class="code-keyword">super</span>.<span class="code-func">onCreate</span>(savedInstanceState)
        <span class="code-func">setContentView</span>(R.layout.activity_legacy)

        <span class="code-func">findViewById</span>&lt;<span class="code-type">ComposeView</span>&gt;(R.id.compose_button).<span class="code-func">setContent</span> {
            <span class="code-func">ComposeButton</span>(<span class="code-string">"ç‚¹å‡»æˆ‘"</span>) {
                <span class="code-comment">// å¤„ç†ç‚¹å‡»</span>
            }
        }
    }
}</code></pre>

        <h3>ç­–ç•¥äºŒï¼šè‡ªé¡¶å‘ä¸‹</h3>
        <p>é€‚åˆæ–°åŠŸèƒ½æˆ–ç‹¬ç«‹æ¨¡å—ï¼š</p>

<pre><code><span class="code-comment">// æ–°åŠŸèƒ½ç›´æ¥ç”¨ Compose å®ç°æ•´ä¸ªå±å¹•</span>
<span class="code-keyword">class</span> <span class="code-type">NewFeatureActivity</span> : <span class="code-type">ComponentActivity</span>() {
    <span class="code-keyword">override fun</span> <span class="code-func">onCreate</span>(savedInstanceState: <span class="code-type">Bundle</span>?) {
        <span class="code-keyword">super</span>.<span class="code-func">onCreate</span>(savedInstanceState)
        <span class="code-func">setContent</span> {
            <span class="code-func">NewFeatureScreen</span>()
        }
    }
}

<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">NewFeatureScreen</span>() {
    <span class="code-comment">// å®Œæ•´çš„ Compose å±å¹•</span>
    <span class="code-comment">// éœ€è¦æ—¶ä½¿ç”¨ AndroidView åµŒå…¥å¿…è¦çš„ View</span>
    <span class="code-func">Column</span> {
        <span class="code-func">ComposeHeader</span>()
        
        <span class="code-comment">// åµŒå…¥å¿…è¦çš„ View ç»„ä»¶</span>
        <span class="code-func">AndroidView</span>(
            factory = { <span class="code-func">LegacyChartView</span>(it) }
        )
        
        <span class="code-func">ComposeContent</span>()
    }
}</code></pre>

        <h3>è¿ç§»æ¸…å•</h3>
        <ul>
            <li>âœ… æ–°åŠŸèƒ½ä¼˜å…ˆä½¿ç”¨ Compose</li>
            <li>âœ… ä»å¶å­èŠ‚ç‚¹ç»„ä»¶å¼€å§‹è¿ç§»</li>
            <li>âœ… å»ºç«‹ Compose è®¾è®¡ç³»ç»Ÿï¼ˆThemeã€Componentsï¼‰</li>
            <li>âœ… ä¿æŒ View å’Œ Compose ç‰ˆæœ¬ç»„ä»¶çš„ API ä¸€è‡´</li>
            <li>âœ… ç¼–å†™äº’æ“ä½œæµ‹è¯•</li>
            <li>âœ… ç›‘æ§æ€§èƒ½æŒ‡æ ‡</li>
        </ul>

        <h2>å…«ã€æ€§èƒ½æ³¨æ„äº‹é¡¹</h2>

        <h3>é¿å…é¢‘ç¹åˆ›å»º View</h3>

<pre><code><span class="code-comment">// âŒ é”™è¯¯ï¼šfactory ä¸­åˆ›å»ºå¤æ‚ View ä½†æœªç¼“å­˜</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">BadPerformance</span>(items: <span class="code-type">List</span>&lt;<span class="code-type">Item</span>&gt;) {
    <span class="code-func">LazyColumn</span> {
        <span class="code-func">items</span>(items) { item ->
            <span class="code-func">AndroidView</span>(
                factory = { context ->
                    <span class="code-comment">// æ¯ä¸ª item éƒ½åˆ›å»ºæ–°çš„å¤æ‚ Viewï¼</span>
                    <span class="code-func">ComplexLegacyView</span>(context)
                }
            )
        }
    }
}

<span class="code-comment">// âœ… æ­£ç¡®ï¼šä½¿ç”¨ key å’Œåˆç†çš„å¤ç”¨ç­–ç•¥</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">GoodPerformance</span>(items: <span class="code-type">List</span>&lt;<span class="code-type">Item</span>&gt;) {
    <span class="code-func">LazyColumn</span> {
        <span class="code-func">items</span>(items, key = { it.id }) { item ->
            <span class="code-comment">// ä½¿ç”¨ Compose é‡å†™çš„ç»„ä»¶</span>
            <span class="code-func">ComposeItemView</span>(item)
        }
    }
}</code></pre>

        <h3>AndroidView çš„ onReset å’Œ onRelease</h3>

<pre><code><span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">OptimizedAndroidView</span>() {
    <span class="code-func">AndroidView</span>(
        factory = { context ->
            <span class="code-func">ExpensiveView</span>(context)
        },
        onReset = { view ->
            <span class="code-comment">// View å³å°†è¢«å¤ç”¨æ—¶è°ƒç”¨</span>
            view.<span class="code-func">reset</span>()
        },
        onRelease = { view ->
            <span class="code-comment">// View è¢«é‡Šæ”¾æ—¶è°ƒç”¨ï¼Œæ¸…ç†èµ„æº</span>
            view.<span class="code-func">cleanup</span>()
        }
    )
}</code></pre>

        <h3>å‡å°‘æ¡¥æ¥å¼€é”€</h3>

<pre><code><span class="code-comment">// âŒ é¢‘ç¹è·¨è¶Š View-Compose è¾¹ç•Œ</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">TooManyBridges</span>() {
    <span class="code-func">Column</span> {
        <span class="code-func">AndroidView</span> { <span class="code-func">TextView</span>(it) }  <span class="code-comment">// æ¡¥æ¥</span>
        <span class="code-func">Text</span>(<span class="code-string">"Compose"</span>)
        <span class="code-func">AndroidView</span> { <span class="code-func">ImageView</span>(it) } <span class="code-comment">// æ¡¥æ¥</span>
        <span class="code-func">Text</span>(<span class="code-string">"Compose"</span>)
        <span class="code-func">AndroidView</span> { <span class="code-func">Button</span>(it) }    <span class="code-comment">// æ¡¥æ¥</span>
    }
}

<span class="code-comment">// âœ… å‡å°‘æ¡¥æ¥ï¼Œæ‰¹é‡å¤„ç†æˆ–ç”¨ Compose é‡å†™</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">FewerBridges</span>() {
    <span class="code-func">Column</span> {
        <span class="code-comment">// ç›´æ¥ç”¨ Compose é‡å†™</span>
        <span class="code-func">Text</span>(<span class="code-string">"Compose Text"</span>)
        <span class="code-func">Image</span>(...)
        <span class="code-func">Button</span>(onClick = {}) { <span class="code-func">Text</span>(<span class="code-string">"Compose Button"</span>) }
    }
}</code></pre>

        <h2>ä¹ã€å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h2>

        <h3>1. Theme ä¸ä¸€è‡´</h3>

<pre><code><span class="code-comment">// ç¡®ä¿ Compose ä½¿ç”¨ä¸ View ä¸€è‡´çš„ä¸»é¢˜</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">ThemedContent</span>() {
    <span class="code-comment">// ä» View ç³»ç»Ÿè¯»å–é¢œè‰²</span>
    <span class="code-keyword">val</span> context = <span class="code-func">LocalContext</span>.current
    <span class="code-keyword">val</span> primaryColor = <span class="code-func">remember</span> {
        context.<span class="code-func">getColor</span>(R.color.primary)
    }

    <span class="code-func">MaterialTheme</span>(
        colorScheme = <span class="code-type">MaterialTheme</span>.colorScheme.<span class="code-func">copy</span>(
            primary = <span class="code-func">Color</span>(primaryColor)
        )
    ) {
        <span class="code-comment">// å†…å®¹</span>
    }
}</code></pre>

        <h3>2. è½¯é”®ç›˜å¤„ç†</h3>

<pre><code><span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">KeyboardAwareAndroidView</span>() {
    <span class="code-keyword">val</span> imeInsets = <span class="code-type">WindowInsets</span>.ime

    <span class="code-func">AndroidView</span>(
        factory = { <span class="code-func">EditText</span>(it) },
        modifier = <span class="code-type">Modifier</span>
            .<span class="code-func">fillMaxWidth</span>()
            .<span class="code-func">padding</span>(bottom = <span class="code-func">with</span>(<span class="code-func">LocalDensity</span>.current) {
                imeInsets.<span class="code-func">getBottom</span>(<span class="code-keyword">this</span>).<span class="code-func">toDp</span>()
            })
    )
}</code></pre>

        <h3>3. ç„¦ç‚¹ç®¡ç†</h3>

<pre><code><span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">FocusInterop</span>() {
    <span class="code-keyword">val</span> focusRequester = <span class="code-func">remember</span> { <span class="code-func">FocusRequester</span>() }

    <span class="code-func">Column</span> {
        <span class="code-func">TextField</span>(
            value = <span class="code-string">""</span>,
            onValueChange = {},
            modifier = <span class="code-type">Modifier</span>.<span class="code-func">focusRequester</span>(focusRequester)
        )

        <span class="code-func">AndroidView</span>(
            factory = { context ->
                <span class="code-func">EditText</span>(context).<span class="code-func">apply</span> {
                    <span class="code-func">setOnFocusChangeListener</span> { _, hasFocus ->
                        <span class="code-keyword">if</span> (!hasFocus) {
                            <span class="code-comment">// View å¤±å»ç„¦ç‚¹æ—¶ï¼Œè½¬ç§»åˆ° Compose</span>
                            focusRequester.<span class="code-func">requestFocus</span>()
                        }
                    }
                }
            }
        )
    }
}</code></pre>

        <h2>æ€»ç»“</h2>
        <p>Compose ä¸ View äº’æ“ä½œçš„æ ¸å¿ƒè¦ç‚¹ï¼š</p>
        <ul>
            <li><strong>AndroidView</strong>ï¼šåœ¨ Compose ä¸­åµŒå…¥ Viewï¼Œç”¨äºå¤ç”¨ç°æœ‰ç»„ä»¶</li>
            <li><strong>ComposeView</strong>ï¼šåœ¨ View ä¸­åµŒå…¥ Composeï¼Œç”¨äºæ¸è¿›å¼è¿ç§»</li>
            <li><strong>ViewCompositionStrategy</strong>ï¼šFragment ä¸­åŠ¡å¿…è®¾ç½®æ­£ç¡®çš„ç­–ç•¥</li>
            <li><strong>çŠ¶æ€åŒæ­¥</strong>ï¼šé€šè¿‡ <code>update</code> å‚æ•°å’Œå›è°ƒå®ç°åŒå‘æ•°æ®æµ</li>
            <li><strong>è¿ç§»ç­–ç•¥</strong>ï¼šæ¨èè‡ªåº•å‘ä¸Šï¼Œä»å°ç»„ä»¶å¼€å§‹</li>
            <li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šå‡å°‘æ¡¥æ¥å¼€é”€ï¼Œé¿å…é¢‘ç¹åˆ›å»º View</li>
        </ul>
        <p>æŒæ¡è¿™äº›æŠ€æœ¯ï¼Œä½ å°±å¯ä»¥åœ¨ä»»ä½•é¡¹ç›®ä¸­å¹³æ»‘åœ°å¼•å…¥ Composeï¼Œæ— éœ€æ‹…å¿ƒä¸ç°æœ‰ä»£ç çš„å…¼å®¹æ€§é—®é¢˜ã€‚</p>
    </article>

    <footer class="footer">
        <p>&copy; 2024 Fidroid. <a href="../index.html">è¿”å›é¦–é¡µ</a></p>
    </footer>
</body>
</html>

