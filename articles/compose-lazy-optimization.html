<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LazyColumn/LazyGrid æ·±åº¦ä¼˜åŒ–ï¼šæ‰“é€ ä¸æ»‘åˆ—è¡¨ä½“éªŒ - Fidroid</title>
    <meta name="description" content="æ·±å…¥ä¼˜åŒ– Compose åˆ—è¡¨æ€§èƒ½ï¼ŒæŒæ¡ key ç­–ç•¥ã€contentTypeã€Paging3 é›†æˆã€æ»šåŠ¨æ€§èƒ½è°ƒä¼˜ç­‰æŠ€å·§ã€‚">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.8;
            color: #e5e7eb;
            background: #020617;
        }
        .navbar {
            background: rgba(15,23,42,0.98);
            backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }
        .nav-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #38bdf8;
            text-decoration: none;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .back-link { color: #9ca3af; text-decoration: none; font-size: 0.9rem; }
        .back-link:hover { color: #38bdf8; }

        .article-header {
            padding: 120px 20px 60px;
            background: radial-gradient(circle at top left, #10b981 0, transparent 50%),
                        radial-gradient(circle at bottom right, #3b82f6 0, transparent 55%),
                        #020617;
            text-align: center;
        }
        .article-header h1 {
            max-width: 800px;
            margin: 0 auto 1rem;
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            color: #fff;
        }
        .article-meta { color: #9ca3af; font-size: 0.9rem; margin-bottom: 1.5rem; }
        .article-tags { display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem; }
        .article-tag {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            background: rgba(15,23,42,0.85);
            border: 1px solid rgba(16,185,129,0.4);
            color: #6ee7b7;
        }

        .article-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 60px 20px 80px;
        }
        .article-content h2 {
            font-size: 1.6rem;
            margin: 2.5rem 0 1rem;
            color: #f9fafb;
            border-left: 4px solid #10b981;
            padding-left: 1rem;
        }
        .article-content h3 { font-size: 1.25rem; margin: 2rem 0 0.75rem; color: #e5e7eb; }
        .article-content p { margin-bottom: 1.25rem; color: #d1d5db; }
        .article-content ul, .article-content ol { margin: 1rem 0 1.5rem 1.5rem; color: #d1d5db; }
        .article-content li { margin-bottom: 0.5rem; }
        .article-content strong { color: #f9fafb; }
        .article-content a { color: #38bdf8; text-decoration: underline; }

        pre {
            background: #0f172a;
            border: 1px solid rgba(16,185,129,0.3);
            border-radius: 12px;
            padding: 1.25rem;
            overflow-x: auto;
            margin: 1.5rem 0;
            font-size: 0.85rem;
            line-height: 1.6;
        }
        code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; color: #e5e7eb; }
        .code-keyword { color: #c084fc; }
        .code-func { color: #38bdf8; }
        .code-type { color: #4ade80; }
        .code-string { color: #fb7185; }
        .code-comment { color: #6b7280; font-style: italic; }
        .code-number { color: #fbbf24; }

        .callout {
            background: rgba(16,185,129,0.1);
            border: 1px solid rgba(16,185,129,0.3);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            margin: 1.5rem 0;
        }
        .callout-title { font-weight: 600; color: #6ee7b7; margin-bottom: 0.5rem; }
        .callout p { margin-bottom: 0; color: #d1d5db; }

        .footer {
            background: #020617;
            border-top: 1px solid #111827;
            padding: 2rem;
            text-align: center;
            color: #6b7280;
        }
        .footer a { color: #38bdf8; text-decoration: none; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="logo">Fidroid</a>
            <a href="../index.html#blog" class="back-link">â† è¿”å›åšå®¢åˆ—è¡¨</a>
        </div>
    </nav>

    <header class="article-header">
        <h1>LazyColumn/LazyGrid æ·±åº¦ä¼˜åŒ–ï¼šæ‰“é€ ä¸æ»‘åˆ—è¡¨ä½“éªŒ</h1>
        <p class="article-meta">2024-04-18 Â· 22 min Â· åˆ—è¡¨æ€§èƒ½</p>
        <div class="article-tags">
            <span class="article-tag">LazyColumn</span>
            <span class="article-tag">LazyGrid</span>
            <span class="article-tag">Paging3</span>
            <span class="article-tag">Performance</span>
        </div>
    </header>

    <article class="article-content">
        <p>åˆ—è¡¨æ˜¯ç§»åŠ¨åº”ç”¨ä¸­æœ€å¸¸è§çš„ UI æ¨¡å¼ï¼Œä¹Ÿæ˜¯æ€§èƒ½é—®é¢˜çš„é«˜å‘åŒºã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨å¦‚ä½•ä¼˜åŒ– Compose ä¸­çš„ LazyColumn å’Œ LazyGridï¼Œæ‰“é€ æµç•…çš„æ»šåŠ¨ä½“éªŒã€‚</p>

        <h2>ä¸€ã€LazyColumn åŸºç¡€å›é¡¾</h2>

<pre><code><span class="code-func">LazyColumn</span> {
    <span class="code-func">items</span>(
        items = users,
        key = { user -> user.id }  <span class="code-comment">// å…³é”®ï¼šæä¾›ç¨³å®šçš„ key</span>
    ) { user ->
        <span class="code-func">UserRow</span>(user)
    }
}</code></pre>

        <h2>äºŒã€key çš„é‡è¦æ€§</h2>
        <p><code>key</code> å¸®åŠ© Compose è¯†åˆ«åˆ—è¡¨é¡¹çš„èº«ä»½ï¼Œæ˜¯ä¼˜åŒ–çš„ç¬¬ä¸€æ­¥ï¼š</p>

<pre><code><span class="code-comment">// âŒ æ²¡æœ‰ keyï¼šåˆ é™¤/æ’å…¥æ—¶å¯èƒ½å‡ºç°é”™è¯¯åŠ¨ç”»å’ŒçŠ¶æ€ä¸¢å¤±</span>
<span class="code-func">items</span>(users) { user -> <span class="code-func">UserRow</span>(user) }

<span class="code-comment">// âœ… ä½¿ç”¨å”¯ä¸€ keyï¼šæ­£ç¡®è¿½è¸ªæ¯ä¸ª item</span>
<span class="code-func">items</span>(
    items = users,
    key = { it.id }
) { user ->
    <span class="code-func">UserRow</span>(user)
}</code></pre>

        <div class="callout">
            <p class="callout-title">ğŸ’¡ key çš„ä½œç”¨</p>
            <p>1. æ­£ç¡®å¤„ç†åˆ—è¡¨é¡¹çš„æ·»åŠ /åˆ é™¤/ç§»åŠ¨åŠ¨ç”»<br>
            2. ä¿æŒåˆ—è¡¨é¡¹å†…éƒ¨çŠ¶æ€ï¼ˆå¦‚å±•å¼€çŠ¶æ€ã€è¾“å…¥å†…å®¹ï¼‰<br>
            3. é¿å…ä¸å¿…è¦çš„é‡ç»„</p>
        </div>

        <h2>ä¸‰ã€contentType ä¼˜åŒ–</h2>
        <p>å½“åˆ—è¡¨åŒ…å«å¤šç§ç±»å‹çš„ item æ—¶ï¼Œä½¿ç”¨ <code>contentType</code> å¸®åŠ© Compose å¤ç”¨ Compositionï¼š</p>

<pre><code><span class="code-func">LazyColumn</span> {
    items.<span class="code-func">forEach</span> { item ->
        <span class="code-keyword">when</span> (item) {
            <span class="code-keyword">is</span> <span class="code-type">Header</span> -> <span class="code-func">item</span>(
                key = item.id,
                contentType = <span class="code-string">"header"</span>  <span class="code-comment">// ç±»å‹æ ‡è¯†</span>
            ) {
                <span class="code-func">HeaderRow</span>(item)
            }
            <span class="code-keyword">is</span> <span class="code-type">User</span> -> <span class="code-func">item</span>(
                key = item.id,
                contentType = <span class="code-string">"user"</span>
            ) {
                <span class="code-func">UserRow</span>(item)
            }
            <span class="code-keyword">is</span> <span class="code-type">Ad</span> -> <span class="code-func">item</span>(
                key = item.id,
                contentType = <span class="code-string">"ad"</span>
            ) {
                <span class="code-func">AdBanner</span>(item)
            }
        }
    }
}</code></pre>

        <h2>å››ã€é¿å… item å†…éƒ¨é‡ç»„</h2>

        <h3>1. ä½¿ç”¨ Immutable æ•°æ®</h3>
<pre><code><span class="code-comment">// âœ… ä¸å¯å˜æ•°æ®ç±»</span>
<span class="code-keyword">@Immutable</span>
<span class="code-keyword">data class</span> <span class="code-type">User</span>(
    <span class="code-keyword">val</span> id: <span class="code-type">String</span>,
    <span class="code-keyword">val</span> name: <span class="code-type">String</span>,
    <span class="code-keyword">val</span> avatar: <span class="code-type">String</span>
)</code></pre>

        <h3>2. ç¨³å®šçš„ lambda</h3>
<pre><code><span class="code-comment">// âŒ æ¯æ¬¡é‡ç»„åˆ›å»ºæ–° lambda</span>
<span class="code-func">items</span>(users, key = { it.id }) { user ->
    <span class="code-func">UserRow</span>(
        user = user,
        onClick = { viewModel.<span class="code-func">onUserClick</span>(user) }  <span class="code-comment">// æ–° lambda</span>
    )
}

<span class="code-comment">// âœ… ä½¿ç”¨æ–¹æ³•å¼•ç”¨æˆ–è®°å¿†åŒ–</span>
<span class="code-func">items</span>(users, key = { it.id }) { user ->
    <span class="code-func">UserRow</span>(
        user = user,
        onClick = viewModel::<span class="code-func">onUserClick</span>  <span class="code-comment">// æ–¹æ³•å¼•ç”¨</span>
    )
}</code></pre>

        <h3>3. æ‹†åˆ†ç»„ä»¶ç²’åº¦</h3>
<pre><code><span class="code-comment">// âŒ æ•´ä¸ª Row å›  isOnline å˜åŒ–è€Œé‡ç»„</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">UserRow</span>(user: <span class="code-type">User</span>, isOnline: <span class="code-type">Boolean</span>) {
    <span class="code-func">Row</span> {
        <span class="code-func">Avatar</span>(user.avatar)
        <span class="code-func">Text</span>(user.name)
        <span class="code-func">OnlineIndicator</span>(isOnline)  <span class="code-comment">// é¢‘ç¹å˜åŒ–</span>
    }
}

<span class="code-comment">// âœ… å°†é¢‘ç¹å˜åŒ–çš„éƒ¨åˆ†ç‹¬ç«‹</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">UserRow</span>(user: <span class="code-type">User</span>, onlineState: <span class="code-type">State</span>&lt;<span class="code-type">Boolean</span>&gt;) {
    <span class="code-func">Row</span> {
        <span class="code-func">Avatar</span>(user.avatar)
        <span class="code-func">Text</span>(user.name)
        <span class="code-func">OnlineIndicator</span>(onlineState)  <span class="code-comment">// åªæœ‰è¿™ä¸ªé‡ç»„</span>
    }
}</code></pre>

        <h2>äº”ã€é¢„åŠ è½½ä¸ç¼“å­˜</h2>

<pre><code><span class="code-keyword">val</span> listState = <span class="code-func">rememberLazyListState</span>()

<span class="code-func">LazyColumn</span>(
    state = listState,
    <span class="code-comment">// é¢„åŠ è½½å±å¹•å¤–çš„ item</span>
    beyondBoundsItemCount = <span class="code-number">5</span>
) {
    <span class="code-func">items</span>(items, key = { it.id }) { item ->
        <span class="code-func">ItemRow</span>(item)
    }
}</code></pre>

        <h2>å…­ã€Paging3 é›†æˆ</h2>
        <p>å¯¹äºå¤§æ•°æ®é›†ï¼Œä½¿ç”¨ Paging3 å®ç°æŒ‰éœ€åŠ è½½ï¼š</p>

<pre><code><span class="code-comment">// ViewModel</span>
<span class="code-keyword">val</span> usersPager = <span class="code-func">Pager</span>(
    config = <span class="code-func">PagingConfig</span>(
        pageSize = <span class="code-number">20</span>,
        prefetchDistance = <span class="code-number">5</span>,
        enablePlaceholders = <span class="code-keyword">false</span>
    )
) {
    <span class="code-func">UsersPagingSource</span>(repository)
}.flow.<span class="code-func">cachedIn</span>(viewModelScope)

<span class="code-comment">// Composable</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">UserList</span>(viewModel: <span class="code-type">UserViewModel</span>) {
    <span class="code-keyword">val</span> users = viewModel.usersPager.<span class="code-func">collectAsLazyPagingItems</span>()

    <span class="code-func">LazyColumn</span> {
        <span class="code-func">items</span>(
            count = users.itemCount,
            key = users.<span class="code-func">itemKey</span> { it.id },
            contentType = users.<span class="code-func">itemContentType</span> { <span class="code-string">"user"</span> }
        ) { index ->
            <span class="code-keyword">val</span> user = users[index]
            <span class="code-keyword">if</span> (user != <span class="code-keyword">null</span>) {
                <span class="code-func">UserRow</span>(user)
            } <span class="code-keyword">else</span> {
                <span class="code-func">UserPlaceholder</span>()
            }
        }

        <span class="code-comment">// åŠ è½½çŠ¶æ€</span>
        <span class="code-keyword">when</span> (users.loadState.append) {
            <span class="code-keyword">is</span> LoadState.Loading -> <span class="code-func">item</span> { <span class="code-func">LoadingItem</span>() }
            <span class="code-keyword">is</span> LoadState.Error -> <span class="code-func">item</span> { <span class="code-func">ErrorItem</span>(onRetry = { users.<span class="code-func">retry</span>() }) }
            <span class="code-keyword">else</span> -> {}
        }
    }
}</code></pre>

        <h2>ä¸ƒã€æ»šåŠ¨æ€§èƒ½ç›‘æ§</h2>

<pre><code><span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">PerformantList</span>(items: <span class="code-type">List</span>&lt;<span class="code-type">Item</span>&gt;) {
    <span class="code-keyword">val</span> listState = <span class="code-func">rememberLazyListState</span>()

    <span class="code-comment">// ç›‘æ§æ»šåŠ¨æ€§èƒ½</span>
    <span class="code-func">LaunchedEffect</span>(listState) {
        <span class="code-func">snapshotFlow</span> { listState.isScrollInProgress }
            .<span class="code-func">collect</span> { isScrolling ->
                <span class="code-keyword">if</span> (isScrolling) {
                    <span class="code-comment">// æ»šåŠ¨æ—¶æš‚åœéå…³é”®æ“ä½œ</span>
                }
            }
    }

    <span class="code-func">LazyColumn</span>(state = listState) {
        <span class="code-func">items</span>(items, key = { it.id }) { item ->
            <span class="code-func">ItemRow</span>(item)
        }
    }
}</code></pre>

        <h2>å…«ã€LazyGrid ä½¿ç”¨</h2>

<pre><code><span class="code-func">LazyVerticalGrid</span>(
    columns = GridCells.Adaptive(minSize = <span class="code-number">150</span>.dp),
    contentPadding = <span class="code-func">PaddingValues</span>(<span class="code-number">16</span>.dp),
    horizontalArrangement = Arrangement.<span class="code-func">spacedBy</span>(<span class="code-number">8</span>.dp),
    verticalArrangement = Arrangement.<span class="code-func">spacedBy</span>(<span class="code-number">8</span>.dp)
) {
    <span class="code-func">items</span>(
        items = products,
        key = { it.id },
        contentType = { <span class="code-string">"product"</span> }
    ) { product ->
        <span class="code-func">ProductCard</span>(product)
    }
}</code></pre>

        <h2>ä¹ã€Sticky Headers</h2>

<pre><code><span class="code-func">LazyColumn</span> {
    groupedItems.<span class="code-func">forEach</span> { (category, items) ->
        <span class="code-func">stickyHeader</span>(key = category) {
            <span class="code-func">CategoryHeader</span>(category)
        }

        <span class="code-func">items</span>(items, key = { it.id }) { item ->
            <span class="code-func">ItemRow</span>(item)
        }
    }
}</code></pre>

        <h2>åã€æ€§èƒ½ä¼˜åŒ–æ¸…å•</h2>
        <ul>
            <li>âœ… å§‹ç»ˆæä¾›ç¨³å®šçš„ <code>key</code></li>
            <li>âœ… ä½¿ç”¨ <code>contentType</code> åŒºåˆ†ä¸åŒç±»å‹çš„ item</li>
            <li>âœ… ä½¿ç”¨ <code>@Immutable</code> æˆ– <code>@Stable</code> æ ‡æ³¨æ•°æ®ç±»</li>
            <li>âœ… é¿å…åœ¨ item å†…åˆ›å»ºæ–°çš„ lambda</li>
            <li>âœ… æ‹†åˆ†ç»„ä»¶ï¼Œéš”ç¦»é¢‘ç¹å˜åŒ–çš„éƒ¨åˆ†</li>
            <li>âœ… å¤§æ•°æ®é›†ä½¿ç”¨ Paging3</li>
            <li>âœ… åˆç†è®¾ç½® <code>beyondBoundsItemCount</code></li>
            <li>âœ… é¿å…åœ¨ item ä¸­è¿›è¡Œå¤æ‚è®¡ç®—</li>
            <li>âœ… å›¾ç‰‡ä½¿ç”¨ Coil/Glide ç­‰åº“çš„ Compose æ‰©å±•</li>
            <li>âœ… ä½¿ç”¨ Layout Inspector ç›‘æ§é‡ç»„</li>
        </ul>

        <h2>æ€»ç»“</h2>
        <p>ä¼˜åŒ– Lazy åˆ—è¡¨çš„æ ¸å¿ƒåŸåˆ™ï¼š</p>
        <ul>
            <li><strong>æ­£ç¡®çš„ key</strong>ï¼šå¸®åŠ© Compose è¿½è¸ª item èº«ä»½</li>
            <li><strong>å‡å°‘é‡ç»„</strong>ï¼šä½¿ç”¨ç¨³å®šæ•°æ®å’Œ lambda</li>
            <li><strong>æŒ‰éœ€åŠ è½½</strong>ï¼šå¤§æ•°æ®é›†ä½¿ç”¨ Paging3</li>
            <li><strong>ç›‘æ§æ€§èƒ½</strong>ï¼šä½¿ç”¨å·¥å…·å‘ç°ç“¶é¢ˆ</li>
        </ul>
    </article>

    <footer class="footer">
        <p>&copy; 2024 Fidroid. <a href="../index.html">è¿”å›é¦–é¡µ</a></p>
    </footer>
</body>
</html>


