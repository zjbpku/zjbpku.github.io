<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·±å…¥ Compose ç¼–è¯‘å™¨ï¼šSlot Table ä¸ä½ç½®è®°å¿†åŒ– - Fidroid</title>
    <meta name="description" content="æ·±å…¥ç†è§£ Jetpack Compose ç¼–è¯‘å™¨çš„å·¥ä½œåŸç†ï¼Œæ¢ç´¢ Slot Table æ•°æ®ç»“æ„ã€ä½ç½®è®°å¿†åŒ–æœºåˆ¶ã€Gap Buffer ç®—æ³•ç­‰æ ¸å¿ƒæ¦‚å¿µã€‚">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.8;
            color: #e5e7eb;
            background: #020617;
        }
        .navbar {
            background: rgba(15,23,42,0.98);
            backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }
        .nav-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #38bdf8;
            text-decoration: none;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .back-link { color: #9ca3af; text-decoration: none; font-size: 0.9rem; }
        .back-link:hover { color: #38bdf8; }

        .article-header {
            padding: 120px 20px 60px;
            background: radial-gradient(circle at top left, #7c3aed 0, transparent 50%),
                        radial-gradient(circle at bottom right, #0ea5e9 0, transparent 55%),
                        #020617;
            text-align: center;
        }
        .article-header h1 {
            max-width: 800px;
            margin: 0 auto 1rem;
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            color: #fff;
        }
        .article-meta { color: #9ca3af; font-size: 0.9rem; margin-bottom: 1.5rem; }
        .article-tags { display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem; }
        .article-tag {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            background: rgba(15,23,42,0.85);
            border: 1px solid rgba(124,58,237,0.4);
            color: #c4b5fd;
        }

        .article-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 60px 20px 80px;
        }
        .article-content h2 {
            font-size: 1.6rem;
            margin: 2.5rem 0 1rem;
            color: #f9fafb;
            border-left: 4px solid #7c3aed;
            padding-left: 1rem;
        }
        .article-content h3 { font-size: 1.25rem; margin: 2rem 0 0.75rem; color: #e5e7eb; }
        .article-content p { margin-bottom: 1.25rem; color: #d1d5db; }
        .article-content ul, .article-content ol { margin: 1rem 0 1.5rem 1.5rem; color: #d1d5db; }
        .article-content li { margin-bottom: 0.5rem; }
        .article-content strong { color: #f9fafb; }
        .article-content a { color: #38bdf8; text-decoration: underline; }

        pre {
            background: #0f172a;
            border: 1px solid rgba(124,58,237,0.3);
            border-radius: 12px;
            padding: 1.25rem;
            overflow-x: auto;
            margin: 1.5rem 0;
            font-size: 0.85rem;
            line-height: 1.6;
        }
        code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; color: #e5e7eb; }
        .code-keyword { color: #c084fc; }
        .code-func { color: #38bdf8; }
        .code-type { color: #4ade80; }
        .code-string { color: #fb7185; }
        .code-comment { color: #6b7280; font-style: italic; }
        .code-number { color: #fbbf24; }

        .callout {
            background: rgba(124,58,237,0.1);
            border: 1px solid rgba(124,58,237,0.3);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            margin: 1.5rem 0;
        }
        .callout-title { font-weight: 600; color: #c4b5fd; margin-bottom: 0.5rem; }
        .callout p { margin-bottom: 0; color: #d1d5db; }

        .callout-warning {
            background: rgba(245,158,11,0.1);
            border: 1px solid rgba(245,158,11,0.3);
        }
        .callout-warning .callout-title { color: #fcd34d; }

        .callout-info {
            background: rgba(14,165,233,0.1);
            border: 1px solid rgba(14,165,233,0.3);
        }
        .callout-info .callout-title { color: #7dd3fc; }

        .diagram {
            background: #0f172a;
            border: 1px solid rgba(124,58,237,0.3);
            border-radius: 12px;
            padding: 2rem;
            margin: 1.5rem 0;
            text-align: center;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.85rem;
            line-height: 1.8;
            color: #94a3b8;
            overflow-x: auto;
        }
        .diagram .highlight { color: #c084fc; font-weight: bold; }
        .diagram .data { color: #4ade80; }
        .diagram .gap { color: #f87171; }

        .reference {
            background: rgba(15,23,42,0.6);
            border: 1px solid rgba(148,163,184,0.2);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        .reference-title {
            font-weight: 600;
            color: #94a3b8;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        .reference a { color: #38bdf8; }

        .footer {
            background: #020617;
            border-top: 1px solid #111827;
            padding: 2rem;
            text-align: center;
            color: #6b7280;
        }
        .footer a { color: #38bdf8; text-decoration: none; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="logo">Fidroid</a>
            <a href="../index.html#blog" class="back-link">â† è¿”å›åšå®¢åˆ—è¡¨</a>
        </div>
    </nav>

    <header class="article-header">
        <h1>æ·±å…¥ Compose ç¼–è¯‘å™¨ï¼šSlot Table ä¸ä½ç½®è®°å¿†åŒ–</h1>
        <p class="article-meta">2024-04-25 Â· 30 min Â· åŸç†æ·±åº¦è§£æ</p>
        <div class="article-tags">
            <span class="article-tag">Compose Compiler</span>
            <span class="article-tag">Slot Table</span>
            <span class="article-tag">Gap Buffer</span>
            <span class="article-tag">Positional Memoization</span>
        </div>
    </header>

    <article class="article-content">
        <p>å½“ä½ å†™ä¸‹ä¸€ä¸ªç®€å•çš„ <code>@Composable</code> å‡½æ•°æ—¶ï¼ŒCompose ç¼–è¯‘å™¨åœ¨èƒŒååšäº†å¤§é‡å·¥ä½œã€‚ç†è§£è¿™äº›åº•å±‚æœºåˆ¶ä¸ä»…èƒ½å¸®åŠ©ä½ å†™å‡ºæ›´é«˜æ•ˆçš„ä»£ç ï¼Œè¿˜èƒ½è®©ä½ åœ¨é‡åˆ°æ€§èƒ½é—®é¢˜æ—¶çŸ¥é“ä»ä½•ä¸‹æ‰‹ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ Compose ç¼–è¯‘å™¨çš„æ ¸å¿ƒï¼š<strong>Slot Table</strong> æ•°æ®ç»“æ„å’Œ<strong>ä½ç½®è®°å¿†åŒ–ï¼ˆPositional Memoizationï¼‰</strong>æœºåˆ¶ã€‚</p>

        <div class="reference">
            <div class="reference-title">ğŸ“š å®˜æ–¹å‚è€ƒ</div>
            <a href="https://developer.android.com/jetpack/compose/mental-model" target="_blank">Thinking in Compose - Android Developers</a><br>
            <a href="https://cs.android.com/androidx/platform/frameworks/support/+/androidx-main:compose/runtime/" target="_blank">Compose Runtime Source Code</a>
        </div>

        <h2>ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦ Slot Tableï¼Ÿ</h2>

        <p>ä¼ ç»Ÿçš„ UI æ¡†æ¶ï¼ˆå¦‚ Android View ç³»ç»Ÿï¼‰ä½¿ç”¨<strong>å¯¹è±¡æ ‘</strong>æ¥è¡¨ç¤º UI ç»“æ„ã€‚æ¯ä¸ª View æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒæŒæœ‰è‡ªå·±çš„çŠ¶æ€ï¼Œé€šè¿‡çˆ¶å­å¼•ç”¨å½¢æˆæ ‘å½¢ç»“æ„ã€‚è¿™ç§æ–¹å¼ç›´è§‚ä½†æœ‰å‡ ä¸ªé—®é¢˜ï¼š</p>

        <ul>
            <li><strong>å†…å­˜å¼€é”€å¤§</strong>ï¼šæ¯ä¸ª View å¯¹è±¡éƒ½æœ‰è‡ªå·±çš„å†…å­˜åˆ†é…</li>
            <li><strong>GC å‹åŠ›</strong>ï¼šé¢‘ç¹åˆ›å»º/é”€æ¯ View ä¼šè§¦å‘åƒåœ¾å›æ”¶</li>
            <li><strong>æ›´æ–°æ•ˆç‡ä½</strong>ï¼šéœ€è¦éå†æ•´æ£µæ ‘æ¥æ‰¾åˆ°éœ€è¦æ›´æ–°çš„èŠ‚ç‚¹</li>
        </ul>

        <p>Compose é‡‡ç”¨äº†å®Œå…¨ä¸åŒçš„æ–¹å¼ï¼šå®ƒä¸åˆ›å»º UI å¯¹è±¡æ ‘ï¼Œè€Œæ˜¯å°†æ‰€æœ‰ UI ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªæ‰å¹³çš„æ•°ç»„ç»“æ„ä¸­â€”â€”è¿™å°±æ˜¯ <strong>Slot Table</strong>ã€‚</p>

        <div class="callout callout-info">
            <p class="callout-title">ğŸ’¡ æ ¸å¿ƒæ´å¯Ÿ</p>
            <p>Slot Table æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª<strong>çº¿æ€§åŒ–çš„ UI æè¿°</strong>ã€‚å®ƒæŠŠæ ‘å½¢ç»“æ„"å‹æ‰"æˆæ•°ç»„ï¼Œç”¨ä½ç½®ä¿¡æ¯æ¥éšå¼è¡¨è¾¾çˆ¶å­å…³ç³»ã€‚è¿™ç§è®¾è®¡å€Ÿé‰´äº†ç¼–è¯‘å™¨å’Œæ•°æ®åº“é¢†åŸŸçš„æŠ€æœ¯ã€‚</p>
        </div>

        <h2>äºŒã€Slot Table çš„æ•°æ®ç»“æ„</h2>

        <p>Slot Table ç”±ä¸¤ä¸ªä¸»è¦æ•°ç»„ç»„æˆï¼š</p>

        <ol>
            <li><strong>Groups Array</strong>ï¼šå­˜å‚¨ç»“æ„ä¿¡æ¯ï¼ˆå“ªäº› Composable è¢«è°ƒç”¨ã€å®ƒä»¬çš„å±‚çº§å…³ç³»ï¼‰</li>
            <li><strong>Slots Array</strong>ï¼šå­˜å‚¨æ•°æ®ï¼ˆçŠ¶æ€å€¼ã€remember çš„å€¼ã€å‚æ•°ç­‰ï¼‰</li>
        </ol>

        <div class="diagram">
<pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      <span class="highlight">Slot Table</span>                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  <span class="data">Groups Array</span> (ç»“æ„ä¿¡æ¯)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ G0 â”‚ G1 â”‚ G2 â”‚ G3 â”‚<span class="gap">    â”‚    â”‚    â”‚</span>G4 â”‚ G5 â”‚ G6 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜       â”‚
â”‚                        <span class="gap">â†‘ Gap</span>                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  <span class="data">Slots Array</span> (æ•°æ®)                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ S0 â”‚ S1 â”‚ S2 â”‚<span class="gap">    â”‚    â”‚    â”‚</span>S3 â”‚ S4 â”‚ S5 â”‚ S6 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜       â”‚
â”‚                   <span class="gap">â†‘ Gap</span>                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
        </div>

        <h3>Group çš„ç»“æ„</h3>

        <p>æ¯ä¸ª Group ä»£è¡¨ä¸€æ¬¡ Composable è°ƒç”¨æˆ–ä¸€ä¸ªé€»è¾‘åˆ†ç»„ï¼ŒåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š</p>

<pre><code><span class="code-comment">// ç®€åŒ–çš„ Group ç»“æ„ï¼ˆå®é™…å®ç°æ›´å¤æ‚ï¼‰</span>
<span class="code-keyword">internal class</span> <span class="code-type">Group</span> {
    <span class="code-keyword">val</span> key: <span class="code-type">Int</span>           <span class="code-comment">// å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºåŒ¹é…</span>
    <span class="code-keyword">val</span> dataAnchor: <span class="code-type">Int</span>    <span class="code-comment">// æŒ‡å‘ Slots Array ä¸­æ•°æ®çš„èµ·å§‹ä½ç½®</span>
    <span class="code-keyword">val</span> parentAnchor: <span class="code-type">Int</span>  <span class="code-comment">// çˆ¶ Group çš„ç´¢å¼•</span>
    <span class="code-keyword">val</span> size: <span class="code-type">Int</span>          <span class="code-comment">// å­ Group çš„æ•°é‡</span>
    <span class="code-keyword">val</span> nodeCount: <span class="code-type">Int</span>     <span class="code-comment">// åŒ…å«çš„ LayoutNode æ•°é‡</span>
}</code></pre>

        <div class="reference">
            <div class="reference-title">ğŸ“š æºç å‚è€ƒ</div>
            <a href="https://cs.android.com/androidx/platform/frameworks/support/+/androidx-main:compose/runtime/runtime/src/commonMain/kotlin/androidx/compose/runtime/SlotTable.kt" target="_blank">SlotTable.kt - Compose Runtime</a>
        </div>

        <h2>ä¸‰ã€Gap Buffer ç®—æ³•</h2>

        <p>Slot Table ä½¿ç”¨ <strong>Gap Buffer</strong> ç®—æ³•æ¥é«˜æ•ˆå¤„ç†æ’å…¥å’Œåˆ é™¤æ“ä½œã€‚è¿™ä¸ªç®—æ³•æœ€åˆæ¥è‡ªæ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆå¦‚ Emacsï¼‰ï¼Œç”¨äºå¤„ç†å…‰æ ‡ä½ç½®çš„æ–‡æœ¬ç¼–è¾‘ã€‚</p>

        <h3>Gap Buffer çš„å·¥ä½œåŸç†</h3>

        <p>Gap Buffer åœ¨æ•°ç»„ä¸­ç»´æŠ¤ä¸€ä¸ª"ç©ºéš™"ï¼ˆGapï¼‰ï¼Œæ‰€æœ‰çš„æ’å…¥/åˆ é™¤æ“ä½œéƒ½åœ¨ Gap çš„ä½ç½®è¿›è¡Œï¼š</p>

        <div class="diagram">
<pre>
<span class="highlight">åˆå§‹çŠ¶æ€ï¼š</span>
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬<span class="gap">â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€</span>â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ A â”‚ B â”‚ C â”‚<span class="gap">   â”‚   â”‚   </span>â”‚ D â”‚ E â”‚ F â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´<span class="gap">â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€</span>â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
            <span class="gap">â†‘ Gap (cursor)</span>

<span class="highlight">åœ¨ C åæ’å…¥ Xï¼š</span>ï¼ˆO(1) æ“ä½œï¼‰
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬<span class="gap">â”€â”€â”€â”¬â”€â”€â”€</span>â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ A â”‚ B â”‚ C â”‚ <span class="data">X</span> â”‚<span class="gap">   â”‚   </span>â”‚ D â”‚ E â”‚ F â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´<span class="gap">â”€â”€â”€â”´â”€â”€â”€</span>â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
                <span class="gap">â†‘ Gap moved</span>

<span class="highlight">ç§»åŠ¨åˆ° E åæ’å…¥ Yï¼š</span>ï¼ˆéœ€è¦å…ˆç§»åŠ¨ Gapï¼‰
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬<span class="gap">â”€â”€â”€</span>â”¬â”€â”€â”€â”
â”‚ A â”‚ B â”‚ C â”‚ X â”‚ D â”‚ E â”‚ <span class="data">Y</span> â”‚<span class="gap">   </span>â”‚ F â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´<span class="gap">â”€â”€â”€</span>â”´â”€â”€â”€â”˜
                            <span class="gap">â†‘ Gap</span>
</pre>
        </div>

        <p>Gap Buffer çš„ä¼˜åŠ¿åœ¨äºï¼š</p>
        <ul>
            <li><strong>å±€éƒ¨æ€§åŸåˆ™</strong>ï¼šè¿ç»­çš„æ’å…¥/åˆ é™¤æ“ä½œï¼ˆå¦‚ Recomposition æ—¶ï¼‰é€šå¸¸å‘ç”Ÿåœ¨ç›¸é‚»ä½ç½®ï¼ŒGap ä¸éœ€è¦é¢‘ç¹ç§»åŠ¨</li>
            <li><strong>O(1) å±€éƒ¨æ“ä½œ</strong>ï¼šåœ¨ Gap ä½ç½®çš„æ’å…¥/åˆ é™¤æ˜¯å¸¸æ•°æ—¶é—´</li>
            <li><strong>å†…å­˜è¿ç»­</strong>ï¼šæ•°æ®å­˜å‚¨åœ¨è¿ç»­å†…å­˜ä¸­ï¼Œç¼“å­˜å‹å¥½</li>
        </ul>

        <div class="callout">
            <p class="callout-title">ğŸ”¬ ä¸ºä»€ä¹ˆé€‰æ‹© Gap Bufferï¼Ÿ</p>
            <p>Compose çš„ Recomposition å…·æœ‰å¾ˆå¼ºçš„<strong>å±€éƒ¨æ€§</strong>ï¼šå½“çŠ¶æ€å˜åŒ–æ—¶ï¼Œé€šå¸¸åªæœ‰ä¸€å°éƒ¨åˆ† UI éœ€è¦æ›´æ–°ï¼Œè€Œä¸”è¿™äº›æ›´æ–°å¾€å¾€æ˜¯è¿ç»­çš„ã€‚Gap Buffer æ­£å¥½åˆ©ç”¨äº†è¿™ä¸€ç‰¹æ€§ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æä¾› O(1) çš„æ›´æ–°æ€§èƒ½ã€‚</p>
        </div>

        <h2>å››ã€ä½ç½®è®°å¿†åŒ–ï¼ˆPositional Memoizationï¼‰</h2>

        <p>è¿™æ˜¯ Compose æœ€æ ¸å¿ƒçš„åˆ›æ–°ä¹‹ä¸€ã€‚ä¼ ç»Ÿçš„è®°å¿†åŒ–ï¼ˆMemoizationï¼‰åŸºäº<strong>å‚æ•°å€¼</strong>æ¥ç¼“å­˜ç»“æœï¼Œè€Œ Compose çš„ä½ç½®è®°å¿†åŒ–åŸºäº<strong>è°ƒç”¨ä½ç½®</strong>ã€‚</p>

        <h3>ä¼ ç»Ÿè®°å¿†åŒ– vs ä½ç½®è®°å¿†åŒ–</h3>

<pre><code><span class="code-comment">// ä¼ ç»Ÿè®°å¿†åŒ–ï¼šåŸºäºå‚æ•°å€¼</span>
<span class="code-keyword">val</span> cache = <span class="code-func">mutableMapOf</span>&lt;<span class="code-type">Args</span>, <span class="code-type">Result</span>&gt;()
<span class="code-keyword">fun</span> <span class="code-func">memoized</span>(args: <span class="code-type">Args</span>): <span class="code-type">Result</span> {
    <span class="code-keyword">return</span> cache.<span class="code-func">getOrPut</span>(args) { <span class="code-func">compute</span>(args) }
}

<span class="code-comment">// ä½ç½®è®°å¿†åŒ–ï¼šåŸºäºè°ƒç”¨ä½ç½®</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">Example</span>() {
    <span class="code-comment">// å³ä½¿å‚æ•°ç›¸åŒï¼Œè¿™ä¸¤ä¸ª remember å­˜å‚¨åœ¨ä¸åŒä½ç½®</span>
    <span class="code-keyword">val</span> state1 = <span class="code-func">remember</span> { <span class="code-func">mutableStateOf</span>(<span class="code-number">0</span>) }  <span class="code-comment">// ä½ç½® A</span>
    <span class="code-keyword">val</span> state2 = <span class="code-func">remember</span> { <span class="code-func">mutableStateOf</span>(<span class="code-number">0</span>) }  <span class="code-comment">// ä½ç½® B</span>
    <span class="code-comment">// state1 å’Œ state2 æ˜¯ç‹¬ç«‹çš„ï¼</span>
}</code></pre>

        <h3>ç¼–è¯‘å™¨å¦‚ä½•å®ç°ä½ç½®è®°å¿†åŒ–</h3>

        <p>Compose ç¼–è¯‘å™¨ä¼šä¸ºæ¯ä¸ª <code>@Composable</code> å‡½æ•°æ³¨å…¥é¢å¤–çš„å‚æ•°å’Œä»£ç ï¼š</p>

<pre><code><span class="code-comment">// ä½ å†™çš„ä»£ç </span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">Greeting</span>(name: <span class="code-type">String</span>) {
    <span class="code-func">Text</span>(<span class="code-string">"Hello, $name"</span>)
}

<span class="code-comment">// ç¼–è¯‘å™¨è½¬æ¢åï¼ˆç®€åŒ–ç‰ˆï¼‰</span>
<span class="code-keyword">fun</span> <span class="code-func">Greeting</span>(
    name: <span class="code-type">String</span>,
    <span class="code-type">$composer</span>: <span class="code-type">Composer</span>,    <span class="code-comment">// æ³¨å…¥çš„ Composer</span>
    <span class="code-type">$changed</span>: <span class="code-type">Int</span>            <span class="code-comment">// å‚æ•°å˜åŒ–æ ‡è®°</span>
) {
    <span class="code-type">$composer</span>.<span class="code-func">startRestartGroup</span>(<span class="code-number">123456789</span>)  <span class="code-comment">// å”¯ä¸€çš„ Group Key</span>
    
    <span class="code-comment">// æ£€æŸ¥æ˜¯å¦å¯ä»¥è·³è¿‡</span>
    <span class="code-keyword">if</span> (<span class="code-type">$changed</span> == <span class="code-number">0</span> && <span class="code-type">$composer</span>.skipping) {
        <span class="code-type">$composer</span>.<span class="code-func">skipToGroupEnd</span>()
    } <span class="code-keyword">else</span> {
        <span class="code-func">Text</span>(<span class="code-string">"Hello, $name"</span>, <span class="code-type">$composer</span>, <span class="code-number">0</span>)
    }
    
    <span class="code-type">$composer</span>.<span class="code-func">endRestartGroup</span>()?.<span class="code-func">updateScope</span> { 
        <span class="code-func">Greeting</span>(name, <span class="code-type">$composer</span>, <span class="code-type">$changed</span> <span class="code-keyword">or</span> <span class="code-number">1</span>) 
    }
}</code></pre>

        <h3>Group Key çš„ç”Ÿæˆ</h3>

        <p>ç¼–è¯‘å™¨ä¸ºæ¯ä¸ª Composable è°ƒç”¨ç”Ÿæˆå”¯ä¸€çš„ <strong>Group Key</strong>ï¼Œè¿™ä¸ª Key åŸºäºï¼š</p>

        <ul>
            <li>æºæ–‡ä»¶è·¯å¾„</li>
            <li>è¡Œå·å’Œåˆ—å·</li>
            <li>è°ƒç”¨é¡ºåº</li>
        </ul>

<pre><code><span class="code-comment">// è¿™ä¸¤ä¸ª Text æœ‰ä¸åŒçš„ Group Key</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">TwoTexts</span>() {
    <span class="code-func">Text</span>(<span class="code-string">"First"</span>)   <span class="code-comment">// Key: hash("TwoTexts.kt:5:4")</span>
    <span class="code-func">Text</span>(<span class="code-string">"Second"</span>)  <span class="code-comment">// Key: hash("TwoTexts.kt:6:4")</span>
}</code></pre>

        <div class="callout callout-warning">
            <p class="callout-title">âš ï¸ æ¡ä»¶è¯­å¥çš„é™·é˜±</p>
            <p>ä½ç½®è®°å¿†åŒ–æ„å‘³ç€<strong>è°ƒç”¨é¡ºåºå¾ˆé‡è¦</strong>ã€‚å¦‚æœåœ¨æ¡ä»¶è¯­å¥ä¸­è°ƒç”¨ Composableï¼Œæ¡ä»¶å˜åŒ–å¯èƒ½å¯¼è‡´ä½ç½®é”™ä¹±ï¼š</p>
        </div>

<pre><code><span class="code-comment">// âŒ å±é™©ï¼šæ¡ä»¶å˜åŒ–ä¼šå¯¼è‡´çŠ¶æ€é”™ä¹±</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">Problematic</span>(showFirst: <span class="code-type">Boolean</span>) {
    <span class="code-keyword">if</span> (showFirst) {
        <span class="code-func">Counter</span>()  <span class="code-comment">// ä½ç½® 0</span>
    }
    <span class="code-func">Counter</span>()      <span class="code-comment">// showFirst=true æ—¶ä½ç½® 1ï¼Œfalse æ—¶ä½ç½® 0ï¼</span>
}

<span class="code-comment">// âœ… ä½¿ç”¨ key æ˜ç¡®èº«ä»½</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">Safe</span>(showFirst: <span class="code-type">Boolean</span>) {
    <span class="code-keyword">if</span> (showFirst) {
        <span class="code-func">key</span>(<span class="code-string">"first"</span>) { <span class="code-func">Counter</span>() }
    }
    <span class="code-func">key</span>(<span class="code-string">"second"</span>) { <span class="code-func">Counter</span>() }
}</code></pre>

        <h2>äº”ã€Recomposition çš„æ‰§è¡Œè¿‡ç¨‹</h2>

        <p>å½“çŠ¶æ€å˜åŒ–è§¦å‘ Recomposition æ—¶ï¼ŒCompose æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>

        <div class="diagram">
<pre>
<span class="highlight">Recomposition æµç¨‹</span>

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  State Changed  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Find Invalid    â”‚  â† æ‰¾åˆ°è¯»å–è¯¥çŠ¶æ€çš„ Scope
â”‚ RecomposeScope  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Seek to Group   â”‚  â† ç§»åŠ¨ Gap åˆ°å¯¹åº”ä½ç½®
â”‚ in Slot Table   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Re-execute      â”‚  â† é‡æ–°æ‰§è¡Œ Composable
â”‚ Composable      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Compare & Diff  â”‚  â† æ¯”è¾ƒæ–°æ—§æ•°æ®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Update Slot     â”‚  â† æ›´æ–°å˜åŒ–çš„éƒ¨åˆ†
â”‚ Table           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Apply Changes   â”‚  â† åº”ç”¨åˆ° LayoutNode
â”‚ to UI           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
        </div>

        <h3>Composer çš„è¯»å†™æ¨¡å¼</h3>

        <p>Composer åœ¨æ‰§è¡Œ Composable æ—¶æœ‰ä¸¤ç§æ¨¡å¼ï¼š</p>

<pre><code><span class="code-keyword">internal class</span> <span class="code-type">Composer</span> {
    <span class="code-keyword">var</span> inserting: <span class="code-type">Boolean</span> = <span class="code-keyword">false</span>
    
    <span class="code-comment">// inserting = true: é¦–æ¬¡ç»„åˆï¼Œå†™å…¥æ–°æ•°æ®</span>
    <span class="code-comment">// inserting = false: é‡ç»„ï¼Œè¯»å–å¹¶æ¯”è¾ƒ</span>
    
    <span class="code-keyword">fun</span> <span class="code-func">remember</span>&lt;<span class="code-type">T</span>&gt;(calculation: () -> <span class="code-type">T</span>): <span class="code-type">T</span> {
        <span class="code-keyword">return if</span> (inserting) {
            <span class="code-comment">// é¦–æ¬¡ï¼šè®¡ç®—å¹¶å­˜å‚¨</span>
            <span class="code-keyword">val</span> value = <span class="code-func">calculation</span>()
            <span class="code-func">updateValue</span>(value)
            value
        } <span class="code-keyword">else</span> {
            <span class="code-comment">// é‡ç»„ï¼šä» Slot Table è¯»å–</span>
            <span class="code-func">nextSlot</span>() <span class="code-keyword">as</span> <span class="code-type">T</span>
        }
    }
}</code></pre>

        <h2>å…­ã€$changed å‚æ•°ä¸è·³è¿‡ä¼˜åŒ–</h2>

        <p>ç¼–è¯‘å™¨æ³¨å…¥çš„ <code>$changed</code> å‚æ•°æ˜¯ä¸€ä¸ªä½æ©ç ï¼Œç”¨äºè¿½è¸ªå“ªäº›å‚æ•°å‘ç”Ÿäº†å˜åŒ–ï¼š</p>

<pre><code><span class="code-comment">// $changed ä½æ©ç ç»“æ„</span>
<span class="code-comment">// æ¯ä¸ªå‚æ•°å ç”¨ 3 ä½ï¼š</span>
<span class="code-comment">// - bit 0: æ˜¯å¦"è„"ï¼ˆéœ€è¦æ£€æŸ¥ï¼‰</span>
<span class="code-comment">// - bit 1-2: ç¨³å®šæ€§ä¿¡æ¯</span>

<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">Example</span>(
    a: <span class="code-type">Int</span>,      <span class="code-comment">// bits 0-2</span>
    b: <span class="code-type">String</span>,   <span class="code-comment">// bits 3-5</span>
    c: <span class="code-type">User</span>      <span class="code-comment">// bits 6-8</span>
)

<span class="code-comment">// è°ƒç”¨æ—¶ï¼š</span>
<span class="code-func">Example</span>(
    a = <span class="code-number">1</span>,
    b = <span class="code-string">"hello"</span>,
    c = user,
    <span class="code-type">$composer</span> = composer,
    <span class="code-type">$changed</span> = <span class="code-number">0b_000_001_000</span>  <span class="code-comment">// åªæœ‰ b å˜åŒ–äº†</span>
)</code></pre>

        <p>é€šè¿‡ <code>$changed</code> å‚æ•°ï¼ŒCompose å¯ä»¥åœ¨ä¸æ‰§è¡Œå‡½æ•°ä½“çš„æƒ…å†µä¸‹åˆ¤æ–­æ˜¯å¦éœ€è¦é‡ç»„ï¼š</p>

<pre><code><span class="code-comment">// ç¼–è¯‘å™¨ç”Ÿæˆçš„è·³è¿‡é€»è¾‘</span>
<span class="code-keyword">if</span> (<span class="code-type">$changed</span> and <span class="code-number">0b111_111_111</span> == <span class="code-number">0</span> && <span class="code-type">$composer</span>.skipping) {
    <span class="code-comment">// æ‰€æœ‰å‚æ•°éƒ½æ²¡å˜ï¼Œè·³è¿‡æ•´ä¸ªå‡½æ•°</span>
    <span class="code-type">$composer</span>.<span class="code-func">skipToGroupEnd</span>()
    <span class="code-keyword">return</span>
}</code></pre>

        <div class="reference">
            <div class="reference-title">ğŸ“š æ·±å…¥é˜…è¯»</div>
            <a href="https://jorgecastillo.dev/book/" target="_blank">Jetpack Compose Internals - Jorge Castillo</a><br>
            <a href="https://medium.com/androiddevelopers/under-the-hood-of-jetpack-compose-part-2-of-2-37b2c20c852" target="_blank">Under the hood of Jetpack Compose - Android Developers Blog</a>
        </div>

        <h2>ä¸ƒã€å®é™…åº”ç”¨ï¼šä¼˜åŒ–ä½ çš„ä»£ç </h2>

        <p>ç†è§£äº†è¿™äº›åŸç†ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºæ›´é«˜æ•ˆçš„ Compose ä»£ç ï¼š</p>

        <h3>1. åˆ©ç”¨ä½ç½®è®°å¿†åŒ–</h3>

<pre><code><span class="code-comment">// âœ… å¥½ï¼šremember çš„å€¼ä¼šè¢«æ­£ç¡®ä¿ç•™</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">GoodExample</span>() {
    <span class="code-keyword">val</span> state = <span class="code-func">remember</span> { <span class="code-func">ExpensiveObject</span>() }
    <span class="code-comment">// state åªåœ¨é¦–æ¬¡ç»„åˆæ—¶åˆ›å»º</span>
}

<span class="code-comment">// âŒ å·®ï¼šæ¯æ¬¡é‡ç»„éƒ½åˆ›å»ºæ–°å¯¹è±¡</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">BadExample</span>() {
    <span class="code-keyword">val</span> state = <span class="code-func">ExpensiveObject</span>()  <span class="code-comment">// æ²¡æœ‰ rememberï¼</span>
}</code></pre>

        <h3>2. ä¿æŒè°ƒç”¨é¡ºåºç¨³å®š</h3>

<pre><code><span class="code-comment">// âœ… å¥½ï¼šä½¿ç”¨ key ä¿æŒèº«ä»½</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">ItemList</span>(items: <span class="code-type">List</span>&lt;<span class="code-type">Item</span>&gt;) {
    <span class="code-func">Column</span> {
        items.<span class="code-func">forEach</span> { item ->
            <span class="code-func">key</span>(item.id) {  <span class="code-comment">// æ˜ç¡®çš„èº«ä»½</span>
                <span class="code-func">ItemRow</span>(item)
            }
        }
    }
}

<span class="code-comment">// âŒ å·®ï¼šä¾èµ–éšå¼ä½ç½®</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">ItemList</span>(items: <span class="code-type">List</span>&lt;<span class="code-type">Item</span>&gt;) {
    <span class="code-func">Column</span> {
        items.<span class="code-func">forEach</span> { item ->
            <span class="code-func">ItemRow</span>(item)  <span class="code-comment">// åˆ—è¡¨é‡æ’åºä¼šå¯¼è‡´çŠ¶æ€é”™ä¹±</span>
        }
    }
}</code></pre>

        <h3>3. å‡å°‘ Group æ•°é‡</h3>

<pre><code><span class="code-comment">// âœ… å¥½ï¼šå†…è”ç®€å•é€»è¾‘</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">Efficient</span>(text: <span class="code-type">String</span>) {
    <span class="code-func">Text</span>(
        text = text,
        color = <span class="code-keyword">if</span> (text.<span class="code-func">isEmpty</span>()) Color.Gray <span class="code-keyword">else</span> Color.Black
    )
}

<span class="code-comment">// âŒ å·®ï¼šä¸å¿…è¦çš„åµŒå¥— Composable</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">Inefficient</span>(text: <span class="code-type">String</span>) {
    <span class="code-func">TextWithColor</span>(text)  <span class="code-comment">// é¢å¤–çš„ Group å¼€é”€</span>
}

<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">TextWithColor</span>(text: <span class="code-type">String</span>) {
    <span class="code-func">Text</span>(
        text = text,
        color = <span class="code-keyword">if</span> (text.<span class="code-func">isEmpty</span>()) Color.Gray <span class="code-keyword">else</span> Color.Black
    )
}</code></pre>

        <h2>å…«ã€è°ƒè¯•æŠ€å·§</h2>

        <h3>æŸ¥çœ‹ç¼–è¯‘å™¨è¾“å‡º</h3>

        <p>ä½ å¯ä»¥é…ç½® Compose ç¼–è¯‘å™¨è¾“å‡ºä¸­é—´ä»£ç ï¼š</p>

<pre><code><span class="code-comment">// build.gradle.kts</span>
composeCompiler {
    reportsDestination = <span class="code-func">layout</span>.buildDirectory.dir(<span class="code-string">"compose_reports"</span>)
    metricsDestination = <span class="code-func">layout</span>.buildDirectory.dir(<span class="code-string">"compose_metrics"</span>)
}</code></pre>

        <h3>ä½¿ç”¨ Layout Inspector</h3>

        <p>Android Studio çš„ Layout Inspector å¯ä»¥æ˜¾ç¤º Recomposition è®¡æ•°ï¼Œå¸®åŠ©ä½ æ‰¾åˆ°é¢‘ç¹é‡ç»„çš„ç»„ä»¶ã€‚</p>

        <h2>æ€»ç»“</h2>

        <p>Compose ç¼–è¯‘å™¨çš„æ ¸å¿ƒè®¾è®¡ï¼š</p>

        <ul>
            <li><strong>Slot Table</strong>ï¼šç”¨æ‰å¹³æ•°ç»„å­˜å‚¨ UI ä¿¡æ¯ï¼Œé¿å…å¯¹è±¡æ ‘çš„å¼€é”€</li>
            <li><strong>Gap Buffer</strong>ï¼šåˆ©ç”¨å±€éƒ¨æ€§åŸåˆ™ï¼Œæä¾› O(1) çš„å±€éƒ¨æ›´æ–°</li>
            <li><strong>ä½ç½®è®°å¿†åŒ–</strong>ï¼šåŸºäºè°ƒç”¨ä½ç½®ç¼“å­˜æ•°æ®ï¼Œè€Œéå‚æ•°å€¼</li>
            <li><strong>$changed å‚æ•°</strong>ï¼šä½æ©ç è¿½è¸ªå‚æ•°å˜åŒ–ï¼Œæ”¯æŒè·³è¿‡ä¼˜åŒ–</li>
        </ul>

        <p>ç†è§£è¿™äº›åº•å±‚æœºåˆ¶ï¼Œèƒ½å¸®åŠ©ä½ ï¼š</p>
        <ul>
            <li>å†™å‡ºæ›´é«˜æ•ˆçš„ Compose ä»£ç </li>
            <li>é¿å…å¸¸è§çš„æ€§èƒ½é™·é˜±</li>
            <li>åœ¨é‡åˆ°é—®é¢˜æ—¶çŸ¥é“å¦‚ä½•è°ƒè¯•</li>
        </ul>

        <div class="reference">
            <div class="reference-title">ğŸ“š æ¨èé˜…è¯»</div>
            <a href="https://developer.android.com/jetpack/compose/performance" target="_blank">Compose Performance - Android Developers</a><br>
            <a href="https://www.youtube.com/watch?v=Q9MtlmmN4Q0" target="_blank">Compose Runtime Deep Dive - Android Dev Summit</a><br>
            <a href="https://jorgecastillo.dev/book/" target="_blank">Jetpack Compose Internals Book</a>
        </div>
    </article>

    <footer class="footer">
        <p>&copy; 2024 Fidroid. <a href="../index.html">è¿”å›é¦–é¡µ</a></p>
    </footer>
</body>
</html>


