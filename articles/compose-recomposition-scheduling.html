<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recomposition è°ƒåº¦ä¸æ‰§è¡Œæœºåˆ¶ï¼šä»çŠ¶æ€å˜æ›´åˆ° UI æ›´æ–° - Fidroid</title>
    <meta name="description" content="æ·±å…¥ç†è§£ Compose é‡ç»„çš„è°ƒåº¦æœºåˆ¶ï¼Œæ¢ç´¢ Recomposerã€InvalidationScopeã€å¸§åŒæ­¥ç­‰æ ¸å¿ƒæ¦‚å¿µï¼Œæ­ç§˜çŠ¶æ€å˜æ›´å¦‚ä½•è§¦å‘ UI æ›´æ–°ã€‚">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.8;
            color: #e5e7eb;
            background: #020617;
        }
        .navbar {
            background: rgba(15,23,42,0.98);
            backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }
        .nav-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #38bdf8;
            text-decoration: none;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .back-link { color: #9ca3af; text-decoration: none; font-size: 0.9rem; }
        .back-link:hover { color: #38bdf8; }

        .article-header {
            padding: 120px 20px 60px;
            background: radial-gradient(circle at top left, #dc2626 0, transparent 50%),
                        radial-gradient(circle at bottom right, #7c3aed 0, transparent 55%),
                        #020617;
            text-align: center;
        }
        .article-header h1 {
            max-width: 800px;
            margin: 0 auto 1rem;
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            color: #fff;
        }
        .article-meta { color: #9ca3af; font-size: 0.9rem; margin-bottom: 1.5rem; }
        .article-tags { display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem; }
        .article-tag {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            background: rgba(15,23,42,0.85);
            border: 1px solid rgba(220,38,38,0.4);
            color: #fca5a5;
        }

        .article-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 60px 20px 80px;
        }
        .article-content h2 {
            font-size: 1.6rem;
            margin: 2.5rem 0 1rem;
            color: #f9fafb;
            border-left: 4px solid #dc2626;
            padding-left: 1rem;
        }
        .article-content h3 { font-size: 1.25rem; margin: 2rem 0 0.75rem; color: #e5e7eb; }
        .article-content p { margin-bottom: 1.25rem; color: #d1d5db; }
        .article-content ul, .article-content ol { margin: 1rem 0 1.5rem 1.5rem; color: #d1d5db; }
        .article-content li { margin-bottom: 0.5rem; }
        .article-content strong { color: #f9fafb; }
        .article-content a { color: #38bdf8; text-decoration: underline; }

        pre {
            background: #0f172a;
            border: 1px solid rgba(220,38,38,0.3);
            border-radius: 12px;
            padding: 1.25rem;
            overflow-x: auto;
            margin: 1.5rem 0;
            font-size: 0.85rem;
            line-height: 1.6;
        }
        code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; color: #e5e7eb; }
        .code-keyword { color: #c084fc; }
        .code-func { color: #38bdf8; }
        .code-type { color: #4ade80; }
        .code-string { color: #fbbf24; }
        .code-comment { color: #6b7280; }
        .code-annotation { color: #f472b6; }

        .tip-box {
            background: rgba(220,38,38,0.1);
            border: 1px solid rgba(220,38,38,0.3);
            border-radius: 12px;
            padding: 1.25rem;
            margin: 1.5rem 0;
        }
        .tip-box.info {
            background: rgba(59,130,246,0.1);
            border-color: rgba(59,130,246,0.3);
        }
        .tip-box.success {
            background: rgba(34,197,94,0.1);
            border-color: rgba(34,197,94,0.3);
        }
        .tip-box.warning {
            background: rgba(245,158,11,0.1);
            border-color: rgba(245,158,11,0.3);
        }
        .tip-title { font-weight: 600; color: #fca5a5; margin-bottom: 0.5rem; }
        .info .tip-title { color: #93c5fd; }
        .success .tip-title { color: #4ade80; }
        .warning .tip-title { color: #fcd34d; }

        .diagram-box {
            background: #0f172a;
            border: 1px solid rgba(220,38,38,0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            font-family: ui-monospace, monospace;
            font-size: 0.8rem;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre;
            color: #9ca3af;
        }
        .diagram-highlight { color: #4ade80; }
        .diagram-accent { color: #38bdf8; }
        .diagram-warning { color: #fbbf24; }
        .diagram-red { color: #f87171; }

        .footer {
            background: #0f172a;
            padding: 3rem 20px;
            text-align: center;
            border-top: 1px solid rgba(220,38,38,0.2);
        }
        .footer p { color: #6b7280; font-size: 0.9rem; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="logo">Fidroid</a>
            <a href="../index.html#articles" class="back-link">â† è¿”å›æ–‡ç« åˆ—è¡¨</a>
        </div>
    </nav>

    <header class="article-header">
        <h1>Recomposition è°ƒåº¦ä¸æ‰§è¡Œæœºåˆ¶ï¼šä»çŠ¶æ€å˜æ›´åˆ° UI æ›´æ–°</h1>
        <div class="article-meta">ğŸ“… 2024-07-07 Â· â± 32 min Â· ğŸ”¬ åº•å±‚åŸç†</div>
        <div class="article-tags">
            <span class="article-tag">Recomposition</span>
            <span class="article-tag">Recomposer</span>
            <span class="article-tag">Snapshot</span>
            <span class="article-tag">Scheduling</span>
        </div>
    </header>

    <article class="article-content">
        <p>å½“ä½ ä¿®æ”¹ä¸€ä¸ª State çš„å€¼æ—¶ï¼ŒCompose å¦‚ä½•çŸ¥é“å“ªäº› UI éœ€è¦æ›´æ–°ï¼Ÿæ›´æ–°æ˜¯ç«‹å³æ‰§è¡Œè¿˜æ˜¯å»¶è¿Ÿå¤„ç†ï¼Ÿæœ¬æ–‡å°†æ·±å…¥æ¢ç´¢ Recomposition çš„å®Œæ•´è°ƒåº¦ä¸æ‰§è¡Œæœºåˆ¶ï¼Œä» Snapshot ç³»ç»Ÿåˆ°å¸§åŒæ­¥ï¼Œæ­ç§˜çŠ¶æ€å˜æ›´å¦‚ä½•è§¦å‘ UI æ›´æ–°ã€‚</p>

        <h2>I. é‡ç»„è°ƒåº¦çš„æ•´ä½“æµç¨‹</h2>

        <div class="diagram-box">
<span class="diagram-red">State å˜æ›´</span>
     â”‚
     â–¼
<span class="diagram-warning">Snapshot ç³»ç»Ÿæ£€æµ‹</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                                      â”‚
     â–¼                                                      â”‚
<span class="diagram-accent">æ ‡è®° InvalidationScope</span>                                    â”‚
     â”‚                                                      â”‚
     â–¼                                                      â”‚
<span class="diagram-highlight">Recomposer è°ƒåº¦</span>                                           â”‚
     â”‚                                                      â”‚
     â”œâ”€â”€ åŒä¸€å¸§å†…å¤šæ¬¡å˜æ›´ â”€â”€â†’ <span class="diagram-warning">åˆå¹¶ (Coalescing)</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
<span class="diagram-accent">ç­‰å¾…ä¸‹ä¸€å¸§ (Frame Synchronization)</span>
     â”‚
     â–¼
<span class="diagram-highlight">æ‰§è¡Œ Recomposition</span>
     â”‚
     â”œâ”€â”€ éå†å¤±æ•ˆçš„ Scope
     â”œâ”€â”€ é‡æ–°æ‰§è¡Œ @Composable å‡½æ•°
     â”œâ”€â”€ æ›´æ–° Slot Table
     â””â”€â”€ åº”ç”¨å˜æ›´åˆ° Node Tree
     â”‚
     â–¼
<span class="diagram-red">UI æ¸²æŸ“</span>
        </div>

        <h2>II. Snapshot ç³»ç»Ÿï¼šå˜æ›´æ£€æµ‹</h2>

        <h3>2.1 ä»€ä¹ˆæ˜¯ Snapshot</h3>

        <p>Snapshot ç³»ç»Ÿæ˜¯ Compose çš„å˜æ›´æ£€æµ‹æœºåˆ¶ã€‚å®ƒè¿½è¸ªæ‰€æœ‰ State çš„è¯»å–å’Œå†™å…¥æ“ä½œï¼š</p>

        <pre><code><span class="code-comment">// MutableState çš„ç®€åŒ–å®ç°</span>
<span class="code-keyword">class</span> <span class="code-type">SnapshotMutableStateImpl</span>&lt;<span class="code-type">T</span>&gt;(
    value: <span class="code-type">T</span>
) : <span class="code-type">MutableState</span>&lt;<span class="code-type">T</span>&gt; {
    
    <span class="code-keyword">private var</span> next: <span class="code-type">StateRecord</span>  <span class="code-comment">// çŠ¶æ€è®°å½•é“¾è¡¨</span>
    
    <span class="code-keyword">override var</span> value: <span class="code-type">T</span>
        <span class="code-keyword">get</span>() {
            <span class="code-comment">// è¯»å–æ—¶é€šçŸ¥ Snapshot ç³»ç»Ÿ</span>
            <span class="code-keyword">val</span> snapshot = <span class="code-type">Snapshot</span>.current
            snapshot.<span class="code-func">recordReadOf</span>(<span class="code-keyword">this</span>)  <span class="code-comment">// â† è®°å½•è¯»å–ï¼</span>
            <span class="code-keyword">return</span> <span class="code-func">readable</span>(next, snapshot).value
        }
        <span class="code-keyword">set</span>(newValue) {
            <span class="code-comment">// å†™å…¥æ—¶é€šçŸ¥ Snapshot ç³»ç»Ÿ</span>
            <span class="code-keyword">val</span> snapshot = <span class="code-type">Snapshot</span>.current
            <span class="code-keyword">val</span> record = <span class="code-func">writable</span>(next, snapshot)
            record.value = newValue
            snapshot.<span class="code-func">recordWriteOf</span>(<span class="code-keyword">this</span>)  <span class="code-comment">// â† è®°å½•å†™å…¥ï¼</span>
        }
}</code></pre>

        <h3>2.2 è¯»å–è¿½è¸ª</h3>

        <p>å½“ @Composable å‡½æ•°è¯»å– State æ—¶ï¼ŒSnapshot ç³»ç»Ÿä¼šè®°å½•è¿™ä¸ªä¾èµ–å…³ç³»ï¼š</p>

        <pre><code><span class="code-annotation">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">Counter</span>() {
    <span class="code-comment">// 1. å½“å‰ RecomposeScope è¢«è®°å½•</span>
    <span class="code-keyword">val</span> scope = currentRecomposeScope
    
    <span class="code-comment">// 2. è¯»å– count.value æ—¶ï¼š</span>
    <span class="code-comment">//    Snapshot.recordReadOf(countState)</span>
    <span class="code-comment">//    â†’ å»ºç«‹ countState ä¸ scope çš„å…³è”</span>
    <span class="code-keyword">val</span> count = countState.value
    
    <span class="code-func">Text</span>(<span class="code-string">"Count: $count"</span>)
}

<span class="code-comment">// å†…éƒ¨ç»´æŠ¤çš„ä¾èµ–å›¾:</span>
<span class="code-comment">// countState â†’ [RecomposeScope@Counter]</span>
<span class="code-comment">// å½“ countState å†™å…¥æ—¶ï¼Œé€šçŸ¥ Counter éœ€è¦é‡ç»„</span></code></pre>

        <h3>2.3 å†™å…¥é€šçŸ¥</h3>

        <pre><code><span class="code-comment">// å½“å†™å…¥ State æ—¶</span>
count.value = count.value + <span class="code-string">1</span>

<span class="code-comment">// Snapshot ç³»ç»Ÿæ‰§è¡Œ:</span>
<span class="code-keyword">fun</span> <span class="code-func">recordWriteOf</span>(state: <span class="code-type">StateObject</span>) {
    <span class="code-comment">// 1. æ‰¾åˆ°æ‰€æœ‰è¯»å–è¿‡è¿™ä¸ª State çš„ Scope</span>
    <span class="code-keyword">val</span> scopes = derivedStateObservers[state]
    
    <span class="code-comment">// 2. é€šçŸ¥æ¯ä¸ª Scope å¤±æ•ˆ</span>
    scopes.<span class="code-func">forEach</span> { scope -&gt;
        scope.<span class="code-func">invalidate</span>()
    }
}

<span class="code-comment">// RecomposeScope.invalidate()</span>
<span class="code-keyword">fun</span> <span class="code-func">invalidate</span>() {
    <span class="code-comment">// å°†è‡ªå·±æ·»åŠ åˆ° Composition çš„å¤±æ•ˆåˆ—è¡¨</span>
    composition.<span class="code-func">recordInvalidation</span>(<span class="code-keyword">this</span>)
}</code></pre>

        <h2>III. Recomposerï¼šè°ƒåº¦ä¸­æ¢</h2>

        <h3>3.1 Recomposer çš„è§’è‰²</h3>

        <p>Recomposer æ˜¯é‡ç»„çš„è°ƒåº¦å™¨ï¼Œè´Ÿè´£åè°ƒå¤šä¸ª Composition çš„é‡ç»„æ—¶æœºï¼š</p>

        <pre><code><span class="code-keyword">class</span> <span class="code-type">Recomposer</span>(
    effectCoroutineContext: <span class="code-type">CoroutineContext</span>
) : <span class="code-type">CompositionContext</span>() {
    
    <span class="code-comment">// ç®¡ç†çš„æ‰€æœ‰ Composition</span>
    <span class="code-keyword">private val</span> knownCompositions = <span class="code-func">mutableListOf</span>&lt;<span class="code-type">Composition</span>&gt;()
    
    <span class="code-comment">// éœ€è¦é‡ç»„çš„ Composition</span>
    <span class="code-keyword">private val</span> compositionsNeedingRecompose = 
        <span class="code-func">mutableSetOf</span>&lt;<span class="code-type">Composition</span>&gt;()
    
    <span class="code-comment">// å¸§è°ƒåº¦å™¨</span>
    <span class="code-keyword">private val</span> broadcastFrameClock: <span class="code-type">BroadcastFrameClock</span>
    
    <span class="code-comment">// è¿è¡Œé‡ç»„å¾ªç¯</span>
    <span class="code-keyword">suspend fun</span> <span class="code-func">runRecomposeAndApplyChanges</span>() {
        <span class="code-comment">// æ— é™å¾ªç¯ï¼Œç­‰å¾…å¸§ä¿¡å·</span>
        <span class="code-keyword">while</span> (<span class="code-string">true</span>) {
            <span class="code-comment">// ç­‰å¾…ä¸‹ä¸€å¸§</span>
            broadcastFrameClock.<span class="code-func">awaitFrame</span>()
            
            <span class="code-comment">// æ‰§è¡Œæ‰€æœ‰å¾…å¤„ç†çš„é‡ç»„</span>
            <span class="code-func">performRecompose</span>()
        }
    }
}</code></pre>

        <h3>3.2 å¸§åŒæ­¥æœºåˆ¶</h3>

        <div class="diagram-box">
Android å¸§è°ƒåº¦ (16.6ms @ 60fps):

Frame N                          Frame N+1                        Frame N+2
    â”‚                                â”‚                                â”‚
    â–¼                                â–¼                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Input                 â”‚    â”‚ Input                 â”‚    â”‚ Input                 â”‚
â”‚ Animation             â”‚    â”‚ Animation             â”‚    â”‚ Animation             â”‚
â”‚ <span class="diagram-highlight">Recomposition</span>         â”‚    â”‚ <span class="diagram-highlight">Recomposition</span>         â”‚    â”‚ <span class="diagram-highlight">Recomposition</span>         â”‚
â”‚ Layout                â”‚    â”‚ Layout                â”‚    â”‚ Layout                â”‚
â”‚ Draw                  â”‚    â”‚ Draw                  â”‚    â”‚ Draw                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                            â”‚
    â”‚  <span class="diagram-warning">State å˜æ›´å‘ç”Ÿåœ¨è¿™é‡Œ</span>      â”‚
    â”‚  <span class="diagram-warning">â†“</span>                         â”‚
    â”‚  count = 1                 â”‚
    â”‚  count = 2  <span class="diagram-accent">â† åŒå¸§å¤šæ¬¡å˜æ›´</span>   â”‚
    â”‚  count = 3  <span class="diagram-accent">â† ä¼šè¢«åˆå¹¶!</span>     â”‚
    â”‚                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              <span class="diagram-highlight">ä¸‹ä¸€å¸§æ‰æ‰§è¡Œé‡ç»„</span>
              <span class="diagram-highlight">åªé‡ç»„ä¸€æ¬¡ï¼Œä½¿ç”¨æœ€æ–°å€¼ count=3</span>
        </div>

        <h3>3.3 å˜æ›´åˆå¹¶ (Coalescing)</h3>

        <pre><code><span class="code-annotation">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">BatchUpdates</span>() {
    <span class="code-keyword">var</span> a <span class="code-keyword">by</span> <span class="code-func">remember</span> { <span class="code-func">mutableStateOf</span>(<span class="code-string">0</span>) }
    <span class="code-keyword">var</span> b <span class="code-keyword">by</span> <span class="code-func">remember</span> { <span class="code-func">mutableStateOf</span>(<span class="code-string">0</span>) }
    
    <span class="code-func">Button</span>(onClick = {
        <span class="code-comment">// è¿™ä¸‰ä¸ªå˜æ›´éƒ½åœ¨åŒä¸€å¸§å†…</span>
        a = <span class="code-string">1</span>  <span class="code-comment">// æ ‡è®°å¤±æ•ˆ</span>
        b = <span class="code-string">1</span>  <span class="code-comment">// æ ‡è®°å¤±æ•ˆ</span>
        a = <span class="code-string">2</span>  <span class="code-comment">// å·²å¤±æ•ˆï¼Œä¸é‡å¤æ ‡è®°</span>
        <span class="code-comment">// åªä¼šè§¦å‘ä¸€æ¬¡é‡ç»„ï¼</span>
    }) {
        <span class="code-func">Text</span>(<span class="code-string">"a=$a, b=$b"</span>)
    }
}</code></pre>

        <div class="tip-box info">
            <div class="tip-title">ğŸ”„ åˆå¹¶çš„æ„ä¹‰</div>
            <p>å˜æ›´åˆå¹¶æ˜¯é‡è¦çš„æ€§èƒ½ä¼˜åŒ–ã€‚æ— è®ºä¸€å¸§å†…å‘ç”Ÿå¤šå°‘æ¬¡çŠ¶æ€å˜æ›´ï¼ŒCompose éƒ½åªåœ¨å¸§ç»“æŸæ—¶æ‰§è¡Œä¸€æ¬¡é‡ç»„ã€‚è¿™é¿å…äº†ä¸­é—´çŠ¶æ€å¯¼è‡´çš„æ— æ•ˆæ¸²æŸ“ã€‚</p>
        </div>

        <h2>IV. InvalidationScopeï¼šå¤±æ•ˆè¿½è¸ª</h2>

        <h3>4.1 RecomposeScope çš„åˆ›å»º</h3>

        <pre><code><span class="code-comment">// æ¯ä¸ª @Composable å‡½æ•°ç¼–è¯‘åä¼šåŒ…å« RecomposeScope</span>
<span class="code-keyword">fun</span> <span class="code-func">Counter</span>($composer: <span class="code-type">Composer</span>, $changed: <span class="code-type">Int</span>) {
    <span class="code-comment">// å¼€å§‹ä¸€ä¸ªå¯é‡ç»„çš„ä½œç”¨åŸŸ</span>
    $composer.<span class="code-func">startRestartGroup</span>(<span class="code-string">123</span>)  <span class="code-comment">// key = 123</span>
    
    <span class="code-comment">// ... å‡½æ•°ä½“ ...</span>
    
    <span class="code-comment">// ç»“æŸä½œç”¨åŸŸï¼Œè¿”å› ScopeUpdateScope</span>
    <span class="code-keyword">val</span> scope = $composer.<span class="code-func">endRestartGroup</span>()
    
    <span class="code-comment">// æ³¨å†Œé‡ç»„å›è°ƒ</span>
    scope?.<span class="code-func">updateScope</span> { nextComposer, force -&gt;
        <span class="code-comment">// å½“éœ€è¦é‡ç»„æ—¶ï¼Œé‡æ–°è°ƒç”¨æ­¤å‡½æ•°</span>
        <span class="code-func">Counter</span>(nextComposer, $changed or <span class="code-string">1</span>)
    }
}</code></pre>

        <h3>4.2 å¤±æ•ˆä¼ æ’­</h3>

        <div class="diagram-box">
ç»„ä»¶æ ‘ç»“æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         <span class="diagram-highlight">App</span>                                â”‚
â”‚                          â”‚                                  â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚            â”‚                           â”‚                    â”‚
â”‚         <span class="diagram-accent">Screen</span>                      <span class="diagram-accent">Header</span>                  â”‚
â”‚            â”‚                           â”‚                    â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                    â”‚                    â”‚
â”‚     â”‚             â”‚                    â”‚                    â”‚
â”‚  <span class="diagram-warning">Counter</span>       <span class="diagram-accent">List</span>               <span class="diagram-accent">Title</span>                  â”‚
â”‚     â”‚                                                       â”‚
â”‚ <span class="diagram-red">count State</span>                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å½“ count å˜æ›´æ—¶:
1. count State é€šçŸ¥ Snapshot ç³»ç»Ÿ
2. Snapshot æ‰¾åˆ°è¯»å– count çš„ <span class="diagram-warning">Counter</span> Scope
3. æ ‡è®° <span class="diagram-warning">Counter</span> ä¸ºå¤±æ•ˆ
4. <span class="diagram-highlight">åªæœ‰ Counter éœ€è¦é‡ç»„!</span>
   (Screen, Header, List, Title éƒ½ä¸å—å½±å“)
        </div>

        <h3>4.3 æœ€å°é‡ç»„èŒƒå›´</h3>

        <pre><code><span class="code-annotation">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">Parent</span>() {
    <span class="code-keyword">var</span> count <span class="code-keyword">by</span> <span class="code-func">remember</span> { <span class="code-func">mutableStateOf</span>(<span class="code-string">0</span>) }
    
    <span class="code-func">println</span>(<span class="code-string">"Parent recomposing"</span>)  <span class="code-comment">// ä¼šæ‰“å°</span>
    
    <span class="code-func">Column</span> {
        <span class="code-func">Text</span>(<span class="code-string">"Count: $count"</span>)  <span class="code-comment">// è¯»å– count</span>
        
        <span class="code-func">ExpensiveChild</span>()  <span class="code-comment">// ä¸è¯»å– count</span>
    }
    
    <span class="code-func">Button</span>(onClick = { count++ }) {
        <span class="code-func">Text</span>(<span class="code-string">"+"</span>)
    }
}

<span class="code-annotation">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">ExpensiveChild</span>() {
    <span class="code-func">println</span>(<span class="code-string">"ExpensiveChild recomposing"</span>)  <span class="code-comment">// ä¹Ÿä¼šæ‰“å°ï¼</span>
    <span class="code-comment">// ...</span>
}

<span class="code-comment">// é—®é¢˜ï¼šExpensiveChild ä¹Ÿé‡ç»„äº†ï¼Œå› ä¸ºå®ƒåœ¨ Parent çš„ä½œç”¨åŸŸå†…</span></code></pre>

        <div class="tip-box warning">
            <div class="tip-title">âš ï¸ Lambda é™·é˜±</div>
            <p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>ExpensiveChild()</code> è™½ç„¶ä¸è¯»å– countï¼Œä½†å®ƒåœ¨ Parent çš„ä½œç”¨åŸŸå†…ã€‚Parent é‡ç»„æ—¶ï¼Œä¼šé‡æ–°æ‰§è¡Œæ•´ä¸ªå‡½æ•°ä½“ï¼ŒåŒ…æ‹¬ ExpensiveChild çš„è°ƒç”¨ã€‚</p>
        </div>

        <h3>4.4 ä¼˜åŒ–ï¼šä½¿ç”¨ Lambda éš”ç¦»</h3>

        <pre><code><span class="code-annotation">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">OptimizedParent</span>() {
    <span class="code-keyword">var</span> count <span class="code-keyword">by</span> <span class="code-func">remember</span> { <span class="code-func">mutableStateOf</span>(<span class="code-string">0</span>) }
    
    <span class="code-func">Column</span> {
        <span class="code-comment">// å°† count è¯»å–é™åˆ¶åœ¨æœ€å°èŒƒå›´</span>
        <span class="code-func">CountDisplay</span>(count)  <span class="code-comment">// åªæœ‰è¿™é‡Œè¯»å– count</span>
        
        <span class="code-func">ExpensiveChild</span>()  <span class="code-comment">// ä¸ä¼šé‡ç»„ï¼</span>
    }
    
    <span class="code-func">Button</span>(onClick = { count++ }) {
        <span class="code-func">Text</span>(<span class="code-string">"+"</span>)
    }
}

<span class="code-annotation">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">CountDisplay</span>(count: <span class="code-type">Int</span>) {  <span class="code-comment">// å‚æ•°ä¼ é€’ï¼Œéç›´æ¥è¯»å–</span>
    <span class="code-func">Text</span>(<span class="code-string">"Count: $count"</span>)
}

<span class="code-comment">// ç°åœ¨åªæœ‰ CountDisplay ä¼šé‡ç»„</span>
<span class="code-comment">// ExpensiveChild çš„å‚æ•°æœªå˜ï¼Œä¼šè¢«è·³è¿‡</span></code></pre>

        <h2>V. æ‰§è¡Œé˜¶æ®µè¯¦è§£</h2>

        <h3>5.1 é‡ç»„æ‰§è¡Œæµç¨‹</h3>

        <pre><code><span class="code-keyword">internal fun</span> <span class="code-func">performRecompose</span>() {
    <span class="code-comment">// 1. è·å–éœ€è¦é‡ç»„çš„ Composition åˆ—è¡¨</span>
    <span class="code-keyword">val</span> toRecompose = compositionsNeedingRecompose.<span class="code-func">toList</span>()
    compositionsNeedingRecompose.<span class="code-func">clear</span>()
    
    <span class="code-comment">// 2. å¯¹æ¯ä¸ª Composition æ‰§è¡Œé‡ç»„</span>
    <span class="code-keyword">for</span> (composition <span class="code-keyword">in</span> toRecompose) {
        <span class="code-comment">// 2.1 è·å–å¤±æ•ˆçš„ Scope åˆ—è¡¨</span>
        <span class="code-keyword">val</span> invalidScopes = composition.<span class="code-func">takeInvalidations</span>()
        
        <span class="code-comment">// 2.2 æŒ‰ä½ç½®æ’åºï¼ˆæ·±åº¦ä¼˜å…ˆé¡ºåºï¼‰</span>
        invalidScopes.<span class="code-func">sortBy</span> { it.position }
        
        <span class="code-comment">// 2.3 æ‰§è¡Œæ¯ä¸ªå¤±æ•ˆ Scope çš„é‡ç»„</span>
        <span class="code-keyword">for</span> (scope <span class="code-keyword">in</span> invalidScopes) {
            <span class="code-keyword">if</span> (!scope.isValid) <span class="code-keyword">continue</span>  <span class="code-comment">// å¯èƒ½å·²è¢«çˆ¶çº§è¦†ç›–</span>
            
            <span class="code-comment">// è°ƒç”¨ scope æ³¨å†Œçš„ updateScope lambda</span>
            scope.<span class="code-func">recompose</span>()
        }
        
        <span class="code-comment">// 2.4 åº”ç”¨å˜æ›´åˆ° Node Tree</span>
        composition.<span class="code-func">applyChanges</span>()
    }
    
    <span class="code-comment">// 3. æ‰§è¡Œ Side Effects</span>
    <span class="code-func">runSideEffects</span>()
}</code></pre>

        <h3>5.2 è·³è¿‡æœºåˆ¶ (Skipping)</h3>

        <pre><code><span class="code-comment">// Composer çš„è·³è¿‡é€»è¾‘</span>
<span class="code-keyword">fun</span> <span class="code-func">startRestartGroup</span>(key: <span class="code-type">Int</span>): <span class="code-type">Composer</span> {
    <span class="code-comment">// æ£€æŸ¥æ˜¯å¦å¯ä»¥è·³è¿‡</span>
    skipping = !inserting && 
               !currentScope.isInvalidated && 
               <span class="code-func">allParametersUnchanged</span>()
    
    <span class="code-keyword">return this</span>
}

<span class="code-comment">// ç¼–è¯‘åçš„ä»£ç ä¼šæ£€æŸ¥ skipping</span>
<span class="code-keyword">fun</span> <span class="code-func">MyComponent</span>(param: <span class="code-type">String</span>, $composer: <span class="code-type">Composer</span>, $changed: <span class="code-type">Int</span>) {
    $composer.<span class="code-func">startRestartGroup</span>(<span class="code-string">123</span>)
    
    <span class="code-keyword">if</span> ($composer.skipping) {
        <span class="code-comment">// è·³è¿‡æ•´ä¸ªå‡½æ•°ä½“ï¼</span>
        $composer.<span class="code-func">skipToGroupEnd</span>()
    } <span class="code-keyword">else</span> {
        <span class="code-comment">// æ‰§è¡Œå‡½æ•°ä½“</span>
        <span class="code-func">Text</span>(param, $composer, <span class="code-string">0</span>)
    }
    
    $composer.<span class="code-func">endRestartGroup</span>()
}</code></pre>

        <h3>5.3 $changed å‚æ•°</h3>

        <p>ç¼–è¯‘å™¨ç”Ÿæˆçš„ <code>$changed</code> å‚æ•°ç”¨äºå¿«é€Ÿåˆ¤æ–­å‚æ•°æ˜¯å¦å˜åŒ–ï¼š</p>

        <pre><code><span class="code-comment">// $changed æ˜¯ä¸€ä¸ªä½æ©ç </span>
<span class="code-comment">// æ¯ä¸ªå‚æ•°å ç”¨ 3 ä½ï¼š</span>
<span class="code-comment">//   - bit 0: å€¼æ˜¯å¦å˜åŒ–</span>
<span class="code-comment">//   - bit 1: æ˜¯å¦æ˜¯ç¨³å®šç±»å‹</span>
<span class="code-comment">//   - bit 2: æ˜¯å¦å·²æ£€æŸ¥è¿‡</span>

<span class="code-keyword">fun</span> <span class="code-func">Profile</span>(
    name: <span class="code-type">String</span>,      <span class="code-comment">// å‚æ•° 1: bits 0-2</span>
    age: <span class="code-type">Int</span>,          <span class="code-comment">// å‚æ•° 2: bits 3-5</span>
    avatar: <span class="code-type">ImageUrl</span>,  <span class="code-comment">// å‚æ•° 3: bits 6-8</span>
    $composer: <span class="code-type">Composer</span>,
    $changed: <span class="code-type">Int</span>
) {
    <span class="code-comment">// æ£€æŸ¥ name æ˜¯å¦å˜åŒ–</span>
    <span class="code-keyword">val</span> nameChanged = ($changed and <span class="code-string">0b001</span>) != <span class="code-string">0</span>
    
    <span class="code-comment">// æ£€æŸ¥ age æ˜¯å¦å˜åŒ–</span>
    <span class="code-keyword">val</span> ageChanged = ($changed and <span class="code-string">0b001000</span>) != <span class="code-string">0</span>
    
    <span class="code-comment">// åªæœ‰å…¨éƒ¨å‚æ•°æœªå˜åŒ–æ—¶æ‰èƒ½è·³è¿‡</span>
    <span class="code-keyword">if</span> (!nameChanged && !ageChanged && !avatarChanged) {
        $composer.<span class="code-func">skipToGroupEnd</span>()
        <span class="code-keyword">return</span>
    }
    
    <span class="code-comment">// æ‰§è¡Œé‡ç»„...</span>
}</code></pre>

        <h2>VI. Side Effects çš„æ‰§è¡Œæ—¶æœº</h2>

        <h3>6.1 Effect è°ƒåº¦</h3>

        <pre><code><span class="code-comment">// Side Effects åœ¨é‡ç»„å®Œæˆåæ‰§è¡Œ</span>
<span class="code-keyword">private fun</span> <span class="code-func">runSideEffects</span>() {
    <span class="code-comment">// 1. æ‰§è¡Œ SideEffect (åŒæ­¥)</span>
    pendingSideEffects.<span class="code-func">forEach</span> { it() }
    pendingSideEffects.<span class="code-func">clear</span>()
    
    <span class="code-comment">// 2. å¯åŠ¨ LaunchedEffect åç¨‹</span>
    pendingLaunchedEffects.<span class="code-func">forEach</span> { effect -&gt;
        effectScope.<span class="code-func">launch</span> { effect() }
    }
    pendingLaunchedEffects.<span class="code-func">clear</span>()
}</code></pre>

        <h3>6.2 Effect æ‰§è¡Œé¡ºåº</h3>

        <div class="diagram-box">
å¸§å†…æ‰§è¡Œé¡ºåº:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Frame N                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. <span class="diagram-highlight">Recomposition</span>                                               â”‚
â”‚    â””â”€â”€ æ‰§è¡Œ @Composable å‡½æ•°                                    â”‚
â”‚    â””â”€â”€ æ›´æ–° Slot Table                                          â”‚
â”‚    â””â”€â”€ è®°å½•å¾…æ‰§è¡Œçš„ Effects                                      â”‚
â”‚                                                                 â”‚
â”‚ 2. <span class="diagram-accent">Apply Changes</span>                                               â”‚
â”‚    â””â”€â”€ æ›´æ–° Node Tree                                           â”‚
â”‚                                                                 â”‚
â”‚ 3. <span class="diagram-warning">Side Effects</span>                                                â”‚
â”‚    â””â”€â”€ SideEffect { } åŒæ­¥æ‰§è¡Œ                                  â”‚
â”‚    â””â”€â”€ LaunchedEffect å¯åŠ¨åç¨‹                                   â”‚
â”‚    â””â”€â”€ DisposableEffect onDispose æ¸…ç†                          â”‚
â”‚                                                                 â”‚
â”‚ 4. <span class="diagram-red">Layout & Draw</span>                                               â”‚
â”‚    â””â”€â”€ æµ‹é‡ã€å¸ƒå±€ã€ç»˜åˆ¶                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        </div>

        <h2>VII. é«˜çº§è°ƒåº¦åœºæ™¯</h2>

        <h3>7.1 åµŒå¥—é‡ç»„</h3>

        <pre><code><span class="code-annotation">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">NestedRecomposition</span>() {
    <span class="code-keyword">var</span> a <span class="code-keyword">by</span> <span class="code-func">remember</span> { <span class="code-func">mutableStateOf</span>(<span class="code-string">0</span>) }
    
    <span class="code-func">Column</span> {
        <span class="code-func">Text</span>(<span class="code-string">"a = $a"</span>)
        
        <span class="code-comment">// å­ç»„ä»¶åœ¨é‡ç»„æœŸé—´ä¿®æ”¹çŠ¶æ€</span>
        <span class="code-func">ChildThatModifiesState</span> {
            <span class="code-comment">// è¿™ä¼šè§¦å‘æ–°çš„å¤±æ•ˆ</span>
            <span class="code-comment">// ä½†ä¼šè¢«å»¶è¿Ÿåˆ°ä¸‹ä¸€å¸§</span>
            a = <span class="code-string">1</span>
        }
    }
}

<span class="code-comment">// Compose ä¸å…è®¸åœ¨é‡ç»„æœŸé—´ç›´æ¥ä¿®æ”¹å¯¼è‡´æ–°é‡ç»„</span>
<span class="code-comment">// å˜æ›´ä¼šè¢«æ”¶é›†ï¼Œåœ¨å½“å‰é‡ç»„å®Œæˆåå¤„ç†</span></code></pre>

        <h3>7.2 derivedStateOf ä¼˜åŒ–</h3>

        <pre><code><span class="code-annotation">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">FilteredList</span>(items: <span class="code-type">List</span>&lt;<span class="code-type">Item</span>&gt;, filter: <span class="code-type">String</span>) {
    <span class="code-comment">// ä¸ä½¿ç”¨ derivedStateOfï¼šæ¯æ¬¡ items æˆ– filter å˜åŒ–éƒ½é‡ç»„</span>
    <span class="code-keyword">val</span> filtered = items.<span class="code-func">filter</span> { it.name.<span class="code-func">contains</span>(filter) }
    
    <span class="code-comment">// ä½¿ç”¨ derivedStateOfï¼šåªæœ‰ç»“æœå˜åŒ–æ—¶æ‰é‡ç»„</span>
    <span class="code-keyword">val</span> filtered <span class="code-keyword">by</span> <span class="code-func">remember</span>(items, filter) {
        <span class="code-func">derivedStateOf</span> {
            items.<span class="code-func">filter</span> { it.name.<span class="code-func">contains</span>(filter) }
        }
    }
    
    <span class="code-comment">// å‡è®¾ items = [A, B, C], filter = "A"</span>
    <span class="code-comment">// ç»“æœ = [A]</span>
    <span class="code-comment">// å¦‚æœ items å˜ä¸º [A, B, C, D]ï¼Œfilter ä¸å˜</span>
    <span class="code-comment">// ç»“æœä»ç„¶ = [A]ï¼Œä¸è§¦å‘é‡ç»„ï¼</span>
    
    <span class="code-func">LazyColumn</span> {
        <span class="code-func">items</span>(filtered) { <span class="code-func">ItemRow</span>(it) }
    }
}</code></pre>

        <h3>7.3 å¿«ç…§éš”ç¦»</h3>

        <pre><code><span class="code-comment">// ä½¿ç”¨ Snapshot.withMutableSnapshot æ‰¹é‡æ›´æ–°</span>
<span class="code-keyword">fun</span> <span class="code-func">batchUpdate</span>() {
    <span class="code-type">Snapshot</span>.<span class="code-func">withMutableSnapshot</span> {
        <span class="code-comment">// è¿™äº›å˜æ›´åœ¨å¿«ç…§å†…æ˜¯éš”ç¦»çš„</span>
        state1.value = <span class="code-string">1</span>
        state2.value = <span class="code-string">2</span>
        state3.value = <span class="code-string">3</span>
        
        <span class="code-comment">// å¿«ç…§ç»“æŸæ—¶ï¼Œæ‰€æœ‰å˜æ›´ä¸€èµ·åº”ç”¨</span>
        <span class="code-comment">// åªè§¦å‘ä¸€æ¬¡å¤±æ•ˆé€šçŸ¥</span>
    }
}</code></pre>

        <h2>VIII. è°ƒè¯•é‡ç»„</h2>

        <h3>8.1 é‡ç»„è®¡æ•°</h3>

        <pre><code><span class="code-annotation">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">RecompositionCounter</span>(label: <span class="code-type">String</span>) {
    <span class="code-keyword">val</span> count = <span class="code-func">remember</span> { <span class="code-func">mutableIntStateOf</span>(<span class="code-string">0</span>) }
    
    <span class="code-func">SideEffect</span> {
        count.intValue++
        <span class="code-func">println</span>(<span class="code-string">"$label recomposed ${count.intValue} times"</span>)
    }
}</code></pre>

        <h3>8.2 Layout Inspector</h3>

        <p>Android Studio çš„ Layout Inspector å¯ä»¥æ˜¾ç¤ºï¼š</p>
        <ul>
            <li>é‡ç»„æ¬¡æ•°é«˜äº®</li>
            <li>Composition æ ‘ç»“æ„</li>
            <li>å„ç»„ä»¶çš„é‡ç»„è®¡æ•°</li>
        </ul>

        <h2>IX. æ€»ç»“</h2>

        <div class="tip-box success">
            <div class="tip-title">ğŸ¯ æ ¸å¿ƒè¦ç‚¹</div>
            <ul>
                <li><strong>Snapshot ç³»ç»Ÿ</strong> è¿½è¸ª State çš„è¯»å–å’Œå†™å…¥</li>
                <li><strong>InvalidationScope</strong> ç²¾ç¡®æ ‡è®°éœ€è¦é‡ç»„çš„èŒƒå›´</li>
                <li><strong>Recomposer</strong> è°ƒåº¦é‡ç»„ï¼Œä¸å¸§åŒæ­¥</li>
                <li><strong>å˜æ›´åˆå¹¶</strong>ï¼šåŒå¸§å†…å¤šæ¬¡å˜æ›´åªè§¦å‘ä¸€æ¬¡é‡ç»„</li>
                <li><strong>Skipping</strong>ï¼šå‚æ•°æœªå˜åŒ–çš„ç»„ä»¶è‡ªåŠ¨è·³è¿‡</li>
                <li><strong>Side Effects</strong> åœ¨é‡ç»„å®Œæˆåæ‰§è¡Œ</li>
            </ul>
        </div>

        <p>ç†è§£é‡ç»„è°ƒåº¦æœºåˆ¶ï¼Œèƒ½å¤Ÿå¸®åŠ©ä½ ï¼š</p>
        <ul>
            <li>å†™å‡ºæ›´é«˜æ•ˆçš„ Composable å‡½æ•°</li>
            <li>é¿å…ä¸å¿…è¦çš„é‡ç»„</li>
            <li>æ­£ç¡®ä½¿ç”¨ derivedStateOf ç­‰ä¼˜åŒ– API</li>
            <li>è°ƒè¯•æ€§èƒ½é—®é¢˜</li>
        </ul>
    </article>

    <footer class="footer">
        <p>Â© 2024 Fidroid - ä¸“æ³¨ Android ä¸ Jetpack Compose</p>
    </footer>
</body>
</html>

