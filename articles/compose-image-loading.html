<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compose 图片加载最佳实践：Coil 集成与缓存策略 - Fidroid</title>
    <meta name="description" content="深入学习 Coil 图片加载库在 Compose 中的使用，掌握 AsyncImage、缓存策略、图片变换等最佳实践。">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.8; color: #e5e7eb; background: #020617; }
        .navbar { background: rgba(15,23,42,0.98); backdrop-filter: blur(10px); position: fixed; top: 0; width: 100%; z-index: 1000; }
        .nav-container { max-width: 900px; margin: 0 auto; padding: 1rem 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: bold; color: #38bdf8; text-decoration: none; letter-spacing: 0.08em; text-transform: uppercase; }
        .back-link { color: #9ca3af; text-decoration: none; font-size: 0.9rem; }
        .back-link:hover { color: #38bdf8; }
        .article-header { padding: 120px 20px 60px; background: radial-gradient(circle at top left, #10b981 0, transparent 50%), radial-gradient(circle at bottom right, #3b82f6 0, transparent 55%), #020617; text-align: center; }
        .article-header h1 { max-width: 800px; margin: 0 auto 1rem; font-size: 2.5rem; font-weight: 800; letter-spacing: -0.03em; color: #fff; }
        .article-meta { color: #9ca3af; font-size: 0.9rem; margin-bottom: 1.5rem; }
        .article-tags { display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem; }
        .article-tag { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; background: rgba(15,23,42,0.85); border: 1px solid rgba(16,185,129,0.4); color: #34d399; }
        .article-content { max-width: 800px; margin: 0 auto; padding: 60px 20px 80px; }
        .article-content h2 { font-size: 1.6rem; margin: 2.5rem 0 1rem; color: #f9fafb; border-left: 4px solid #10b981; padding-left: 1rem; }
        .article-content h3 { font-size: 1.25rem; margin: 2rem 0 0.75rem; color: #e5e7eb; }
        .article-content p { margin-bottom: 1.25rem; color: #d1d5db; }
        .article-content ul { margin: 1rem 0 1.5rem 1.5rem; color: #d1d5db; }
        .article-content li { margin-bottom: 0.5rem; }
        .article-content strong { color: #f9fafb; }
        pre { background: #0f172a; border: 1px solid rgba(16,185,129,0.3); border-radius: 12px; padding: 1.25rem; overflow-x: auto; margin: 1.5rem 0; font-size: 0.85rem; line-height: 1.6; }
        code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; color: #e5e7eb; }
        .code-keyword { color: #c084fc; }
        .code-func { color: #38bdf8; }
        .code-type { color: #4ade80; }
        .code-string { color: #fb7185; }
        .code-comment { color: #6b7280; font-style: italic; }
        .footer { background: #020617; border-top: 1px solid #111827; padding: 2rem; text-align: center; color: #6b7280; }
        .footer a { color: #38bdf8; text-decoration: none; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="logo">Fidroid</a>
            <a href="../index.html#articles" class="back-link">← 返回博客列表</a>
        </div>
    </nav>

    <header class="article-header">
        <h1>Compose 图片加载最佳实践：Coil 集成与缓存策略</h1>
        <p class="article-meta">2024-05-24 · 22 min · 图片加载</p>
        <div class="article-tags">
            <span class="article-tag">Coil</span>
            <span class="article-tag">AsyncImage</span>
            <span class="article-tag">图片加载</span>
            <span class="article-tag">缓存</span>
        </div>
    </header>

    <article class="article-content">
        <p>图片加载是移动应用中最常见的需求之一。Coil（Coroutine Image Loader）是专为 Kotlin 和 Compose 设计的现代图片加载库，提供了简洁的 API 和出色的性能。</p>

        <h2>一、AsyncImage 基础</h2>
<pre><code><span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">SimpleImage</span>(url: <span class="code-type">String</span>) {
    <span class="code-func">AsyncImage</span>(
        model = url,
        contentDescription = <span class="code-string">"图片描述"</span>,
        modifier = <span class="code-type">Modifier</span>.<span class="code-func">size</span>(<span class="code-number">200</span>.dp)
    )
}</code></pre>

        <h3>完整配置</h3>
<pre><code><span class="code-func">AsyncImage</span>(
    model = <span class="code-func">ImageRequest.Builder</span>(<span class="code-func">LocalContext</span>.current)
        .<span class="code-func">data</span>(url)
        .<span class="code-func">crossfade</span>(<span class="code-keyword">true</span>)
        .<span class="code-func">build</span>(),
    contentDescription = <span class="code-string">"图片"</span>,
    modifier = <span class="code-type">Modifier</span>
        .<span class="code-func">fillMaxWidth</span>()
        .<span class="code-func">clip</span>(<span class="code-func">RoundedCornerShape</span>(<span class="code-number">12</span>.dp)),
    contentScale = <span class="code-type">ContentScale</span>.Crop,
    placeholder = <span class="code-func">painterResource</span>(R.drawable.placeholder),
    error = <span class="code-func">painterResource</span>(R.drawable.error)
)</code></pre>

        <h2>二、SubcomposeAsyncImage</h2>
<pre><code><span class="code-func">SubcomposeAsyncImage</span>(
    model = url,
    contentDescription = <span class="code-string">"图片"</span>
) {
    <span class="code-keyword">when</span> (painter.state) {
        <span class="code-keyword">is</span> <span class="code-type">AsyncImagePainter.State</span>.Loading -> {
            <span class="code-func">CircularProgressIndicator</span>()
        }
        <span class="code-keyword">is</span> <span class="code-type">AsyncImagePainter.State</span>.Error -> {
            <span class="code-func">Icon</span>(<span class="code-type">Icons</span>.Default.BrokenImage, <span class="code-string">"加载失败"</span>)
        }
        <span class="code-keyword">else</span> -> {
            <span class="code-func">SubcomposeAsyncImageContent</span>()
        }
    }
}</code></pre>

        <h2>三、图片变换</h2>
<pre><code><span class="code-func">AsyncImage</span>(
    model = <span class="code-func">ImageRequest.Builder</span>(context)
        .<span class="code-func">data</span>(url)
        .<span class="code-func">transformations</span>(
            <span class="code-func">CircleCropTransformation</span>(),
            <span class="code-func">RoundedCornersTransformation</span>(<span class="code-number">16f</span>),
            <span class="code-func">BlurTransformation</span>(context, radius = <span class="code-number">10f</span>)
        )
        .<span class="code-func">build</span>(),
    contentDescription = <span class="code-keyword">null</span>
)</code></pre>

        <h2>四、缓存策略</h2>
<pre><code><span class="code-func">AsyncImage</span>(
    model = <span class="code-func">ImageRequest.Builder</span>(context)
        .<span class="code-func">data</span>(url)
        .<span class="code-func">memoryCachePolicy</span>(<span class="code-type">CachePolicy</span>.ENABLED)
        .<span class="code-func">diskCachePolicy</span>(<span class="code-type">CachePolicy</span>.ENABLED)
        .<span class="code-func">networkCachePolicy</span>(<span class="code-type">CachePolicy</span>.ENABLED)
        .<span class="code-func">build</span>(),
    contentDescription = <span class="code-keyword">null</span>
)</code></pre>

        <h2>五、预加载</h2>
<pre><code><span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">PreloadImages</span>(urls: <span class="code-type">List</span>&lt;<span class="code-type">String</span>&gt;) {
    <span class="code-keyword">val</span> context = <span class="code-func">LocalContext</span>.current
    <span class="code-keyword">val</span> imageLoader = <span class="code-func">LocalImageLoader</span>.current
    
    <span class="code-func">LaunchedEffect</span>(urls) {
        urls.<span class="code-func">forEach</span> { url ->
            <span class="code-keyword">val</span> request = <span class="code-func">ImageRequest.Builder</span>(context)
                .<span class="code-func">data</span>(url)
                .<span class="code-func">build</span>()
            imageLoader.<span class="code-func">enqueue</span>(request)
        }
    }
}</code></pre>

        <h2>六、最佳实践</h2>
        <ul>
            <li>✅ 在 Application 中配置全局 ImageLoader</li>
            <li>✅ 为列表项指定 key 以优化重组</li>
            <li>✅ 使用占位符避免布局跳动</li>
            <li>✅ 指定图片尺寸避免内存浪费</li>
            <li>✅ 使用 crossfade 提升用户体验</li>
            <li>✅ 处理加载错误并提供重试机制</li>
        </ul>

        <h2>总结</h2>
        <ul>
            <li><strong>AsyncImage</strong>：声明式图片加载</li>
            <li><strong>SubcomposeAsyncImage</strong>：自定义加载状态</li>
            <li><strong>变换</strong>：圆形、圆角、模糊</li>
            <li><strong>缓存</strong>：内存 + 磁盘缓存</li>
            <li><strong>预加载</strong>：提前加载图片</li>
        </ul>
    </article>

    <footer class="footer">
        <p>&copy; 2024 Fidroid. <a href="../index.html">返回首页</a></p>
    </footer>
</body>
</html>

