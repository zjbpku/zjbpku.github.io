<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jetpack Glance æ·±åº¦è§£æï¼šç”¨ Compose æ„å»ºæ¡Œé¢å°éƒ¨ä»¶ - Fidroid</title>
    <meta name="description" content="æ·±å…¥è§£æ Jetpack Glance æ¡†æ¶ï¼Œæ¶µç›–æ ¸å¿ƒæ¶æ„ã€ç»„ä»¶è¯¦è§£ã€çŠ¶æ€ç®¡ç†ã€Action ç³»ç»Ÿã€å“åº”å¼è®¾è®¡ç­‰å…¨æ–¹ä½å†…å®¹ã€‚">
    <style>

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.8; color: #e5e7eb; background: #020617; }
        .navbar { background: rgba(15,23,42,0.98); backdrop-filter: blur(10px); position: fixed; top: 0; width: 100%; z-index: 1000; }
        .nav-container { max-width: 900px; margin: 0 auto; padding: 1rem 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: bold; color: #38bdf8; text-decoration: none; letter-spacing: 0.08em; text-transform: uppercase; }
        .back-link { color: #9ca3af; text-decoration: none; font-size: 0.9rem; }
        .back-link:hover { color: #38bdf8; }
        .article-header { padding: 120px 20px 60px; background: radial-gradient(circle at top left, #dc2626 0, transparent 50%), radial-gradient(circle at bottom right, #7c3aed 0, transparent 55%), #020617; text-align: center; }
        .article-header h1 { max-width: 800px; margin: 0 auto 1rem; font-size: 2.5rem; font-weight: 800; letter-spacing: -0.03em; color: #fff; }
        .article-meta { color: #9ca3af; font-size: 0.9rem; margin-bottom: 1.5rem; }
        .article-tags { display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem; }
        .article-tag { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; background: rgba(15,23,42,0.85); border: 1px solid rgba(220,38,38,0.4); color: #f87171; }
        .article-content { max-width: 800px; margin: 0 auto; padding: 60px 20px 80px; }
        .article-content h2 { font-size: 1.6rem; margin: 2.5rem 0 1rem; color: #f9fafb; border-left: 4px solid #dc2626; padding-left: 1rem; }
        .article-content h3 { font-size: 1.25rem; margin: 2rem 0 0.75rem; color: #e5e7eb; }
        .article-content p { margin-bottom: 1.25rem; color: #d1d5db; }
        .article-content ul, .article-content ol { margin: 1rem 0 1.5rem 1.5rem; color: #d1d5db; }
        .article-content li { margin-bottom: 0.5rem; }
        .article-content strong { color: #f9fafb; }
        pre { background: #0f172a; border: 1px solid rgba(220,38,38,0.3); border-radius: 12px; padding: 1.25rem; overflow-x: auto; margin: 1.5rem 0; font-size: 0.85rem; line-height: 1.6; }
        code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; color: #e5e7eb; }
        .code-keyword { color: #c084fc; }
        .code-func { color: #38bdf8; }
        .code-type { color: #4ade80; }
        .code-string { color: #fb7185; }
        .code-comment { color: #6b7280; font-style: italic; }
        .footer { background: #020617; border-top: 1px solid #111827; padding: 2rem; text-align: center; color: #6b7280; }
        .footer a { color: #38bdf8; text-decoration: none; }
    
        .toc {
            background: rgba(15,23,42,0.6);
            border: 1px solid rgba(220,38,38,0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0 3rem;
        }
        .toc-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f87171;
            margin-bottom: 1rem;
        }
        .toc-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .toc-list li {
            margin: 0.5rem 0;
        }
        .toc-list a {
            color: #d1d5db;
            text-decoration: none;
        }
        .toc-list a:hover {
            color: #38bdf8;
        }
        .code-bad {
            background: rgba(220,38,38,0.1);
            border-left: 3px solid #ef4444;
            padding: 1rem;
            margin: 1rem 0;
        }
        .code-good {
            background: rgba(34,197,94,0.1);
            border-left: 3px solid #22c55e;
            padding: 1rem;
            margin: 1rem 0;
        }
        .reference {
            background: rgba(15,23,42,0.6);
            border: 1px solid rgba(148,163,184,0.2);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        .reference-title {
            font-weight: 600;
            color: #94a3b8;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        .reference a { color: #38bdf8; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="logo">Fidroid</a>
            <a href="../index.html#blog" class="back-link">â† è¿”å›åšå®¢åˆ—è¡¨</a>
        </div>
    </nav>

    <header class="article-header">
        <h1>Jetpack Glance æ·±åº¦è§£æ</h1>
        <p class="article-meta">2024-12-23 Â· 55-65 min Â· Glance æ¡†æ¶</p>
        <div class="article-tags">
            <span class="article-tag">Glance</span>
            <span class="article-tag">Compose</span>
            <span class="article-tag">Widgets</span>
            <span class="article-tag">çŠ¶æ€ç®¡ç†</span>
        </div>
    </header>

    <article class="article-content">
        <nav class="toc">
            <div class="toc-title">ğŸ“š ç›®å½•</div>
            <ul class="toc-list">
                <li><a href="#i-glance-æ ¸å¿ƒæ¶æ„">I. Glance æ ¸å¿ƒæ¶æ„</a></li>
                <li><a href="#ii-glance-ç»„ä»¶è¯¦è§£">II. Glance ç»„ä»¶è¯¦è§£</a></li>
                <li><a href="#iii-çŠ¶æ€ç®¡ç†æ·±å…¥">III. çŠ¶æ€ç®¡ç†æ·±å…¥</a></li>
                <li><a href="#iv-action-ç³»ç»Ÿ">IV. Action ç³»ç»Ÿ</a></li>
                <li><a href="#v-å°ºå¯¸é€‚é…ä¸å“åº”å¼è®¾è®¡">V. å°ºå¯¸é€‚é…ä¸å“åº”å¼è®¾è®¡</a></li>
                <li><a href="#vi-ä¸»é¢˜ä¸æ ·å¼">VI. ä¸»é¢˜ä¸æ ·å¼</a></li>
                <li><a href="#vii-é«˜çº§ç‰¹æ€§">VII. é«˜çº§ç‰¹æ€§</a></li>
                <li><a href="#viii-æ€§èƒ½ä¼˜åŒ–ä¸è°ƒè¯•">VIII. æ€§èƒ½ä¼˜åŒ–ä¸è°ƒè¯•</a></li>
            </ul>
        </nav>
<p>Jetpack Glance æ˜¯ Google æ¨å‡ºçš„ç”¨äºæ„å»ºæ¡Œé¢å°éƒ¨ä»¶å’Œç©¿æˆ´è®¾å¤‡ç•Œé¢çš„æ–°æ¡†æ¶ï¼Œå®ƒå…è®¸å¼€å‘è€…ä½¿ç”¨ç±»ä¼¼ Compose çš„å£°æ˜å¼ API æ¥åˆ›å»ºè¿™äº›ç•Œé¢ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ Glance çš„æ ¸å¿ƒæ¦‚å¿µã€æ¶æ„è®¾è®¡ã€ç»„ä»¶ä½“ç³»ã€çŠ¶æ€ç®¡ç†ä»¥åŠå®æˆ˜æŠ€å·§ã€‚</p>
        <h3 id="-å®˜æ–¹å‚è€ƒ">ğŸ“š å®˜æ–¹å‚è€ƒ</h3>
        <ul>
        <li><a href="https://developer.android.com/jetpack/androidx/releases/glance" target="_blank">Jetpack Glance Documentation - Android Developers</a></li>
        <li><a href="https://github.com/android/user-interface-samples/tree/main/AppWidget" target="_blank">Glance App Widget Samples - GitHub</a></li>
        <li><a href="https://developer.android.com/develop/ui/compose/glance" target="_blank">Build app widgets with Glance - Android Developers</a></li>
        </ul>
        <h3 id="ç›®å½•">ç›®å½•</h3>
        <ul>
        <li><a href="#i-glance-æ ¸å¿ƒæ¶æ„" target="_blank">I. Glance æ ¸å¿ƒæ¶æ„</a></li>
        <li><a href="#ii-glance-ç»„ä»¶è¯¦è§£" target="_blank">II. Glance ç»„ä»¶è¯¦è§£</a></li>
        <li><a href="#iii-çŠ¶æ€ç®¡ç†æ·±å…¥" target="_blank">III. çŠ¶æ€ç®¡ç†æ·±å…¥</a></li>
        <li><a href="#iv-action-ç³»ç»Ÿ" target="_blank">IV. Action ç³»ç»Ÿ</a></li>
        <li><a href="#v-å°ºå¯¸é€‚é…ä¸å“åº”å¼è®¾è®¡" target="_blank">V. å°ºå¯¸é€‚é…ä¸å“åº”å¼è®¾è®¡</a></li>
        <li><a href="#vi-ä¸»é¢˜ä¸æ ·å¼" target="_blank">VI. ä¸»é¢˜ä¸æ ·å¼</a></li>
        <li><a href="#vii-é«˜çº§ç‰¹æ€§" target="_blank">VII. é«˜çº§ç‰¹æ€§</a></li>
        <li><a href="#viii-æ€§èƒ½ä¼˜åŒ–ä¸è°ƒè¯•" target="_blank">VIII. æ€§èƒ½ä¼˜åŒ–ä¸è°ƒè¯•</a></li>
        </ul>
        <h3 id="i-glance-æ ¸å¿ƒæ¶æ„">I. Glance æ ¸å¿ƒæ¶æ„</h3>
        <h4>1.1 Glance çš„å·¥ä½œåŸç†</h4>
        <p>Glance å¹¶éç›´æ¥æ¸²æŸ“ UIï¼Œè€Œæ˜¯ä½œä¸ºä¸€ä¸ª"ç¿»è¯‘å™¨"ï¼Œå°† Compose é£æ ¼çš„ä»£ç è½¬æ¢ä¸º RemoteViewsã€‚</p>
        <pre><code>
        Glance Composable
       â†“
  Glance Composition
       â†“
  Translation Layer
       â†“
   RemoteViews
       â†“
  System Launcher
        </code></pre>
        <p><strong>å…³é”®ç†è§£ï¼š</strong></p>
        <ul>
        <li>Glance ä»£ç åœ¨ <strong>Widget Provider è¿›ç¨‹</strong>ä¸­è¿è¡Œ</li>
        <li>æœ€ç»ˆçš„ UI æ¸²æŸ“åœ¨ <strong>Launcher è¿›ç¨‹</strong>ä¸­</li>
        <li>RemoteViews ä½œä¸ºè·¨è¿›ç¨‹é€šä¿¡çš„è½½ä½“</li>
        </ul>
        <h4>1.2 æ ¸å¿ƒç±»å…³ç³»</h4>
        <pre><code>
        // æ ¸å¿ƒæŠ½è±¡ç±»
abstract class GlanceAppWidget : GlanceAppWidgetReceiver() {
    // å®šä¹‰çŠ¶æ€å­˜å‚¨æ–¹å¼
    open val stateDefinition: GlanceStateDefinition&lt;*&gt;?
    
    // å®šä¹‰ UI å†…å®¹
    abstract suspend fun provideGlance(context: Context, id: GlanceId)
    
    // å°ºå¯¸æ¨¡å¼
    open val sizeMode: SizeMode = SizeMode.Single
}

// æ¥æ”¶å™¨åŸºç±»
abstract class GlanceAppWidgetReceiver : BroadcastReceiver() {
    abstract val glanceAppWidget: GlanceAppWidget
}
        </code></pre>
        <h4>1.3 åŸºæœ¬é¡¹ç›®ç»“æ„</h4>
        <pre><code>
        // 1. å®šä¹‰ Widget ç±»
class MyWidget : GlanceAppWidget() {
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            MyWidgetContent()
        }
    }
}

// 2. å®šä¹‰ Receiver
class MyWidgetReceiver : GlanceAppWidgetReceiver() {
    override val glanceAppWidget: GlanceAppWidget = MyWidget()
}

// 3. å®šä¹‰ UI
@Composable
fun MyWidgetContent() {
    Text("Hello Glance!")
}
        </code></pre>
        <h3 id="ii-glance-ç»„ä»¶è¯¦è§£">II. Glance ç»„ä»¶è¯¦è§£</h3>
        <h4>2.1 å¸ƒå±€ç»„ä»¶ (Layout Composables)</h4>
        <p>Glance æä¾›äº†ä¸æ ‡å‡† Compose ç±»ä¼¼ä½†ç‹¬ç«‹çš„å¸ƒå±€ç»„ä»¶ã€‚</p>
        <h5>Column - å‚ç›´å¸ƒå±€</h5>
        <pre><code>
        @Composable
fun VerticalLayoutExample() {
    Column(
        modifier = GlanceModifier
            .fillMaxSize()
            .padding(16.dp),
        verticalAlignment = Alignment.Vertical.Top,
        horizontalAlignment = Alignment.Horizontal.Start
    ) {
        Text("Item 1")
        Text("Item 2")
        Text("Item 3")
    }
}
        </code></pre>
        <h5>Row - æ°´å¹³å¸ƒå±€</h5>
        <pre><code>
        @Composable
fun HorizontalLayoutExample() {
    Row(
        modifier = GlanceModifier
            .fillMaxWidth()
            .padding(16.dp),
        verticalAlignment = Alignment.Vertical.CenterVertically,
        horizontalAlignment = Alignment.Horizontal.SpaceBetween
    ) {
        Image(
            provider = ImageProvider(R.drawable.icon),
            contentDescription = "Icon"
        )
        Text("Title", style = TextStyle(fontSize = 18.sp))
        Button(text = "Action", onClick = { })
    }
}
        </code></pre>
        <h5>Box - å±‚å å¸ƒå±€</h5>
        <pre><code>
        @Composable
fun StackedLayoutExample() {
    Box(
        modifier = GlanceModifier.size(200.dp),
        contentAlignment = Alignment.Center
    ) {
        // èƒŒæ™¯å±‚
        Image(
            provider = ImageProvider(R.drawable.background),
            contentDescription = null,
            modifier = GlanceModifier.fillMaxSize()
        )
        
        // å‰æ™¯å±‚
        Column(
            modifier = GlanceModifier.padding(16.dp),
            horizontalAlignment = Alignment.Horizontal.CenterHorizontally
        ) {
            Text("Overlay Text", style = TextStyle(color = ColorProvider(Color.White)))
            Button(text = "Action", onClick = { })
        }
    }
}
        </code></pre>
        <h4>2.2 åŸºç¡€ç»„ä»¶ (Basic Composables)</h4>
        <h5>Text - æ–‡æœ¬ç»„ä»¶</h5>
        <pre><code>
        @Composable
fun TextExamples() {
    Column(verticalAlignment = Alignment.Vertical.Top) {
        // åŸºç¡€æ–‡æœ¬
        Text(text = "Simple Text")
        
        // æ ·å¼åŒ–æ–‡æœ¬
        Text(
            text = "Styled Text",
            style = TextStyle(
                color = ColorProvider(Color.Blue),
                fontSize = 20.sp,
                fontWeight = FontWeight.Bold,
                fontStyle = FontStyle.Italic,
                textAlign = TextAlign.Center,
                textDecoration = TextDecoration.Underline
            )
        )
        
        // é™åˆ¶è¡Œæ•°
        Text(
            text = "Long text that will be truncated...",
            maxLines = 1,
            style = TextStyle(
                textOverflow = TextOverflow.Ellipsis
            )
        )
    }
}
        </code></pre>
        <h5>Image - å›¾ç‰‡ç»„ä»¶</h5>
        <pre><code>
        @Composable
fun ImageExamples() {
    Column {
        // 1. èµ„æºå›¾ç‰‡
        Image(
            provider = ImageProvider(R.drawable.my_image),
            contentDescription = "My Image",
            modifier = GlanceModifier.size(64.dp)
        )
        
        // 2. å›¾æ ‡ï¼ˆtintedï¼‰
        Image(
            provider = ImageProvider(R.drawable.ic_star),
            contentDescription = "Star",
            colorFilter = ColorFilter.tint(ColorProvider(Color.Yellow)),
            modifier = GlanceModifier.size(24.dp)
        )
        
        // 3. ä½å›¾ï¼ˆBitmapï¼‰
        val bitmap: Bitmap = loadBitmap()
        Image(
            provider = ImageProvider(bitmap),
            contentDescription = "Dynamic Image"
        )
    }
}
        </code></pre>
        <h5>Button - æŒ‰é’®ç»„ä»¶</h5>
        <pre><code>
        @Composable
fun ButtonExamples() {
    Column(verticalAlignment = Alignment.Vertical.Top) {
        // æ ‡å‡†æŒ‰é’®
        Button(
            text = "Click Me",
            onClick = actionRunCallback&lt;MyCallback&gt;()
        )
        
        // è‡ªå®šä¹‰æ ·å¼æŒ‰é’®
        Button(
            text = "Styled Button",
            onClick = actionStartActivity&lt;MainActivity&gt;(),
            style = TextStyle(
                color = ColorProvider(Color.White),
                fontSize = 16.sp
            ),
            colors = ButtonDefaults.buttonColors(
                backgroundColor = ColorProvider(Color.Blue),
                contentColor = ColorProvider(Color.White)
            ),
            modifier = GlanceModifier
                .fillMaxWidth()
                .height(48.dp)
        )
        
        // å›¾æ ‡æŒ‰é’®
        Button(
            text = "Refresh",
            icon = ImageProvider(R.drawable.ic_refresh),
            onClick = actionRunCallback&lt;RefreshCallback&gt;()
        )
    }
}
        </code></pre>
        <h5>CircularProgressIndicator - åŠ è½½æŒ‡ç¤ºå™¨</h5>
        <pre><code>
        @Composable
fun LoadingExample() {
    Box(
        modifier = GlanceModifier.fillMaxSize(),
        contentAlignment = Alignment.Center
    ) {
        CircularProgressIndicator(
            color = ColorProvider(Color.Blue),
            modifier = GlanceModifier.size(48.dp)
        )
    }
}
        </code></pre>
        <h5>LinearProgressIndicator - è¿›åº¦æ¡</h5>
        <pre><code>
        @Composable
fun ProgressExample(progress: Float) {
    Column {
        Text("Download Progress: ${(progress * 100).toInt()}%")
        LinearProgressIndicator(
            progress = progress,
            color = ColorProvider(Color.Green),
            backgroundColor = ColorProvider(Color.LightGray),
            modifier = GlanceModifier
                .fillMaxWidth()
                .height(8.dp)
        )
    }
}
        </code></pre>
        <h4>2.3 å¤åˆç»„ä»¶ (Compound Composables)</h4>
        <h5>Switch - å¼€å…³ç»„ä»¶</h5>
        <pre><code>
        @Composable
fun SwitchExample() {
    var isEnabled by remember { mutableStateOf(false) }
    
    Row(
        verticalAlignment = Alignment.Vertical.CenterVertically,
        modifier = GlanceModifier.fillMaxWidth()
    ) {
        Text("Enable Notifications", modifier = GlanceModifier.defaultWeight())
        Switch(
            checked = isEnabled,
            onCheckedChange = actionRunCallback&lt;ToggleSwitchCallback&gt;()
        )
    }
}
        </code></pre>
        <h5>CheckBox - å¤é€‰æ¡†</h5>
        <pre><code>
        @Composable
fun CheckBoxExample() {
    Row(verticalAlignment = Alignment.Vertical.CenterVertically) {
        CheckBox(
            checked = true,
            onCheckedChange = actionRunCallback&lt;ToggleCheckBoxCallback&gt;()
        )
        Text("I agree to terms")
    }
}
        </code></pre>
        <h4>2.4 æ‡’åŠ è½½åˆ—è¡¨ (LazyColumn)</h4>
        <p>Glance 1.0+ æ”¯æŒæ‡’åŠ è½½åˆ—è¡¨ã€‚</p>
        <pre><code>
        @Composable
fun LazyListExample(items: List&lt;String&gt;) {
    LazyColumn(
        modifier = GlanceModifier.fillMaxSize()
    ) {
        // å•ä¸ª item
        item {
            Text("Header", style = TextStyle(fontWeight = FontWeight.Bold))
        }
        
        // å¤šä¸ª items
        items(items.size) { index -&gt;
            ListItemRow(items[index])
        }
        
        // å¸¦ key çš„ items
        items(
            count = items.size,
            key = { index -&gt; items[index] }
        ) { index -&gt;
            ListItemRow(items[index])
        }
    }
}

@Composable
fun ListItemRow(text: String) {
    Row(
        modifier = GlanceModifier
            .fillMaxWidth()
            .padding(vertical = 8.dp, horizontal = 16.dp)
            .clickable(actionRunCallback&lt;ItemClickCallback&gt;()),
        verticalAlignment = Alignment.Vertical.CenterVertically
    ) {
        Image(
            provider = ImageProvider(R.drawable.ic_item),
            contentDescription = null,
            modifier = GlanceModifier.size(24.dp)
        )
        Spacer(modifier = GlanceModifier.width(8.dp))
        Text(text)
    }
}
        </code></pre>
        <h3 id="iii-çŠ¶æ€ç®¡ç†æ·±å…¥">III. çŠ¶æ€ç®¡ç†æ·±å…¥</h3>
        <h4>3.1 ä½¿ç”¨ DataStore ç®¡ç†çŠ¶æ€</h4>
        <p>Glance æ¨èä½¿ç”¨ Preferences DataStore æ¥æŒä¹…åŒ–å°éƒ¨ä»¶çŠ¶æ€ã€‚</p>
        <pre><code>
        // 1. å®šä¹‰ Preferences Keys
object WidgetPreferences {
    val TEMPERATURE_KEY = intPreferencesKey("temperature")
    val CITY_KEY = stringPreferencesKey("city")
    val LAST_UPDATE_KEY = longPreferencesKey("last_update")
}

// 2. å®šä¹‰ StateDefinition
object WeatherStateDefinition : GlanceStateDefinition&lt;Preferences&gt; {
    
    private const val DATA_STORE_FILE = "weather_widget_prefs"
    
    override suspend fun getDataStore(
        context: Context,
        fileKey: String
    ): DataStore&lt;Preferences&gt; {
        return context.dataStore
    }
    
    override fun getLocation(context: Context, fileKey: String): File {
        return context.dataStoreFile(DATA_STORE_FILE)
    }
    
    private val Context.dataStore by preferencesDataStore(name = DATA_STORE_FILE)
}

// 3. åœ¨ GlanceAppWidget ä¸­ä½¿ç”¨
class WeatherWidget : GlanceAppWidget() {
    
    override val stateDefinition = WeatherStateDefinition
    
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            // è¯»å–çŠ¶æ€
            val prefs = currentState&lt;Preferences&gt;()
            val temperature = prefs[WidgetPreferences.TEMPERATURE_KEY] ?: 0
            val city = prefs[WidgetPreferences.CITY_KEY] ?: "Unknown"
            
            WeatherWidgetContent(
                temperature = temperature,
                city = city
            )
        }
    }
}
        </code></pre>
        <h4>3.2 æ›´æ–°çŠ¶æ€</h4>
        <pre><code>
        // åœ¨ ActionCallback ä¸­æ›´æ–°çŠ¶æ€
class RefreshWeatherCallback : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        // 1. è·å–æ–°æ•°æ®
        val weatherData = fetchWeatherFromApi()
        
        // 2. æ›´æ–° DataStore
        updateAppWidgetState(context, glanceId) { prefs -&gt;
            prefs[WidgetPreferences.TEMPERATURE_KEY] = weatherData.temperature
            prefs[WidgetPreferences.CITY_KEY] = weatherData.city
            prefs[WidgetPreferences.LAST_UPDATE_KEY] = System.currentTimeMillis()
        }
        
        // 3. è§¦å‘ Widget æ›´æ–°
        WeatherWidget().update(context, glanceId)
    }
}

// åœ¨ Activity/Service ä¸­æ›´æ–°çŠ¶æ€
class WeatherUpdateWorker(
    context: Context,
    params: WorkerParameters
) : CoroutineWorker(context, params) {
    
    override suspend fun doWork(): Result {
        val weatherData = fetchWeatherFromApi()
        
        // æ›´æ–°æ‰€æœ‰ Widget å®ä¾‹
        GlanceAppWidgetManager(applicationContext)
            .getGlanceIds(WeatherWidget::class.java)
            .forEach { glanceId -&gt;
                updateAppWidgetState(applicationContext, glanceId) { prefs -&gt;
                    prefs[WidgetPreferences.TEMPERATURE_KEY] = weatherData.temperature
                    prefs[WidgetPreferences.CITY_KEY] = weatherData.city
                }
            }
        
        // åˆ·æ–°æ‰€æœ‰å®ä¾‹
        WeatherWidget().updateAll(applicationContext)
        
        return Result.success()
    }
}
        </code></pre>
        <h4>3.3 ä½¿ç”¨è‡ªå®šä¹‰çŠ¶æ€ç±»</h4>
        <pre><code>
        // 1. å®šä¹‰çŠ¶æ€æ•°æ®ç±»
@Serializable
data class WeatherState(
    val city: String = "Unknown",
    val temperature: Int = 0,
    val condition: WeatherCondition = WeatherCondition.UNKNOWN,
    val lastUpdate: Long = 0
)

enum class WeatherCondition {
    SUNNY, CLOUDY, RAINY, SNOWY, UNKNOWN
}

// 2. å®šä¹‰è‡ªå®šä¹‰ StateDefinition
object CustomWeatherStateDefinition : GlanceStateDefinition&lt;WeatherState&gt; {
    
    private const val DATA_STORE_FILE = "custom_weather_state"
    private val Context.dataStore by dataStore(DATA_STORE_FILE, WeatherStateSerializer)
    
    override suspend fun getDataStore(
        context: Context,
        fileKey: String
    ): DataStore&lt;WeatherState&gt; {
        return context.dataStore
    }
    
    override fun getLocation(context: Context, fileKey: String): File {
        return context.dataStoreFile(DATA_STORE_FILE)
    }
}

// 3. å®šä¹‰ Serializer
object WeatherStateSerializer : Serializer&lt;WeatherState&gt; {
    override val defaultValue: WeatherState = WeatherState()
    
    override suspend fun readFrom(input: InputStream): WeatherState {
        return Json.decodeFromString(input.readBytes().decodeToString())
    }
    
    override suspend fun writeTo(t: WeatherState, output: OutputStream) {
        output.write(Json.encodeToString(t).encodeToByteArray())
    }
}

// 4. åœ¨ Widget ä¸­ä½¿ç”¨
class WeatherWidget : GlanceAppWidget() {
    override val stateDefinition = CustomWeatherStateDefinition
    
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            val state = currentState&lt;WeatherState&gt;()
            WeatherWidgetContent(state)
        }
    }
}
        </code></pre>
        <h3 id="iv-action-ç³»ç»Ÿ">IV. Action ç³»ç»Ÿ</h3>
        <h4>4.1 Action ç±»å‹è¯¦è§£</h4>
        <p>Glance æä¾›äº†å¤šç§ Action ç±»å‹æ¥å¤„ç†ç”¨æˆ·äº¤äº’ã€‚</p>
        <h5>actionStartActivity - å¯åŠ¨ Activity</h5>
        <pre><code>
        @Composable
fun ActivityLaunchExample() {
    Column {
        // 1. å¯åŠ¨ä¸å¸¦å‚æ•°çš„ Activity
        Button(
            text = "Open App",
            onClick = actionStartActivity&lt;MainActivity&gt;()
        )
        
        // 2. å¯åŠ¨å¸¦å‚æ•°çš„ Activity
        Button(
            text = "View Details",
            onClick = actionStartActivity(
                activity = DetailActivity::class.java,
                parameters = actionParametersOf(
                    ActionParameters.Key&lt;String&gt;("item_id") to "123",
                    ActionParameters.Key&lt;Int&gt;("page") to 1
                )
            )
        )
        
        // 3. ä½¿ç”¨ Intent å¯åŠ¨
        Button(
            text = "Custom Intent",
            onClick = actionStartActivity(
                Intent(Intent.ACTION_VIEW, Uri.parse("https://example.com"))
            )
        )
    }
}
        </code></pre>
        <h5>actionRunCallback - æ‰§è¡Œå›è°ƒ</h5>
        <pre><code>
        // 1. å®šä¹‰ Callback
class UpdateDataCallback : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        // è·å–å‚æ•°
        val itemId = parameters[ActionParameters.Key&lt;String&gt;("item_id")]
        
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        val result = performUpdate(itemId)
        
        // æ›´æ–°çŠ¶æ€
        updateAppWidgetState(context, glanceId) { prefs -&gt;
            prefs[resultKey] = result
        }
        
        // åˆ·æ–° Widget
        MyWidget().update(context, glanceId)
    }
}

// 2. ä½¿ç”¨ Callback
@Composable
fun CallbackExample() {
    Button(
        text = "Update",
        onClick = actionRunCallback&lt;UpdateDataCallback&gt;(
            parameters = actionParametersOf(
                ActionParameters.Key&lt;String&gt;("item_id") to "456"
            )
        )
    )
}
        </code></pre>
        <h5>actionSendBroadcast - å‘é€å¹¿æ’­</h5>
        <pre><code>
        @Composable
fun BroadcastExample() {
    Button(
        text = "Send Broadcast",
        onClick = actionSendBroadcast(
            Intent("com.example.ACTION_CUSTOM").apply {
                putExtra("key", "value")
            }
        )
    )
}

// æ¥æ”¶å¹¿æ’­
class MyBroadcastReceiver : BroadcastReceiver() {
    override fun onReceive(context: Context, intent: Intent) {
        val value = intent.getStringExtra("key")
        // å¤„ç†å¹¿æ’­
    }
}
        </code></pre>
        <h5>actionStartService - å¯åŠ¨æœåŠ¡</h5>
        <pre><code>
        @Composable
fun ServiceExample() {
    Button(
        text = "Start Service",
        onClick = actionStartService&lt;MyForegroundService&gt;(
            isForegroundService = true
        )
    )
}
        </code></pre>
        <h4>4.2 å¤åˆ Actionï¼ˆç»„åˆå¤šä¸ªæ“ä½œï¼‰</h4>
        <pre><code>
        @Composable
fun CompoundActionExample() {
    // æ–¹å¼1ï¼šé“¾å¼è°ƒç”¨ï¼ˆä¸æ”¯æŒï¼Œéœ€è¦è‡ªå®šä¹‰ï¼‰
    // æ–¹å¼2ï¼šä½¿ç”¨è‡ªå®šä¹‰ Callback
    Button(
        text = "Complex Action",
        onClick = actionRunCallback&lt;ComplexActionCallback&gt;()
    )
}

class ComplexActionCallback : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        // æ­¥éª¤1ï¼šæ›´æ–°æ•°æ®
        updateData()
        
        // æ­¥éª¤2ï¼šå‘é€é€šçŸ¥
        sendNotification(context)
        
        // æ­¥éª¤3ï¼šå¯åŠ¨åå°åŒæ­¥
        startSync(context)
        
        // æ­¥éª¤4ï¼šæ›´æ–° Widget
        updateAppWidgetState(context, glanceId) { prefs -&gt;
            prefs[lastActionKey] = System.currentTimeMillis()
        }
        MyWidget().update(context, glanceId)
    }
}
        </code></pre>
        <h4>4.3 å¸¦å‚æ•°çš„ Action</h4>
        <pre><code>
        @Composable
fun ParameterizedActionExample(items: List&lt;Item&gt;) {
    LazyColumn {
        items(items.size) { index -&gt;
            val item = items[index]
            
            Row(
                modifier = GlanceModifier
                    .fillMaxWidth()
                    .clickable(
                        actionRunCallback&lt;ItemClickCallback&gt;(
                            parameters = actionParametersOf(
                                ActionParameters.Key&lt;String&gt;("item_id") to item.id,
                                ActionParameters.Key&lt;Int&gt;("position") to index
                            )
                        )
                    )
            ) {
                Text(item.title)
            }
        }
    }
}

class ItemClickCallback : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        val itemId = parameters[ActionParameters.Key&lt;String&gt;("item_id")]
        val position = parameters[ActionParameters.Key&lt;Int&gt;("position")]
        
        // ä½¿ç”¨å‚æ•°æ‰§è¡Œæ“ä½œ
        Log.d("ItemClick", "Clicked item $itemId at position $position")
    }
}
        </code></pre>
        <h3 id="v-å°ºå¯¸é€‚é…ä¸å“åº”å¼è®¾è®¡">V. å°ºå¯¸é€‚é…ä¸å“åº”å¼è®¾è®¡</h3>
        <h4>5.1 SizeMode é…ç½®</h4>
        <p>Glance æä¾›äº†ä¸‰ç§å°ºå¯¸æ¨¡å¼ã€‚</p>
        <pre><code>
        class MyWidget : GlanceAppWidget() {
    
    // æ¨¡å¼1ï¼šSingle - å•ä¸€å°ºå¯¸ï¼ˆé»˜è®¤ï¼‰
    override val sizeMode: SizeMode = SizeMode.Single
    
    // æ¨¡å¼2ï¼šExact - ç²¾ç¡®å°ºå¯¸
    override val sizeMode: SizeMode = SizeMode.Exact
    
    // æ¨¡å¼3ï¼šResponsive - å“åº”å¼ï¼ˆå¤šå¥—å¸ƒå±€ï¼‰
    override val sizeMode: SizeMode = SizeMode.Responsive(
        setOf(
            DpSize(100.dp, 100.dp),  // å°
            DpSize(200.dp, 100.dp),  // ä¸­
            DpSize(300.dp, 200.dp)   // å¤§
        )
    )
}
        </code></pre>
        <h4>5.2 æ ¹æ®å°ºå¯¸åˆ‡æ¢å¸ƒå±€</h4>
        <pre><code>
        @Composable
fun ResponsiveWidget() {
    val size = LocalSize.current
    
    when {
        size.width &lt; 150.dp -&gt; SmallWidget()
        size.width &lt; 250.dp -&gt; MediumWidget()
        else -&gt; LargeWidget()
    }
}

@Composable
fun SmallWidget() {
    Column(
        modifier = GlanceModifier.fillMaxSize().padding(8.dp),
        horizontalAlignment = Alignment.Horizontal.CenterHorizontally
    ) {
        Image(
            provider = ImageProvider(R.drawable.icon),
            contentDescription = null,
            modifier = GlanceModifier.size(32.dp)
        )
        Text("25Â°C", style = TextStyle(fontSize = 18.sp))
    }
}

@Composable
fun MediumWidget() {
    Row(
        modifier = GlanceModifier.fillMaxSize().padding(12.dp),
        verticalAlignment = Alignment.Vertical.CenterVertically
    ) {
        Image(
            provider = ImageProvider(R.drawable.icon),
            contentDescription = null,
            modifier = GlanceModifier.size(48.dp)
        )
        Spacer(modifier = GlanceModifier.width(8.dp))
        Column {
            Text("Beijing", style = TextStyle(fontSize = 14.sp))
            Text("25Â°C", style = TextStyle(fontSize = 24.sp, fontWeight = FontWeight.Bold))
        }
    }
}

@Composable
fun LargeWidget() {
    Column(
        modifier = GlanceModifier.fillMaxSize().padding(16.dp)
    ) {
        Row(
            modifier = GlanceModifier.fillMaxWidth(),
            verticalAlignment = Alignment.Vertical.CenterVertically
        ) {
            Image(
                provider = ImageProvider(R.drawable.icon),
                contentDescription = null,
                modifier = GlanceModifier.size(64.dp)
            )
            Spacer(modifier = GlanceModifier.width(16.dp))
            Column {
                Text("Beijing", style = TextStyle(fontSize = 18.sp))
                Text("25Â°C", style = TextStyle(fontSize = 32.sp, fontWeight = FontWeight.Bold))
                Text("Sunny", style = TextStyle(fontSize = 14.sp, color = ColorProvider(Color.Gray)))
            }
        }
        Spacer(modifier = GlanceModifier.height(16.dp))
        // æ›´å¤šè¯¦ç»†ä¿¡æ¯...
    }
}
        </code></pre>
        <h4>5.3 ä½¿ç”¨ LocalSize å®ç°ç»†ç²’åº¦æ§åˆ¶</h4>
        <pre><code>
        @Composable
fun AdaptiveTextSize() {
    val size = LocalSize.current
    
    val fontSize = when {
        size.width &lt; 120.dp -&gt; 14.sp
        size.width &lt; 200.dp -&gt; 16.sp
        else -&gt; 20.sp
    }
    
    Text(
        text = "Adaptive Text",
        style = TextStyle(fontSize = fontSize)
    )
}
        </code></pre>
        <h3 id="vi-ä¸»é¢˜ä¸æ ·å¼">VI. ä¸»é¢˜ä¸æ ·å¼</h3>
        <h4>6.1 åŠ¨æ€é¢œè‰²ï¼ˆAndroid 12+ï¼‰</h4>
        <pre><code>
        @Composable
fun DynamicColorWidget() {
    // ä½¿ç”¨ ColorProvider æ”¯æŒåŠ¨æ€é¢œè‰²
    Column(
        modifier = GlanceModifier
            .fillMaxSize()
            .background(
                day = Color.White,
                night = Color.Black
            )
            .padding(16.dp)
    ) {
        Text(
            text = "Dynamic Colors",
            style = TextStyle(
                color = ColorProvider(
                    day = Color.Black,
                    night = Color.White
                )
            )
        )
        
        Button(
            text = "Action",
            onClick = { },
            colors = ButtonDefaults.buttonColors(
                backgroundColor = ColorProvider(
                    day = Color(0xFF6200EE),
                    night = Color(0xFFBB86FC)
                )
            )
        )
    }
}
        </code></pre>
        <h4>6.2 è‡ªå®šä¹‰ä¸»é¢˜ç³»ç»Ÿ</h4>
        <pre><code>
        // å®šä¹‰ä¸»é¢˜å¯¹è±¡
object WidgetTheme {
    val colors = WidgetColors(
        primary = Color(0xFF6200EE),
        onPrimary = Color.White,
        surface = Color.White,
        onSurface = Color.Black
    )
    
    val typography = WidgetTypography(
        title = TextStyle(fontSize = 20.sp, fontWeight = FontWeight.Bold),
        body = TextStyle(fontSize = 14.sp),
        caption = TextStyle(fontSize = 12.sp, color = ColorProvider(Color.Gray))
    )
}

data class WidgetColors(
    val primary: Color,
    val onPrimary: Color,
    val surface: Color,
    val onSurface: Color
)

data class WidgetTypography(
    val title: TextStyle,
    val body: TextStyle,
    val caption: TextStyle
)

// ä½¿ç”¨ä¸»é¢˜
@Composable
fun ThemedWidget() {
    Column(
        modifier = GlanceModifier
            .fillMaxSize()
            .background(WidgetTheme.colors.surface)
            .padding(16.dp)
    ) {
        Text("Title", style = WidgetTheme.typography.title)
        Text("Body text", style = WidgetTheme.typography.body)
        Text("Caption", style = WidgetTheme.typography.caption)
    }
}
        </code></pre>
        <h3 id="vii-é«˜çº§ç‰¹æ€§">VII. é«˜çº§ç‰¹æ€§</h3>
        <h4>7.1 å¤šå®ä¾‹ç®¡ç†</h4>
        <pre><code>
        class MultiInstanceWidget : GlanceAppWidget() {
    
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        // æ¯ä¸ªå®ä¾‹å¯ä»¥æœ‰ç‹¬ç«‹çš„çŠ¶æ€
        val instanceState = getInstanceState(context, id)
        
        provideContent {
            WidgetContent(
                instanceId = id.toString(),
                config = instanceState
            )
        }
    }
    
    private suspend fun getInstanceState(context: Context, id: GlanceId): InstanceConfig {
        val prefs = context.dataStore.data.first()
        return InstanceConfig(
            city = prefs[stringPreferencesKey("city_${id}")] ?: "Beijing",
            showDetails = prefs[booleanPreferencesKey("details_${id}")] ?: false
        )
    }
}

// æ›´æ–°ç‰¹å®šå®ä¾‹
suspend fun updateSpecificInstance(context: Context, glanceId: GlanceId, city: String) {
    updateAppWidgetState(context, glanceId) { prefs -&gt;
        prefs[stringPreferencesKey("city_${glanceId}")] = city
    }
    MultiInstanceWidget().update(context, glanceId)
}

// æ›´æ–°æ‰€æœ‰å®ä¾‹
suspend fun updateAllInstances(context: Context) {
    val glanceIds = GlanceAppWidgetManager(context)
        .getGlanceIds(MultiInstanceWidget::class.java)
    
    glanceIds.forEach { glanceId -&gt;
        updateSpecificInstance(context, glanceId, "Shanghai")
    }
}
        </code></pre>
        <h4>7.2 é…ç½® Activity é›†æˆ</h4>
        <pre><code>
        class WidgetConfigActivity : AppCompatActivity() {
    
    private var glanceId: GlanceId? = null
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        
        // è·å– GlanceId
        val extras = intent.extras
        if (extras != null) {
            glanceId = GlanceAppWidgetManager(this)
                .getGlanceIdBy(extras.getInt(
                    AppWidgetManager.EXTRA_APPWIDGET_ID,
                    AppWidgetManager.INVALID_APPWIDGET_ID
                ))
        }
        
        setContent {
            ConfigScreen(
                onSave = { config -&gt;
                    lifecycleScope.launch {
                        saveConfig(config)
                        finish()
                    }
                }
            )
        }
    }
    
    private suspend fun saveConfig(config: WidgetConfig) {
        glanceId?.let { id -&gt;
            updateAppWidgetState(this, id) { prefs -&gt;
                prefs[cityKey] = config.city
                prefs[themeKey] = config.theme
            }
            MyWidget().update(this, id)
        }
    }
}
        </code></pre>
        <h4>7.3 WorkManager é›†æˆå®ç°å®šæœŸæ›´æ–°</h4>
        <pre><code>
        class WidgetUpdateWorker(
    context: Context,
    params: WorkerParameters
) : CoroutineWorker(context, params) {
    
    override suspend fun doWork(): Result {
        return try {
            // 1. è·å–æ–°æ•°æ®
            val data = fetchDataFromNetwork()
            
            // 2. æ›´æ–°æ‰€æœ‰ Widget å®ä¾‹
            val glanceIds = GlanceAppWidgetManager(applicationContext)
                .getGlanceIds(MyWidget::class.java)
            
            glanceIds.forEach { glanceId -&gt;
                updateAppWidgetState(applicationContext, glanceId) { prefs -&gt;
                    prefs[dataKey] = data.toString()
                    prefs[lastUpdateKey] = System.currentTimeMillis()
                }
            }
            
            // 3. åˆ·æ–° UI
            MyWidget().updateAll(applicationContext)
            
            Result.success()
        } catch (e: Exception) {
            Log.e("WidgetUpdateWorker", "Update failed", e)
            Result.retry()
        }
    }
}

// è°ƒåº¦ Worker
fun scheduleWidgetUpdates(context: Context) {
    val updateRequest = PeriodicWorkRequestBuilder&lt;WidgetUpdateWorker&gt;(
        15, TimeUnit.MINUTES
    )
        .setConstraints(
            Constraints.Builder()
                .setRequiredNetworkType(NetworkType.CONNECTED)
                .build()
        )
        .build()
    
    WorkManager.getInstance(context).enqueueUniquePeriodicWork(
        "WidgetUpdate",
        ExistingPeriodicWorkPolicy.KEEP,
        updateRequest
    )
}
        </code></pre>
        <h3 id="viii-æ€§èƒ½ä¼˜åŒ–ä¸è°ƒè¯•">VIII. æ€§èƒ½ä¼˜åŒ–ä¸è°ƒè¯•</h3>
        <h4>8.1 æ€§èƒ½ä¼˜åŒ–å»ºè®®</h4>
        <h5>å‡å°‘ä¸å¿…è¦çš„æ›´æ–°</h5>
        <div class="code-bad"><pre><code>
        // âŒ ä¸å¥½ï¼šé¢‘ç¹æ›´æ–°
class BadWidget : GlanceAppWidget() {
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        // æ¯æ¬¡éƒ½é‡æ–°è®¡ç®—
        val heavyData = performHeavyComputation()
        provideContent {
            Content(heavyData)
        }
    }
}

// âœ… å¥½ï¼šç¼“å­˜å’Œæ¡ä»¶æ›´æ–°
class GoodWidget : GlanceAppWidget() {
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        val prefs = currentState&lt;Preferences&gt;()
        val lastUpdate = prefs[lastUpdateKey] ?: 0L
        val now = System.currentTimeMillis()
        
        // åªåœ¨éœ€è¦æ—¶æ›´æ–°
        val data = if (now - lastUpdate &gt; 5 * 60 * 1000) {
            val newData = performHeavyComputation()
            updateAppWidgetState(context, id) { p -&gt;
                p[dataKey] = newData
                p[lastUpdateKey] = now
            }
            newData
        } else {
            prefs[dataKey] ?: ""
        }
        
        provideContent {
            Content(data)
        }
    }
}
        </code></pre></div>
        <h5>å›¾ç‰‡ä¼˜åŒ–</h5>
        <div class="code-good"><pre><code>
        // âœ… ä½¿ç”¨åˆé€‚å°ºå¯¸çš„å›¾ç‰‡
@Composable
fun OptimizedImage() {
    Image(
        provider = ImageProvider(R.drawable.icon_small), // ä½¿ç”¨å°å°ºå¯¸å›¾ç‰‡
        contentDescription = null,
        modifier = GlanceModifier.size(24.dp)
    )
}

// âœ… å¼‚æ­¥åŠ è½½å¹¶ç¼“å­˜
class ImageCacheManager(private val context: Context) {
    private val cache = LruCache&lt;String, Bitmap&gt;(10 * 1024 * 1024) // 10MB
    
    suspend fun loadImage(url: String): Bitmap? {
        return cache.get(url) ?: downloadAndCache(url)
    }
    
    private suspend fun downloadAndCache(url: String): Bitmap? {
        return withContext(Dispatchers.IO) {
            try {
                val bitmap = downloadBitmap(url)
                cache.put(url, bitmap)
                bitmap
            } catch (e: Exception) {
                null
            }
        }
    }
}
        </code></pre></div>
        <h4>8.2 è°ƒè¯•æŠ€å·§</h4>
        <h5>æ—¥å¿—è°ƒè¯•</h5>
        <pre><code>
        class DebugWidget : GlanceAppWidget() {
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        Log.d("DebugWidget", "provideGlance called for id: $id")
        
        val prefs = currentState&lt;Preferences&gt;()
        Log.d("DebugWidget", "Current state: $prefs")
        
        provideContent {
            DebugContent()
        }
    }
}

@Composable
fun DebugContent() {
    val size = LocalSize.current
    Log.d("DebugWidget", "Current size: ${size.width} x ${size.height}")
    
    Column {
        Text("Debug Mode")
        Text("Size: ${size.width} x ${size.height}")
    }
}
        </code></pre>
        <h5>ä½¿ç”¨ Previewï¼ˆæœ‰é™æ”¯æŒï¼‰</h5>
        <pre><code>
        // Glance Preview åŠŸèƒ½æœ‰é™ï¼Œä¸»è¦ç”¨äºå¸ƒå±€é¢„è§ˆ
@Preview
@Composable
fun WidgetPreview() {
    // æ¨¡æ‹Ÿæ•°æ®
    WeatherWidgetContent(
        temperature = 25,
        city = "Beijing",
        condition = WeatherCondition.SUNNY
    )
}
        </code></pre>
        <h4>8.3 å¸¸è§é—®é¢˜æ’æŸ¥</h4>
        <h5>é—®é¢˜1ï¼šWidget ä¸æ›´æ–°</h5>
        <pre><code>
        // è§£å†³æ–¹æ¡ˆï¼šç¡®ä¿è°ƒç”¨ update
class RefreshCallback : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        updateAppWidgetState(context, glanceId) { prefs -&gt;
            prefs[dataKey] = "new data"
        }
        
        // âš ï¸ å¿…é¡»è°ƒç”¨ update
        MyWidget().update(context, glanceId)
    }
}
        </code></pre>
        <h5>é—®é¢˜2ï¼šçŠ¶æ€ä¸æŒä¹…åŒ–</h5>
        <div class="code-bad"><pre><code>
        // âŒ é”™è¯¯ï¼šä½¿ç”¨ rememberï¼ˆä¸æŒä¹…åŒ–ï¼‰
@Composable
fun BadState() {
    var count by remember { mutableStateOf(0) }  // ä¸ä¼šä¿å­˜
    Button(text = "Count: $count", onClick = { count++ })
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ DataStore
@Composable
fun GoodState() {
    val prefs = currentState&lt;Preferences&gt;()
    val count = prefs[countKey] ?: 0
    Button(
        text = "Count: $count",
        onClick = actionRunCallback&lt;IncrementCallback&gt;()
    )
}

class IncrementCallback : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        updateAppWidgetState(context, glanceId) { prefs -&gt;
            val current = prefs[countKey] ?: 0
            prefs[countKey] = current + 1
        }
        MyWidget().update(context, glanceId)
    }
}
        </code></pre></div>
        <h5>é—®é¢˜3ï¼šç‚¹å‡»äº‹ä»¶ä¸å“åº”</h5>
        <div class="code-bad"><pre><code>
        // âŒ é”™è¯¯ï¼šä½¿ç”¨æ ‡å‡† Compose çš„ clickable
Row(modifier = Modifier.clickable { }) {  // ä¸å·¥ä½œ
    Text("Click me")
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ Glance çš„ clickable
Row(
    modifier = GlanceModifier.clickable(
        actionRunCallback&lt;ClickCallback&gt;()
    )
) {
    Text("Click me")
}
        </code></pre></div>
        <h3 id="æ€»ç»“">æ€»ç»“</h3>
        <p>Jetpack Glance æ˜¯æ„å»ºæ¡Œé¢å°éƒ¨ä»¶çš„ç°ä»£åŒ–æ–¹æ¡ˆï¼Œæ ¸å¿ƒè¦ç‚¹ï¼š</p>
        <h4>æ¶æ„ç†è§£</h4>
        <ul>
        <li>âœ… Glance æ˜¯ç¿»è¯‘å±‚ï¼Œæœ€ç»ˆè½¬æ¢ä¸º RemoteViews</li>
        <li>âœ… ä»£ç åœ¨ Provider è¿›ç¨‹è¿è¡Œï¼ŒUI åœ¨ Launcher è¿›ç¨‹æ¸²æŸ“</li>
        <li>âœ… çŠ¶æ€é€šè¿‡ DataStore è·¨è¿›ç¨‹ä¼ é€’</li>
        </ul>
        <h4>ç»„ä»¶ä½¿ç”¨</h4>
        <ul>
        <li>âœ… ä½¿ç”¨ Glance ä¸“æœ‰ç»„ä»¶ï¼ˆ<code>androidx.glance.*</code>ï¼‰</li>
        <li>âœ… å¸ƒå±€ï¼šColumn, Row, Box, LazyColumn</li>
        <li>âœ… åŸºç¡€ï¼šText, Image, Button, Progress</li>
        <li>âœ… Modifierï¼šGlanceModifierï¼ˆè€Œé Modifierï¼‰</li>
        </ul>
        <h4>çŠ¶æ€ç®¡ç†</h4>
        <ul>
        <li>âœ… æ¨èä½¿ç”¨ Preferences DataStore</li>
        <li>âœ… æ”¯æŒè‡ªå®šä¹‰çŠ¶æ€ç±»å’Œ Serializer</li>
        <li>âœ… ä½¿ç”¨ <code>currentState<T>()</code> è¯»å–çŠ¶æ€</li>
        <li>âœ… ä½¿ç”¨ <code>updateAppWidgetState</code> æ›´æ–°çŠ¶æ€</li>
        </ul>
        <h4>Action ç³»ç»Ÿ</h4>
        <ul>
        <li>âœ… å¯åŠ¨ Activityï¼š<code>actionStartActivity</code></li>
        <li>âœ… æ‰§è¡Œå›è°ƒï¼š<code>actionRunCallback</code></li>
        <li>âœ… å‘é€å¹¿æ’­ï¼š<code>actionSendBroadcast</code></li>
        <li>âœ… å¯åŠ¨æœåŠ¡ï¼š<code>actionStartService</code></li>
        </ul>
        <h4>å“åº”å¼è®¾è®¡</h4>
        <ul>
        <li>âœ… ä½¿ç”¨ <code>SizeMode</code> å®šä¹‰é€‚é…ç­–ç•¥</li>
        <li>âœ… ä½¿ç”¨ <code>LocalSize</code> è·å–å½“å‰å°ºå¯¸</li>
        <li>âœ… æ ¹æ®å°ºå¯¸åˆ‡æ¢å¸ƒå±€æˆ–è°ƒæ•´æ ·å¼</li>
        </ul>
        <h4>æ€§èƒ½ä¼˜åŒ–</h4>
        <ul>
        <li>âœ… ç¼“å­˜è®¡ç®—ç»“æœå’Œå›¾ç‰‡</li>
        <li>âœ… é¿å…é¢‘ç¹æ›´æ–°</li>
        <li>âœ… ä½¿ç”¨ WorkManager ç®¡ç†åå°æ›´æ–°</li>
        <li>âœ… æ­£ç¡®å¤„ç†ç”Ÿå‘½å‘¨æœŸ</li>
        </ul>
        <p>---</p>
        <h3 id="æ¨èé˜…è¯»">æ¨èé˜…è¯»</h3>
        <ul>
        <li><a href="https://developer.android.com/jetpack/androidx/releases/glance" target="_blank">Jetpack Glance Documentation - Android Developers</a></li>
        <li><a href="https://github.com/android/user-interface-samples/tree/main/AppWidget" target="_blank">Glance App Widget Samples - GitHub</a></li>
        <li><a href="https://developer.android.com/develop/ui/compose/glance" target="_blank">Build app widgets with Glance - Android Developers</a></li>
        </ul>
        <div class="reference">
            <div class="reference-title">ğŸ“š å®˜æ–¹å‚è€ƒ</div>
            <a href="https://developer.android.com/jetpack/androidx/releases/glance" target="_blank">Jetpack Glance Documentation - Android Developers</a><br>
            <a href="https://github.com/android/user-interface-samples/tree/main/AppWidget" target="_blank">Glance App Widget Samples - GitHub</a><br>
            <a href="https://developer.android.com/develop/ui/compose/glance" target="_blank">Build app widgets with Glance - Android Developers</a>
        </div>
    </article>

    <footer class="footer">
        <p>&copy; 2024 Fidroid. <a href="../index.html">è¿”å›é¦–é¡µ</a></p>
    </footer>
</body>
</html>
