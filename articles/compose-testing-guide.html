<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compose UI æµ‹è¯•å®æˆ˜ï¼šä»å•å…ƒæµ‹è¯•åˆ°ç«¯åˆ°ç«¯ - Fidroid</title>
    <meta name="description" content="å­¦ä¹ å¦‚ä½•æµ‹è¯• Jetpack Compose UIï¼ŒæŒæ¡ ComposeTestRuleã€è¯­ä¹‰æ ‘æŸ¥è¯¢ã€äº¤äº’æ¨¡æ‹Ÿç­‰æµ‹è¯•æŠ€å·§ã€‚">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.8;
            color: #e5e7eb;
            background: #020617;
        }
        .navbar {
            background: rgba(15,23,42,0.98);
            backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }
        .nav-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #38bdf8;
            text-decoration: none;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .back-link { color: #9ca3af; text-decoration: none; font-size: 0.9rem; }
        .back-link:hover { color: #38bdf8; }

        .article-header {
            padding: 120px 20px 60px;
            background: radial-gradient(circle at top left, #22c55e 0, transparent 50%),
                        radial-gradient(circle at bottom right, #eab308 0, transparent 55%),
                        #020617;
            text-align: center;
        }
        .article-header h1 {
            max-width: 800px;
            margin: 0 auto 1rem;
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            color: #fff;
        }
        .article-meta { color: #9ca3af; font-size: 0.9rem; margin-bottom: 1.5rem; }
        .article-tags { display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem; }
        .article-tag {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            background: rgba(15,23,42,0.85);
            border: 1px solid rgba(34,197,94,0.4);
            color: #86efac;
        }

        .article-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 60px 20px 80px;
        }
        .article-content h2 {
            font-size: 1.6rem;
            margin: 2.5rem 0 1rem;
            color: #f9fafb;
            border-left: 4px solid #22c55e;
            padding-left: 1rem;
        }
        .article-content h3 { font-size: 1.25rem; margin: 2rem 0 0.75rem; color: #e5e7eb; }
        .article-content p { margin-bottom: 1.25rem; color: #d1d5db; }
        .article-content ul, .article-content ol { margin: 1rem 0 1.5rem 1.5rem; color: #d1d5db; }
        .article-content li { margin-bottom: 0.5rem; }
        .article-content strong { color: #f9fafb; }
        .article-content a { color: #38bdf8; text-decoration: underline; }

        pre {
            background: #0f172a;
            border: 1px solid rgba(34,197,94,0.3);
            border-radius: 12px;
            padding: 1.25rem;
            overflow-x: auto;
            margin: 1.5rem 0;
            font-size: 0.85rem;
            line-height: 1.6;
        }
        code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; color: #e5e7eb; }
        .code-keyword { color: #c084fc; }
        .code-func { color: #38bdf8; }
        .code-type { color: #4ade80; }
        .code-string { color: #fb7185; }
        .code-comment { color: #6b7280; font-style: italic; }
        .code-number { color: #fbbf24; }

        .callout {
            background: rgba(34,197,94,0.1);
            border: 1px solid rgba(34,197,94,0.3);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            margin: 1.5rem 0;
        }
        .callout-title { font-weight: 600; color: #86efac; margin-bottom: 0.5rem; }
        .callout p { margin-bottom: 0; color: #d1d5db; }

        .footer {
            background: #020617;
            border-top: 1px solid #111827;
            padding: 2rem;
            text-align: center;
            color: #6b7280;
        }
        .footer a { color: #38bdf8; text-decoration: none; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="logo">Fidroid</a>
            <a href="../index.html#blog" class="back-link">â† è¿”å›åšå®¢åˆ—è¡¨</a>
        </div>
    </nav>

    <header class="article-header">
        <h1>Compose UI æµ‹è¯•å®æˆ˜ï¼šä»å•å…ƒæµ‹è¯•åˆ°ç«¯åˆ°ç«¯</h1>
        <p class="article-meta">2024-04-08 Â· 18 min Â· æµ‹è¯•</p>
        <div class="article-tags">
            <span class="article-tag">Testing</span>
            <span class="article-tag">ComposeTestRule</span>
            <span class="article-tag">Semantics</span>
            <span class="article-tag">Screenshot Test</span>
        </div>
    </header>

    <article class="article-content">
        <p>Compose çš„å£°æ˜å¼ç‰¹æ€§è®© UI æµ‹è¯•å˜å¾—æ›´åŠ ç›´è§‚ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Compose Testing API ç¼–å†™å¯é çš„ UI æµ‹è¯•ã€‚</p>

        <h2>ä¸€ã€æµ‹è¯•ç¯å¢ƒé…ç½®</h2>

<pre><code><span class="code-comment">// build.gradle.kts</span>
dependencies {
    <span class="code-comment">// Compose æµ‹è¯•</span>
    androidTestImplementation(<span class="code-string">"androidx.compose.ui:ui-test-junit4"</span>)
    debugImplementation(<span class="code-string">"androidx.compose.ui:ui-test-manifest"</span>)

    <span class="code-comment">// å¯é€‰ï¼šRobolectric æ”¯æŒæœ¬åœ°æµ‹è¯•</span>
    testImplementation(<span class="code-string">"org.robolectric:robolectric:4.11"</span>)
}</code></pre>

        <h2>äºŒã€åŸºç¡€æµ‹è¯•ç»“æ„</h2>

<pre><code><span class="code-keyword">class</span> <span class="code-type">LoginScreenTest</span> {

    <span class="code-keyword">@get:Rule</span>
    <span class="code-keyword">val</span> composeTestRule = <span class="code-func">createComposeRule</span>()

    <span class="code-keyword">@Test</span>
    <span class="code-keyword">fun</span> <span class="code-func">loginButton_displaysCorrectText</span>() {
        <span class="code-comment">// è®¾ç½®è¦æµ‹è¯•çš„ Composable</span>
        composeTestRule.<span class="code-func">setContent</span> {
            <span class="code-func">LoginScreen</span>()
        }

        <span class="code-comment">// æŸ¥æ‰¾å¹¶æ–­è¨€</span>
        composeTestRule
            .<span class="code-func">onNodeWithText</span>(<span class="code-string">"ç™»å½•"</span>)
            .<span class="code-func">assertIsDisplayed</span>()
    }
}</code></pre>

        <h2>ä¸‰ã€æŸ¥æ‰¾èŠ‚ç‚¹çš„æ–¹å¼</h2>

<pre><code><span class="code-comment">// é€šè¿‡æ–‡æœ¬æŸ¥æ‰¾</span>
composeTestRule.<span class="code-func">onNodeWithText</span>(<span class="code-string">"Submit"</span>)

<span class="code-comment">// é€šè¿‡ contentDescription æŸ¥æ‰¾</span>
composeTestRule.<span class="code-func">onNodeWithContentDescription</span>(<span class="code-string">"Close button"</span>)

<span class="code-comment">// é€šè¿‡ testTag æŸ¥æ‰¾ï¼ˆæ¨èï¼‰</span>
composeTestRule.<span class="code-func">onNodeWithTag</span>(<span class="code-string">"login_button"</span>)

<span class="code-comment">// ç»„åˆæŸ¥æ‰¾æ¡ä»¶</span>
composeTestRule.<span class="code-func">onNode</span>(
    <span class="code-func">hasText</span>(<span class="code-string">"Submit"</span>) <span class="code-keyword">and</span> <span class="code-func">hasClickAction</span>()
)

<span class="code-comment">// æŸ¥æ‰¾å¤šä¸ªèŠ‚ç‚¹</span>
composeTestRule.<span class="code-func">onAllNodesWithTag</span>(<span class="code-string">"list_item"</span>)</code></pre>

        <h3>æ·»åŠ  testTag</h3>

<pre><code><span class="code-func">Button</span>(
    onClick = { },
    modifier = <span class="code-type">Modifier</span>.<span class="code-func">testTag</span>(<span class="code-string">"login_button"</span>)
) {
    <span class="code-func">Text</span>(<span class="code-string">"ç™»å½•"</span>)
}</code></pre>

        <h2>å››ã€å¸¸ç”¨æ–­è¨€</h2>

<pre><code><span class="code-comment">// æ˜¾ç¤ºçŠ¶æ€</span>
.<span class="code-func">assertIsDisplayed</span>()
.<span class="code-func">assertIsNotDisplayed</span>()
.<span class="code-func">assertExists</span>()
.<span class="code-func">assertDoesNotExist</span>()

<span class="code-comment">// å¯ç”¨çŠ¶æ€</span>
.<span class="code-func">assertIsEnabled</span>()
.<span class="code-func">assertIsNotEnabled</span>()

<span class="code-comment">// é€‰ä¸­çŠ¶æ€</span>
.<span class="code-func">assertIsSelected</span>()
.<span class="code-func">assertIsOn</span>()  <span class="code-comment">// for toggles</span>
.<span class="code-func">assertIsOff</span>()

<span class="code-comment">// æ–‡æœ¬æ–­è¨€</span>
.<span class="code-func">assertTextEquals</span>(<span class="code-string">"Expected text"</span>)
.<span class="code-func">assertTextContains</span>(<span class="code-string">"partial"</span>)

<span class="code-comment">// æ•°é‡æ–­è¨€</span>
composeTestRule.<span class="code-func">onAllNodesWithTag</span>(<span class="code-string">"item"</span>).<span class="code-func">assertCountEquals</span>(<span class="code-number">5</span>)</code></pre>

        <h2>äº”ã€æ¨¡æ‹Ÿç”¨æˆ·äº¤äº’</h2>

<pre><code><span class="code-comment">// ç‚¹å‡»</span>
.<span class="code-func">performClick</span>()

<span class="code-comment">// è¾“å…¥æ–‡æœ¬</span>
.<span class="code-func">performTextInput</span>(<span class="code-string">"Hello"</span>)
.<span class="code-func">performTextClearance</span>()
.<span class="code-func">performTextReplacement</span>(<span class="code-string">"New text"</span>)

<span class="code-comment">// æ»šåŠ¨</span>
.<span class="code-func">performScrollTo</span>()
.<span class="code-func">performScrollToIndex</span>(<span class="code-number">10</span>)

<span class="code-comment">// æ‰‹åŠ¿</span>
.<span class="code-func">performTouchInput</span> {
    <span class="code-func">swipeLeft</span>()
    <span class="code-func">swipeUp</span>()
    <span class="code-func">longClick</span>()
}</code></pre>

        <h2>å…­ã€å®Œæ•´æµ‹è¯•ç¤ºä¾‹</h2>

<pre><code><span class="code-keyword">class</span> <span class="code-type">TodoListTest</span> {

    <span class="code-keyword">@get:Rule</span>
    <span class="code-keyword">val</span> composeTestRule = <span class="code-func">createComposeRule</span>()

    <span class="code-keyword">@Test</span>
    <span class="code-keyword">fun</span> <span class="code-func">addTodo_showsInList</span>() {
        composeTestRule.<span class="code-func">setContent</span> {
            <span class="code-func">TodoApp</span>()
        }

        <span class="code-comment">// è¾“å…¥æ–°å¾…åŠ</span>
        composeTestRule
            .<span class="code-func">onNodeWithTag</span>(<span class="code-string">"todo_input"</span>)
            .<span class="code-func">performTextInput</span>(<span class="code-string">"Buy milk"</span>)

        <span class="code-comment">// ç‚¹å‡»æ·»åŠ æŒ‰é’®</span>
        composeTestRule
            .<span class="code-func">onNodeWithTag</span>(<span class="code-string">"add_button"</span>)
            .<span class="code-func">performClick</span>()

        <span class="code-comment">// éªŒè¯åˆ—è¡¨ä¸­æ˜¾ç¤ºæ–°é¡¹</span>
        composeTestRule
            .<span class="code-func">onNodeWithText</span>(<span class="code-string">"Buy milk"</span>)
            .<span class="code-func">assertIsDisplayed</span>()
    }

    <span class="code-keyword">@Test</span>
    <span class="code-keyword">fun</span> <span class="code-func">completeTodo_showsStrikethrough</span>() {
        composeTestRule.<span class="code-func">setContent</span> {
            <span class="code-func">TodoItem</span>(
                todo = <span class="code-func">Todo</span>(<span class="code-string">"Test"</span>, completed = <span class="code-keyword">false</span>),
                onToggle = {}
            )
        }

        <span class="code-comment">// ç‚¹å‡»å¤é€‰æ¡†</span>
        composeTestRule
            .<span class="code-func">onNodeWithTag</span>(<span class="code-string">"todo_checkbox"</span>)
            .<span class="code-func">performClick</span>()

        <span class="code-comment">// éªŒè¯çŠ¶æ€å˜åŒ–</span>
        composeTestRule
            .<span class="code-func">onNodeWithTag</span>(<span class="code-string">"todo_checkbox"</span>)
            .<span class="code-func">assertIsOn</span>()
    }
}</code></pre>

        <h2>ä¸ƒã€ç­‰å¾…å¼‚æ­¥æ“ä½œ</h2>

<pre><code><span class="code-keyword">@Test</span>
<span class="code-keyword">fun</span> <span class="code-func">loadData_showsContent</span>() {
    composeTestRule.<span class="code-func">setContent</span> {
        <span class="code-func">DataScreen</span>()
    }

    <span class="code-comment">// ç­‰å¾…åŠ è½½å®Œæˆ</span>
    composeTestRule.<span class="code-func">waitUntil</span>(timeoutMillis = <span class="code-number">5000</span>) {
        composeTestRule
            .<span class="code-func">onAllNodesWithTag</span>(<span class="code-string">"data_item"</span>)
            .<span class="code-func">fetchSemanticsNodes</span>()
            .isNotEmpty()
    }

    <span class="code-comment">// æˆ–ä½¿ç”¨ IdlingResource</span>
    composeTestRule.<span class="code-func">registerIdlingResource</span>(dataLoadingIdlingResource)
}</code></pre>

        <h2>å…«ã€æµ‹è¯• ViewModel é›†æˆ</h2>

<pre><code><span class="code-keyword">@Test</span>
<span class="code-keyword">fun</span> <span class="code-func">screenWithViewModel_displaysData</span>() {
    <span class="code-keyword">val</span> fakeViewModel = <span class="code-func">FakeProfileViewModel</span>()
    fakeViewModel.<span class="code-func">setProfile</span>(
        <span class="code-func">Profile</span>(name = <span class="code-string">"John"</span>, email = <span class="code-string">"john@example.com"</span>)
    )

    composeTestRule.<span class="code-func">setContent</span> {
        <span class="code-func">ProfileScreen</span>(viewModel = fakeViewModel)
    }

    composeTestRule
        .<span class="code-func">onNodeWithText</span>(<span class="code-string">"John"</span>)
        .<span class="code-func">assertIsDisplayed</span>()

    composeTestRule
        .<span class="code-func">onNodeWithText</span>(<span class="code-string">"john@example.com"</span>)
        .<span class="code-func">assertIsDisplayed</span>()
}</code></pre>

        <h2>ä¹ã€æˆªå›¾æµ‹è¯•</h2>

<pre><code><span class="code-keyword">@Test</span>
<span class="code-keyword">fun</span> <span class="code-func">button_matchesGolden</span>() {
    composeTestRule.<span class="code-func">setContent</span> {
        <span class="code-func">PrimaryButton</span>(text = <span class="code-string">"Click me"</span>, onClick = {})
    }

    composeTestRule
        .<span class="code-func">onNodeWithTag</span>(<span class="code-string">"primary_button"</span>)
        .<span class="code-func">captureToImage</span>()
        .<span class="code-func">assertAgainstGolden</span>(goldenIdentifier = <span class="code-string">"primary_button"</span>)
}</code></pre>

        <div class="callout">
            <p class="callout-title">ğŸ’¡ æˆªå›¾æµ‹è¯•å·¥å…·</p>
            <p>æ¨èä½¿ç”¨ Paparazziï¼ˆæœ¬åœ°æˆªå›¾æµ‹è¯•ï¼‰æˆ– Shotï¼ˆè®¾å¤‡æˆªå›¾æµ‹è¯•ï¼‰åº“æ¥å®ç°æˆªå›¾æ¯”å¯¹ã€‚</p>
        </div>

        <h2>åã€æµ‹è¯•æœ€ä½³å®è·µ</h2>
        <ul>
            <li>âœ… ä½¿ç”¨ <code>testTag</code> è€Œéæ–‡æœ¬æŸ¥æ‰¾ï¼Œé¿å…å›½é™…åŒ–é—®é¢˜</li>
            <li>âœ… æµ‹è¯•ç”¨æˆ·å¯è§çš„è¡Œä¸ºï¼Œè€Œéå®ç°ç»†èŠ‚</li>
            <li>âœ… ä¿æŒæµ‹è¯•ç‹¬ç«‹ï¼Œæ¯ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä»¶äº‹</li>
            <li>âœ… ä½¿ç”¨ Fake/Mock éš”ç¦»å¤–éƒ¨ä¾èµ–</li>
            <li>âœ… ä¸ºå…³é”®ç”¨æˆ·æµç¨‹ç¼–å†™ç«¯åˆ°ç«¯æµ‹è¯•</li>
            <li>âœ… ä½¿ç”¨æˆªå›¾æµ‹è¯•ä¿è¯è§†è§‰ä¸€è‡´æ€§</li>
        </ul>

        <h2>æ€»ç»“</h2>
        <p>Compose æµ‹è¯•çš„æ ¸å¿ƒæµç¨‹ï¼š</p>
        <ol>
            <li><strong>è®¾ç½®</strong>ï¼šä½¿ç”¨ <code>setContent</code> æ¸²æŸ“ Composable</li>
            <li><strong>æŸ¥æ‰¾</strong>ï¼šé€šè¿‡è¯­ä¹‰æ ‘æŸ¥æ‰¾èŠ‚ç‚¹</li>
            <li><strong>äº¤äº’</strong>ï¼šæ¨¡æ‹Ÿç”¨æˆ·æ“ä½œ</li>
            <li><strong>æ–­è¨€</strong>ï¼šéªŒè¯é¢„æœŸç»“æœ</li>
        </ol>
        <p>ç¼–å†™å¥½çš„æµ‹è¯•èƒ½è®©ä½ æ›´æœ‰ä¿¡å¿ƒåœ°é‡æ„å’Œè¿­ä»£ UI ä»£ç ã€‚</p>
    </article>

    <footer class="footer">
        <p>&copy; 2024 Fidroid. <a href="../index.html">è¿”å›é¦–é¡µ</a></p>
    </footer>
</body>
</html>

