<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compose Snapshot ç³»ç»Ÿï¼šçŠ¶æ€è§‚å¯Ÿä¸äº‹åŠ¡éš”ç¦»çš„ç§˜å¯† - Fidroid</title>
    <meta name="description" content="æ·±å…¥è§£æ Compose Snapshot ç³»ç»Ÿçš„å·¥ä½œåŸç†ï¼Œç†è§£çŠ¶æ€å˜åŒ–å¦‚ä½•è§¦å‘é‡ç»„ï¼ŒæŒæ¡ Snapshot äº‹åŠ¡å’Œéš”ç¦»æœºåˆ¶ã€‚">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.8;
            color: #e5e7eb;
            background: #020617;
        }
        .navbar {
            background: rgba(15,23,42,0.98);
            backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }
        .nav-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #38bdf8;
            text-decoration: none;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .back-link { color: #9ca3af; text-decoration: none; font-size: 0.9rem; }
        .back-link:hover { color: #38bdf8; }

        .article-header {
            padding: 120px 20px 60px;
            background: radial-gradient(circle at top right, #dc2626 0, transparent 50%),
                        radial-gradient(circle at bottom left, #2563eb 0, transparent 55%),
                        #020617;
            text-align: center;
        }
        .article-header h1 {
            max-width: 800px;
            margin: 0 auto 1rem;
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            color: #fff;
        }
        .article-meta { color: #9ca3af; font-size: 0.9rem; margin-bottom: 1.5rem; }
        .article-tags { display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem; }
        .article-tag {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            background: rgba(15,23,42,0.85);
            border: 1px solid rgba(220,38,38,0.4);
            color: #fca5a5;
        }

        .article-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 60px 20px 80px;
        }
        .article-content h2 {
            font-size: 1.6rem;
            margin: 2.5rem 0 1rem;
            color: #f9fafb;
            border-left: 4px solid #dc2626;
            padding-left: 1rem;
        }
        .article-content h3 { font-size: 1.25rem; margin: 2rem 0 0.75rem; color: #e5e7eb; }
        .article-content p { margin-bottom: 1.25rem; color: #d1d5db; }
        .article-content ul, .article-content ol { margin: 1rem 0 1.5rem 1.5rem; color: #d1d5db; }
        .article-content li { margin-bottom: 0.5rem; }
        .article-content strong { color: #f9fafb; }
        .article-content a { color: #38bdf8; text-decoration: underline; }

        pre {
            background: #0f172a;
            border: 1px solid rgba(220,38,38,0.3);
            border-radius: 12px;
            padding: 1.25rem;
            overflow-x: auto;
            margin: 1.5rem 0;
            font-size: 0.85rem;
            line-height: 1.6;
        }
        code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; color: #e5e7eb; }
        .code-keyword { color: #c084fc; }
        .code-func { color: #38bdf8; }
        .code-type { color: #4ade80; }
        .code-string { color: #fb7185; }
        .code-comment { color: #6b7280; font-style: italic; }
        .code-number { color: #fbbf24; }
        .code-annotation { color: #f472b6; }

        .callout {
            background: rgba(220,38,38,0.1);
            border: 1px solid rgba(220,38,38,0.3);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            margin: 1.5rem 0;
        }
        .callout-title { font-weight: 600; color: #fca5a5; margin-bottom: 0.5rem; }
        .callout p { margin-bottom: 0; color: #d1d5db; }

        .callout-warning {
            background: rgba(245,158,11,0.1);
            border: 1px solid rgba(245,158,11,0.3);
        }
        .callout-warning .callout-title { color: #fcd34d; }

        .callout-info {
            background: rgba(14,165,233,0.1);
            border: 1px solid rgba(14,165,233,0.3);
        }
        .callout-info .callout-title { color: #7dd3fc; }

        .diagram {
            background: #0f172a;
            border: 1px solid rgba(220,38,38,0.3);
            border-radius: 12px;
            padding: 2rem;
            margin: 1.5rem 0;
            text-align: center;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.8rem;
            line-height: 1.6;
            color: #94a3b8;
            overflow-x: auto;
        }
        .diagram .highlight { color: #f87171; font-weight: bold; }
        .diagram .state { color: #4ade80; }
        .diagram .snapshot { color: #38bdf8; }
        .diagram .observer { color: #c084fc; }

        .reference {
            background: rgba(15,23,42,0.6);
            border: 1px solid rgba(148,163,184,0.2);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        .reference-title {
            font-weight: 600;
            color: #94a3b8;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        .reference a { color: #38bdf8; }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.9rem;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid rgba(148,163,184,0.3);
            padding: 0.75rem 1rem;
            text-align: left;
        }
        .comparison-table th {
            background: rgba(15,23,42,0.8);
            color: #f9fafb;
        }
        .comparison-table td { color: #d1d5db; }

        .footer {
            background: #020617;
            border-top: 1px solid #111827;
            padding: 2rem;
            text-align: center;
            color: #6b7280;
        }
        .footer a { color: #38bdf8; text-decoration: none; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="logo">Fidroid</a>
            <a href="../index.html#blog" class="back-link">â† è¿”å›åšå®¢åˆ—è¡¨</a>
        </div>
    </nav>

    <header class="article-header">
        <h1>Compose Snapshot ç³»ç»Ÿï¼šçŠ¶æ€è§‚å¯Ÿä¸äº‹åŠ¡éš”ç¦»çš„ç§˜å¯†</h1>
        <p class="article-meta">2024-04-29 Â· 35 min Â· åº•å±‚åŸç†æ·±åº¦è§£æ</p>
        <div class="article-tags">
            <span class="article-tag">Snapshot</span>
            <span class="article-tag">State Observation</span>
            <span class="article-tag">Transaction</span>
            <span class="article-tag">Isolation</span>
        </div>
    </header>

    <article class="article-content">
        <p>Compose å¦‚ä½•çŸ¥é“çŠ¶æ€å˜åŒ–äº†ï¼Ÿä¸ºä»€ä¹ˆ <code>mutableStateOf</code> èƒ½è§¦å‘é‡ç»„ï¼Œè€Œæ™®é€šå˜é‡ä¸èƒ½ï¼Ÿç­”æ¡ˆè—åœ¨ Compose æœ€æ ¸å¿ƒä¹Ÿæœ€ç¥ç§˜çš„å­ç³»ç»Ÿä¸­â€”â€”<strong>Snapshot ç³»ç»Ÿ</strong>ã€‚æœ¬æ–‡å°†æ­å¼€å®ƒçš„é¢çº±ï¼Œæ·±å…¥æ¢è®¨çŠ¶æ€è§‚å¯Ÿã€å˜åŒ–è¿½è¸ªå’Œäº‹åŠ¡éš”ç¦»çš„å®ç°åŸç†ã€‚</p>

        <div class="reference">
            <div class="reference-title">ğŸ“š å®˜æ–¹å‚è€ƒ</div>
            <a href="https://developer.android.com/jetpack/compose/state" target="_blank">State and Jetpack Compose</a><br>
            <a href="https://github.com/androidx/androidx/tree/androidx-main/compose/runtime/runtime/src/commonMain/kotlin/androidx/compose/runtime/snapshots" target="_blank">Snapshot æºç  - AndroidX</a>
        </div>

        <h2>ä¸€ã€Snapshot ç³»ç»Ÿæ¦‚è¿°</h2>

        <p>Snapshot ç³»ç»Ÿæ˜¯ Compose Runtime çš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒæä¾›äº†ï¼š</p>

        <ul>
            <li><strong>çŠ¶æ€è§‚å¯Ÿ</strong>ï¼šè¿½è¸ªå“ªäº›çŠ¶æ€è¢«è¯»å–ï¼Œå“ªäº›è¢«ä¿®æ”¹</li>
            <li><strong>å˜åŒ–é€šçŸ¥</strong>ï¼šå½“çŠ¶æ€å˜åŒ–æ—¶ï¼Œé€šçŸ¥ç›¸å…³çš„è§‚å¯Ÿè€…</li>
            <li><strong>äº‹åŠ¡éš”ç¦»</strong>ï¼šç±»ä¼¼æ•°æ®åº“äº‹åŠ¡ï¼Œæä¾›ä¸€è‡´æ€§çš„çŠ¶æ€è§†å›¾</li>
            <li><strong>å¹¶å‘æ”¯æŒ</strong>ï¼šå…è®¸å¤šçº¿ç¨‹å®‰å…¨åœ°è¯»å†™çŠ¶æ€</li>
        </ul>

        <div class="diagram">
<pre>
<span class="highlight">Snapshot ç³»ç»Ÿæ¶æ„</span>

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Compose Runtime                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ <span class="state">MutableState</span> â”‚    â”‚ <span class="state">MutableState</span> â”‚    â”‚ <span class="state">MutableState</span> â”‚  â”‚
â”‚  â”‚   count=5    â”‚    â”‚   name="A"   â”‚    â”‚   list=[...]  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                   â”‚                   â”‚          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                             â”‚                               â”‚
â”‚                             â–¼                               â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚              â”‚      <span class="snapshot">Snapshot System</span>        â”‚               â”‚
â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚               â”‚
â”‚              â”‚  â”‚ State Records       â”‚    â”‚               â”‚
â”‚              â”‚  â”‚ Read Observers      â”‚    â”‚               â”‚
â”‚              â”‚  â”‚ Write Observers     â”‚    â”‚               â”‚
â”‚              â”‚  â”‚ Snapshot Stack      â”‚    â”‚               â”‚
â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚               â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                            â”‚                                â”‚
â”‚                            â–¼                                â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚              â”‚    <span class="observer">Recomposition Trigger</span>    â”‚               â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
        </div>

        <h3>ä¸ºä»€ä¹ˆéœ€è¦ Snapshotï¼Ÿ</h3>

        <p>è€ƒè™‘è¿™ä¸ªåœºæ™¯ï¼š</p>

<pre><code><span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">Counter</span>() {
    <span class="code-keyword">var</span> count <span class="code-keyword">by</span> <span class="code-func">remember</span> { <span class="code-func">mutableStateOf</span>(<span class="code-number">0</span>) }
    
    <span class="code-func">Button</span>(onClick = { count++ }) {
        <span class="code-func">Text</span>(<span class="code-string">"Count: </span>$count<span class="code-string">"</span>)
    }
}

<span class="code-comment">// é—®é¢˜ï¼šå½“ count++ æ‰§è¡Œæ—¶</span>
<span class="code-comment">// 1. Compose å¦‚ä½•çŸ¥é“ count å˜äº†ï¼Ÿ</span>
<span class="code-comment">// 2. Compose å¦‚ä½•çŸ¥é“å“ªäº› Composable éœ€è¦é‡ç»„ï¼Ÿ</span>
<span class="code-comment">// 3. å¦‚æœåŒæ—¶æœ‰å¤šä¸ªçŠ¶æ€å˜åŒ–ï¼Œå¦‚ä½•ä¿è¯ä¸€è‡´æ€§ï¼Ÿ</span></code></pre>

        <p>Snapshot ç³»ç»Ÿæ­£æ˜¯ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜è€Œè®¾è®¡çš„ã€‚</p>

        <h2>äºŒã€StateObject ä¸ StateRecord</h2>

        <p>ç†è§£ Snapshot ç³»ç»Ÿçš„ç¬¬ä¸€æ­¥æ˜¯ç†è§£å®ƒçš„æ•°æ®ç»“æ„ã€‚</p>

        <h3>StateObject</h3>

        <p>æ¯ä¸ª Compose çŠ¶æ€ï¼ˆå¦‚ <code>MutableState</code>ï¼‰éƒ½å®ç°äº† <code>StateObject</code> æ¥å£ï¼š</p>

<pre><code><span class="code-comment">// ç®€åŒ–çš„ StateObject æ¥å£</span>
<span class="code-keyword">interface</span> <span class="code-type">StateObject</span> {
    <span class="code-comment">// çŠ¶æ€è®°å½•é“¾è¡¨çš„å¤´éƒ¨</span>
    <span class="code-keyword">val</span> firstStateRecord: <span class="code-type">StateRecord</span>
    
    <span class="code-comment">// æ·»åŠ æ–°çš„çŠ¶æ€è®°å½•</span>
    <span class="code-keyword">fun</span> <span class="code-func">prependStateRecord</span>(value: <span class="code-type">StateRecord</span>)
}

<span class="code-comment">// MutableState çš„ç®€åŒ–å®ç°</span>
<span class="code-keyword">internal class</span> <span class="code-type">SnapshotMutableStateImpl</span>&lt;<span class="code-type">T</span>&gt;(
    value: <span class="code-type">T</span>
) : <span class="code-type">StateObject</span>, <span class="code-type">MutableState</span>&lt;<span class="code-type">T</span>&gt; {
    
    <span class="code-keyword">override var</span> firstStateRecord: <span class="code-type">StateRecord</span> = 
        <span class="code-type">StateStateRecord</span>(value)
    
    <span class="code-keyword">override var</span> value: <span class="code-type">T</span>
        <span class="code-keyword">get</span>() {
            <span class="code-comment">// è¯»å–æ—¶é€šçŸ¥ Snapshot ç³»ç»Ÿ</span>
            <span class="code-keyword">return</span> <span class="code-func">readable</span>(firstStateRecord).value
        }
        <span class="code-keyword">set</span>(value) {
            <span class="code-comment">// å†™å…¥æ—¶é€šçŸ¥ Snapshot ç³»ç»Ÿ</span>
            <span class="code-func">writable</span>(firstStateRecord).value = value
        }
}</code></pre>

        <h3>StateRecordï¼šçŠ¶æ€çš„ç‰ˆæœ¬é“¾</h3>

        <p>æ¯ä¸ª <code>StateObject</code> ç»´æŠ¤ä¸€ä¸ª <code>StateRecord</code> é“¾è¡¨ï¼Œè®°å½•ä¸åŒæ—¶é—´ç‚¹çš„çŠ¶æ€å€¼ï¼š</p>

        <div class="diagram">
<pre>
<span class="highlight">StateRecord é“¾è¡¨ç»“æ„</span>

StateObject (MutableState)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StateRecord #3  â”‚â”€â”€â”€â–¶â”‚ StateRecord #2  â”‚â”€â”€â”€â–¶â”‚ StateRecord #1  â”‚
â”‚ snapshotId: 15  â”‚    â”‚ snapshotId: 10  â”‚    â”‚ snapshotId: 1   â”‚
â”‚ value: "C"      â”‚    â”‚ value: "B"      â”‚    â”‚ value: "A"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–²                                              â–²
      â”‚                                              â”‚
  æœ€æ–°ç‰ˆæœ¬                                        åˆå§‹ç‰ˆæœ¬

<span class="state">å½“å‰ Snapshot (id=12) çœ‹åˆ°çš„å€¼æ˜¯ "B"</span>
<span class="snapshot">å½“å‰ Snapshot (id=16) çœ‹åˆ°çš„å€¼æ˜¯ "C"</span>
</pre>
        </div>

        <p>è¿™ç§è®¾è®¡å…è®¸ä¸åŒçš„ Snapshot çœ‹åˆ°ä¸åŒç‰ˆæœ¬çš„çŠ¶æ€ï¼Œå®ç°äº†<strong>å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰</strong>ã€‚</p>

        <div class="callout callout-info">
            <p class="callout-title">ğŸ’¡ MVCC çš„ä¼˜åŠ¿</p>
            <p>å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶è®©è¯»æ“ä½œä¸ä¼šé˜»å¡å†™æ“ä½œï¼Œå†™æ“ä½œä¹Ÿä¸ä¼šé˜»å¡è¯»æ“ä½œã€‚è¿™å¯¹äº UI æ¡†æ¶è‡³å…³é‡è¦â€”â€”æˆ‘ä»¬ä¸å¸Œæœ›çŠ¶æ€æ›´æ–°é˜»å¡ UI æ¸²æŸ“ã€‚</p>
        </div>

        <h2>ä¸‰ã€Snapshot çš„è¯»å†™è¿½è¸ª</h2>

        <p>Snapshot ç³»ç»Ÿçš„æ ¸å¿ƒèƒ½åŠ›æ˜¯è¿½è¸ªçŠ¶æ€çš„è¯»å–å’Œå†™å…¥ã€‚</p>

        <h3>è¯»å–è¿½è¸ª</h3>

        <p>å½“ä½ è¯»å–ä¸€ä¸ª <code>MutableState</code> æ—¶ï¼ŒSnapshot ç³»ç»Ÿä¼šè®°å½•è¿™æ¬¡è¯»å–ï¼š</p>

<pre><code><span class="code-comment">// ä¼ªä»£ç ï¼šè¯»å–è¿½è¸ªæœºåˆ¶</span>
<span class="code-keyword">internal fun</span> &lt;<span class="code-type">T</span>&gt; <span class="code-func">readable</span>(record: <span class="code-type">StateRecord</span>): <span class="code-type">T</span> {
    <span class="code-comment">// 1. è·å–å½“å‰ Snapshot</span>
    <span class="code-keyword">val</span> snapshot = <span class="code-type">Snapshot</span>.current
    
    <span class="code-comment">// 2. æ‰¾åˆ°å¯¹å½“å‰ Snapshot å¯è§çš„è®°å½•</span>
    <span class="code-keyword">val</span> visibleRecord = record.<span class="code-func">findRecord</span>(snapshot.id)
    
    <span class="code-comment">// 3. é€šçŸ¥è¯»å–è§‚å¯Ÿè€…ï¼ˆå…³é”®ï¼ï¼‰</span>
    snapshot.readObserver?.<span class="code-func">invoke</span>(record.stateObject)
    
    <span class="code-keyword">return</span> visibleRecord.value
}</code></pre>

        <p>åœ¨ Composition æœŸé—´ï¼ŒCompose è®¾ç½®äº†è¯»å–è§‚å¯Ÿè€…æ¥æ”¶é›†ä¾èµ–ï¼š</p>

<pre><code><span class="code-comment">// Composition å¦‚ä½•è®¾ç½®è¯»å–è§‚å¯Ÿ</span>
<span class="code-keyword">fun</span> <span class="code-func">compose</span>(content: <span class="code-keyword">@Composable</span> () -> <span class="code-type">Unit</span>) {
    <span class="code-type">Snapshot</span>.<span class="code-func">observe</span>(
        readObserver = { state ->
            <span class="code-comment">// è®°å½•ï¼šå½“å‰ Composable ä¾èµ–è¿™ä¸ªçŠ¶æ€</span>
            currentScope.<span class="code-func">recordRead</span>(state)
        }
    ) {
        <span class="code-func">content</span>()
    }
}

<span class="code-comment">// è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Compose çŸ¥é“å“ªäº› Composable éœ€è¦é‡ç»„ï¼</span></code></pre>

        <h3>å†™å…¥è¿½è¸ª</h3>

        <p>å½“ä½ ä¿®æ”¹ä¸€ä¸ª <code>MutableState</code> æ—¶ï¼š</p>

<pre><code><span class="code-comment">// ä¼ªä»£ç ï¼šå†™å…¥è¿½è¸ªæœºåˆ¶</span>
<span class="code-keyword">internal fun</span> &lt;<span class="code-type">T</span>&gt; <span class="code-func">writable</span>(record: <span class="code-type">StateRecord</span>): <span class="code-type">T</span> {
    <span class="code-comment">// 1. è·å–å½“å‰ Snapshot</span>
    <span class="code-keyword">val</span> snapshot = <span class="code-type">Snapshot</span>.current
    
    <span class="code-comment">// 2. åˆ›å»ºæ–°çš„ StateRecordï¼ˆCopy-on-Writeï¼‰</span>
    <span class="code-keyword">val</span> newRecord = record.<span class="code-func">create</span>()
    newRecord.snapshotId = snapshot.id
    
    <span class="code-comment">// 3. é€šçŸ¥å†™å…¥è§‚å¯Ÿè€…</span>
    snapshot.writeObserver?.<span class="code-func">invoke</span>(record.stateObject)
    
    <span class="code-keyword">return</span> newRecord
}</code></pre>

        <p>å…¨å±€å†™å…¥è§‚å¯Ÿè€…è´Ÿè´£è§¦å‘é‡ç»„ï¼š</p>

<pre><code><span class="code-comment">// Compose å¦‚ä½•å“åº”çŠ¶æ€å˜åŒ–</span>
<span class="code-type">Snapshot</span>.<span class="code-func">registerGlobalWriteObserver</span> { changedStates ->
    <span class="code-comment">// å½“çŠ¶æ€å˜åŒ–æ—¶ï¼Œæ‰¾åˆ°ä¾èµ–è¿™äº›çŠ¶æ€çš„ Composable</span>
    changedStates.<span class="code-func">forEach</span> { state ->
        <span class="code-keyword">val</span> affectedScopes = dependencyTracker.<span class="code-func">getScopesFor</span>(state)
        affectedScopes.<span class="code-func">forEach</span> { scope ->
            scope.<span class="code-func">invalidate</span>()  <span class="code-comment">// æ ‡è®°éœ€è¦é‡ç»„</span>
        }
    }
}</code></pre>

        <h2>å››ã€Snapshot äº‹åŠ¡</h2>

        <p>Snapshot ç³»ç»Ÿæ”¯æŒç±»ä¼¼æ•°æ®åº“çš„äº‹åŠ¡æ“ä½œã€‚</p>

        <h3>MutableSnapshot</h3>

        <p>ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªå¯å˜ Snapshot æ¥éš”ç¦»çŠ¶æ€å˜åŒ–ï¼š</p>

<pre><code><span class="code-keyword">val</span> state = <span class="code-func">mutableStateOf</span>(<span class="code-number">0</span>)

<span class="code-comment">// åœ¨å…¨å±€ Snapshot ä¸­ï¼Œstate = 0</span>

<span class="code-keyword">val</span> snapshot = <span class="code-type">Snapshot</span>.<span class="code-func">takeMutableSnapshot</span>()
snapshot.<span class="code-func">enter</span> {
    <span class="code-comment">// åœ¨è¿™ä¸ª Snapshot ä¸­ä¿®æ”¹</span>
    state.value = <span class="code-number">42</span>
    
    <span class="code-comment">// åœ¨è¿™ä¸ª Snapshot ä¸­ï¼Œstate = 42</span>
    <span class="code-func">println</span>(state.value)  <span class="code-comment">// è¾“å‡º: 42</span>
}

<span class="code-comment">// åœ¨å…¨å±€ Snapshot ä¸­ï¼Œstate ä»ç„¶ = 0ï¼</span>
<span class="code-func">println</span>(state.value)  <span class="code-comment">// è¾“å‡º: 0</span>

<span class="code-comment">// æäº¤å˜åŒ–åˆ°å…¨å±€</span>
snapshot.<span class="code-func">apply</span>()

<span class="code-comment">// ç°åœ¨å…¨å±€ä¹Ÿæ˜¯ 42 äº†</span>
<span class="code-func">println</span>(state.value)  <span class="code-comment">// è¾“å‡º: 42</span></code></pre>

        <h3>äº‹åŠ¡éš”ç¦»çš„åº”ç”¨</h3>

        <p>Compose åœ¨å¤šä¸ªåœ°æ–¹ä½¿ç”¨äº‹åŠ¡éš”ç¦»ï¼š</p>

        <table class="comparison-table">
            <thead>
                <tr>
                    <th>åœºæ™¯</th>
                    <th>ä½¿ç”¨æ–¹å¼</th>
                    <th>ç›®çš„</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Composition</td>
                    <td>ReadonlySnapshot</td>
                    <td>ç¡®ä¿ç»„åˆæœŸé—´çŠ¶æ€ä¸€è‡´</td>
                </tr>
                <tr>
                    <td>çŠ¶æ€æ¢å¤</td>
                    <td>MutableSnapshot</td>
                    <td>æ‰¹é‡æ¢å¤çŠ¶æ€ï¼ŒåŸå­æäº¤</td>
                </tr>
                <tr>
                    <td>æµ‹è¯•</td>
                    <td>MutableSnapshot</td>
                    <td>éš”ç¦»æµ‹è¯•çŠ¶æ€ï¼Œä¸å½±å“å…¶ä»–æµ‹è¯•</td>
                </tr>
                <tr>
                    <td>åŠ¨ç”»é¢„è§ˆ</td>
                    <td>MutableSnapshot</td>
                    <td>é¢„è§ˆçŠ¶æ€å˜åŒ–è€Œä¸å®é™…æäº¤</td>
                </tr>
            </tbody>
        </table>

        <h3>å†²çªæ£€æµ‹ä¸è§£å†³</h3>

        <p>å½“å¤šä¸ª Snapshot ä¿®æ”¹åŒä¸€çŠ¶æ€æ—¶ï¼Œå¯èƒ½äº§ç”Ÿå†²çªï¼š</p>

<pre><code><span class="code-keyword">val</span> state = <span class="code-func">mutableStateOf</span>(<span class="code-number">0</span>)

<span class="code-keyword">val</span> snapshot1 = <span class="code-type">Snapshot</span>.<span class="code-func">takeMutableSnapshot</span>()
<span class="code-keyword">val</span> snapshot2 = <span class="code-type">Snapshot</span>.<span class="code-func">takeMutableSnapshot</span>()

snapshot1.<span class="code-func">enter</span> { state.value = <span class="code-number">1</span> }
snapshot2.<span class="code-func">enter</span> { state.value = <span class="code-number">2</span> }

snapshot1.<span class="code-func">apply</span>()  <span class="code-comment">// æˆåŠŸï¼Œstate = 1</span>
snapshot2.<span class="code-func">apply</span>()  <span class="code-comment">// å†²çªï¼æŠ›å‡º SnapshotApplyConflictException</span>

<span class="code-comment">// è§£å†³å†²çªï¼šä½¿ç”¨ applyTo å¹¶å¤„ç†å†²çª</span>
<span class="code-keyword">val</span> result = snapshot2.<span class="code-func">apply</span>()
<span class="code-keyword">if</span> (result <span class="code-keyword">is</span> <span class="code-type">SnapshotApplyResult.Failure</span>) {
    <span class="code-comment">// å¤„ç†å†²çª...</span>
}</code></pre>

        <div class="reference">
            <div class="reference-title">ğŸ“š æ·±å…¥é˜…è¯»</div>
            <a href="https://www.droidcon.com/2022/06/28/understanding-jetpack-compose-part-2-of-2/" target="_blank">Understanding Jetpack Compose - Leland Richardson</a>
        </div>

        <h2>äº”ã€snapshotFlowï¼šå°† Snapshot çŠ¶æ€è½¬ä¸º Flow</h2>

        <p><code>snapshotFlow</code> æ˜¯è¿æ¥ Snapshot ç³»ç»Ÿå’Œ Kotlin Flow çš„æ¡¥æ¢ï¼š</p>

<pre><code><span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">SearchScreen</span>(viewModel: <span class="code-type">SearchViewModel</span>) {
    <span class="code-keyword">var</span> query <span class="code-keyword">by</span> <span class="code-func">remember</span> { <span class="code-func">mutableStateOf</span>(<span class="code-string">""</span>) }
    
    <span class="code-comment">// å°† Compose çŠ¶æ€è½¬ä¸º Flow</span>
    <span class="code-func">LaunchedEffect</span>(<span class="code-type">Unit</span>) {
        <span class="code-func">snapshotFlow</span> { query }
            .<span class="code-func">debounce</span>(<span class="code-number">300</span>)
            .<span class="code-func">distinctUntilChanged</span>()
            .<span class="code-func">collect</span> { searchQuery ->
                viewModel.<span class="code-func">search</span>(searchQuery)
            }
    }
    
    <span class="code-func">TextField</span>(
        value = query,
        onValueChange = { query = it }
    )
}</code></pre>

        <h3>snapshotFlow çš„å®ç°åŸç†</h3>

<pre><code><span class="code-comment">// snapshotFlow ç®€åŒ–å®ç°</span>
<span class="code-keyword">fun</span> &lt;<span class="code-type">T</span>&gt; <span class="code-func">snapshotFlow</span>(block: () -> <span class="code-type">T</span>): <span class="code-type">Flow</span>&lt;<span class="code-type">T</span>&gt; = <span class="code-func">flow</span> {
    <span class="code-keyword">var</span> previousValue: <span class="code-type">T</span>? = <span class="code-keyword">null</span>
    
    <span class="code-keyword">while</span> (<span class="code-keyword">true</span>) {
        <span class="code-comment">// åœ¨ Snapshot ä¸­æ‰§è¡Œ blockï¼ŒåŒæ—¶æ”¶é›†è¯»å–çš„çŠ¶æ€</span>
        <span class="code-keyword">val</span> readStates = <span class="code-func">mutableSetOf</span>&lt;<span class="code-type">StateObject</span>&gt;()
        <span class="code-keyword">val</span> value = <span class="code-type">Snapshot</span>.<span class="code-func">observe</span>(
            readObserver = { readStates.<span class="code-func">add</span>(it) }
        ) {
            <span class="code-func">block</span>()
        }
        
        <span class="code-comment">// å¦‚æœå€¼å˜åŒ–äº†ï¼Œå‘å°„æ–°å€¼</span>
        <span class="code-keyword">if</span> (value != previousValue) {
            <span class="code-func">emit</span>(value)
            previousValue = value
        }
        
        <span class="code-comment">// ç­‰å¾…ä»»ä¸€è¯»å–çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–</span>
        <span class="code-func">suspendUntilAnyChange</span>(readStates)
    }
}</code></pre>

        <h2>å…­ã€derivedStateOfï¼šæ´¾ç”ŸçŠ¶æ€çš„ä¼˜åŒ–</h2>

        <p><code>derivedStateOf</code> åˆ©ç”¨ Snapshot ç³»ç»Ÿå®ç°é«˜æ•ˆçš„æ´¾ç”ŸçŠ¶æ€è®¡ç®—ï¼š</p>

<pre><code><span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">FilteredList</span>(items: <span class="code-type">List</span>&lt;<span class="code-type">Item</span>&gt;, filter: <span class="code-type">String</span>) {
    <span class="code-comment">// âŒ æ¯æ¬¡é‡ç»„éƒ½é‡æ–°è¿‡æ»¤</span>
    <span class="code-keyword">val</span> filtered = items.<span class="code-func">filter</span> { it.name.<span class="code-func">contains</span>(filter) }
    
    <span class="code-comment">// âœ… åªæœ‰å½“ items æˆ– filter å˜åŒ–æ—¶æ‰é‡æ–°è®¡ç®—</span>
    <span class="code-keyword">val</span> filtered <span class="code-keyword">by</span> <span class="code-func">remember</span>(items, filter) {
        <span class="code-func">derivedStateOf</span> {
            items.<span class="code-func">filter</span> { it.name.<span class="code-func">contains</span>(filter) }
        }
    }
}</code></pre>

        <h3>derivedStateOf çš„å·¥ä½œåŸç†</h3>

        <div class="diagram">
<pre>
<span class="highlight">derivedStateOf ä¾èµ–è¿½è¸ª</span>

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                              â”‚
â”‚  <span class="state">items</span>  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚                  â”‚                                          â”‚
â”‚                  â–¼                                          â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚          â”‚ <span class="snapshot">derivedStateOf</span>  â”‚                               â”‚
â”‚  <span class="state">filter</span> â”€â–¶â”‚                 â”‚â”€â”€â–¶ <span class="observer">filteredItems</span>            â”‚
â”‚          â”‚ è¿½è¸ªä¾èµ–        â”‚                               â”‚
â”‚          â”‚ ç¼“å­˜ç»“æœ        â”‚                               â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                              â”‚
â”‚  å½“ items æˆ– filter å˜åŒ–æ—¶ï¼š                                 â”‚
â”‚  1. derivedStateOf æ”¶åˆ°é€šçŸ¥                                 â”‚
â”‚  2. é‡æ–°æ‰§è¡Œè®¡ç®—                                            â”‚
â”‚  3. å¦‚æœç»“æœå˜åŒ–ï¼Œé€šçŸ¥ä¸‹æ¸¸è§‚å¯Ÿè€…                             â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
        </div>

<pre><code><span class="code-comment">// derivedStateOf ç®€åŒ–å®ç°</span>
<span class="code-keyword">class</span> <span class="code-type">DerivedSnapshotState</span>&lt;<span class="code-type">T</span>&gt;(
    <span class="code-keyword">private val</span> calculation: () -> <span class="code-type">T</span>
) : <span class="code-type">State</span>&lt;<span class="code-type">T</span>&gt; {
    
    <span class="code-keyword">private var</span> cachedValue: <span class="code-type">T</span>? = <span class="code-keyword">null</span>
    <span class="code-keyword">private var</span> dependencies = <span class="code-func">setOf</span>&lt;<span class="code-type">StateObject</span>&gt;()
    <span class="code-keyword">private var</span> isValid = <span class="code-keyword">false</span>
    
    <span class="code-keyword">override val</span> value: <span class="code-type">T</span>
        <span class="code-keyword">get</span>() {
            <span class="code-keyword">if</span> (!isValid || <span class="code-func">dependenciesChanged</span>()) {
                <span class="code-comment">// é‡æ–°è®¡ç®—ï¼ŒåŒæ—¶è¿½è¸ªæ–°çš„ä¾èµ–</span>
                <span class="code-keyword">val</span> newDeps = <span class="code-func">mutableSetOf</span>&lt;<span class="code-type">StateObject</span>&gt;()
                cachedValue = <span class="code-type">Snapshot</span>.<span class="code-func">observe</span>(
                    readObserver = { newDeps.<span class="code-func">add</span>(it) }
                ) {
                    <span class="code-func">calculation</span>()
                }
                dependencies = newDeps
                isValid = <span class="code-keyword">true</span>
            }
            <span class="code-keyword">return</span> cachedValue!!
        }
}</code></pre>

        <div class="callout callout-warning">
            <p class="callout-title">âš ï¸ derivedStateOf çš„å¸¸è§è¯¯ç”¨</p>
            <p>ä¸è¦åœ¨ <code>derivedStateOf</code> ä¸­å¼•ç”¨ Composable å‚æ•°ï¼Œå› ä¸ºå‚æ•°å˜åŒ–ä¸ä¼šè§¦å‘é‡æ–°è®¡ç®—ã€‚å§‹ç»ˆä½¿ç”¨ <code>remember(key)</code> æ¥å¤„ç†å‚æ•°ä¾èµ–ã€‚</p>
        </div>

        <h2>ä¸ƒã€Snapshot ä¸çº¿ç¨‹å®‰å…¨</h2>

        <p>Snapshot ç³»ç»Ÿå¤©ç„¶æ”¯æŒå¤šçº¿ç¨‹è®¿é—®ã€‚</p>

        <h3>çº¿ç¨‹æœ¬åœ° Snapshot</h3>

        <p>æ¯ä¸ªçº¿ç¨‹å¯ä»¥æœ‰è‡ªå·±çš„ Snapshot è§†å›¾ï¼š</p>

<pre><code><span class="code-keyword">val</span> state = <span class="code-func">mutableStateOf</span>(<span class="code-number">0</span>)

<span class="code-comment">// ä¸»çº¿ç¨‹</span>
<span class="code-func">launch</span>(<span class="code-type">Dispatchers</span>.Main) {
    state.value = <span class="code-number">1</span>
    <span class="code-func">println</span>(<span class="code-string">"Main: </span>${state.value}<span class="code-string">"</span>)  <span class="code-comment">// 1</span>
}

<span class="code-comment">// åå°çº¿ç¨‹</span>
<span class="code-func">launch</span>(<span class="code-type">Dispatchers</span>.IO) {
    <span class="code-comment">// åˆ›å»ºç‹¬ç«‹çš„ Snapshot</span>
    <span class="code-type">Snapshot</span>.<span class="code-func">takeSnapshot</span>().<span class="code-func">enter</span> {
        <span class="code-func">println</span>(<span class="code-string">"IO: </span>${state.value}<span class="code-string">"</span>)  <span class="code-comment">// å¯èƒ½æ˜¯ 0 æˆ– 1</span>
    }
}</code></pre>

        <h3>withMutableSnapshotï¼šçº¿ç¨‹å®‰å…¨çš„çŠ¶æ€ä¿®æ”¹</h3>

<pre><code><span class="code-comment">// åœ¨ä»»æ„çº¿ç¨‹å®‰å…¨åœ°ä¿®æ”¹çŠ¶æ€</span>
<span class="code-func">launch</span>(<span class="code-type">Dispatchers</span>.IO) {
    <span class="code-type">Snapshot</span>.<span class="code-func">withMutableSnapshot</span> {
        <span class="code-comment">// è¿™é‡Œçš„ä¿®æ”¹æ˜¯åŸå­çš„</span>
        state1.value = <span class="code-string">"new value"</span>
        state2.value = <span class="code-number">42</span>
    }
    <span class="code-comment">// é€€å‡ºæ—¶è‡ªåŠ¨ apply</span>
}</code></pre>

        <h2>å…«ã€å®æˆ˜ï¼šè‡ªå®šä¹‰ StateObject</h2>

        <p>ä½ å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰çš„çŠ¶æ€ç±»å‹ï¼Œå‚ä¸ Snapshot ç³»ç»Ÿï¼š</p>

<pre><code><span class="code-comment">// è‡ªå®šä¹‰è®¡æ•°å™¨çŠ¶æ€</span>
<span class="code-keyword">class</span> <span class="code-type">SnapshotCounter</span> : <span class="code-type">StateObject</span> {
    
    <span class="code-keyword">private class</span> <span class="code-type">CounterRecord</span> : <span class="code-type">StateRecord</span>() {
        <span class="code-keyword">var</span> count: <span class="code-type">Int</span> = <span class="code-number">0</span>
        
        <span class="code-keyword">override fun</span> <span class="code-func">create</span>() = <span class="code-type">CounterRecord</span>()
        
        <span class="code-keyword">override fun</span> <span class="code-func">assign</span>(value: <span class="code-type">StateRecord</span>) {
            count = (value <span class="code-keyword">as</span> <span class="code-type">CounterRecord</span>).count
        }
    }
    
    <span class="code-keyword">override var</span> firstStateRecord: <span class="code-type">StateRecord</span> = <span class="code-type">CounterRecord</span>()
    
    <span class="code-keyword">override fun</span> <span class="code-func">prependStateRecord</span>(value: <span class="code-type">StateRecord</span>) {
        value.next = firstStateRecord
        firstStateRecord = value
    }
    
    <span class="code-keyword">val</span> count: <span class="code-type">Int</span>
        <span class="code-keyword">get</span>() = <span class="code-func">readable</span>(firstStateRecord).count
    
    <span class="code-keyword">fun</span> <span class="code-func">increment</span>() {
        <span class="code-func">writable</span>(firstStateRecord).count++
    }
    
    <span class="code-keyword">fun</span> <span class="code-func">decrement</span>() {
        <span class="code-func">writable</span>(firstStateRecord).count--
    }
    
    <span class="code-keyword">private fun</span> <span class="code-func">readable</span>(record: <span class="code-type">StateRecord</span>): <span class="code-type">CounterRecord</span> {
        <span class="code-keyword">return</span> <span class="code-type">Snapshot</span>.current.<span class="code-func">readable</span>(record, <span class="code-keyword">this</span>) <span class="code-keyword">as</span> <span class="code-type">CounterRecord</span>
    }
    
    <span class="code-keyword">private fun</span> <span class="code-func">writable</span>(record: <span class="code-type">StateRecord</span>): <span class="code-type">CounterRecord</span> {
        <span class="code-keyword">return</span> <span class="code-type">Snapshot</span>.current.<span class="code-func">writable</span>(record, <span class="code-keyword">this</span>) <span class="code-keyword">as</span> <span class="code-type">CounterRecord</span>
    }
}</code></pre>

        <h2>ä¹ã€è°ƒè¯• Snapshot ç³»ç»Ÿ</h2>

        <h3>ä½¿ç”¨ Snapshot ç›‘å¬å™¨</h3>

<pre><code><span class="code-comment">// ç›‘å¬æ‰€æœ‰çŠ¶æ€å˜åŒ–</span>
<span class="code-keyword">val</span> handle = <span class="code-type">Snapshot</span>.<span class="code-func">registerGlobalWriteObserver</span> { changedObjects ->
    changedObjects.<span class="code-func">forEach</span> { obj ->
        <span class="code-func">println</span>(<span class="code-string">"State changed: </span>$obj<span class="code-string">"</span>)
    }
}

<span class="code-comment">// ä¸å†éœ€è¦æ—¶ç§»é™¤</span>
handle.<span class="code-func">dispose</span>()</code></pre>

        <h3>ä½¿ç”¨ Composition Tracing</h3>

<pre><code><span class="code-comment">// åœ¨ Debug æ„å»ºä¸­å¯ç”¨è¿½è¸ª</span>
<span class="code-keyword">if</span> (<span class="code-type">BuildConfig</span>.DEBUG) {
    <span class="code-type">Composer</span>.enableTracing = <span class="code-keyword">true</span>
}</code></pre>

        <h2>åã€æœ€ä½³å®è·µ</h2>

        <h3>DO âœ…</h3>

        <ul>
            <li>ä½¿ç”¨ <code>mutableStateOf</code> è€Œéæ™®é€šå˜é‡æ¥å­˜å‚¨ UI çŠ¶æ€</li>
            <li>ä½¿ç”¨ <code>derivedStateOf</code> ç¼“å­˜æ˜‚è´µçš„è®¡ç®—</li>
            <li>ä½¿ç”¨ <code>snapshotFlow</code> å°† Compose çŠ¶æ€è¿æ¥åˆ° Flow</li>
            <li>åœ¨åå°çº¿ç¨‹ä¿®æ”¹çŠ¶æ€æ—¶ä½¿ç”¨ <code>withMutableSnapshot</code></li>
        </ul>

        <h3>DON'T âŒ</h3>

        <ul>
            <li>ä¸è¦åœ¨ Composable å¤–éƒ¨ç›´æ¥ä¿®æ”¹çŠ¶æ€ï¼ˆé™¤éåœ¨æ­£ç¡®çš„ Snapshot ä¸Šä¸‹æ–‡ä¸­ï¼‰</li>
            <li>ä¸è¦å¿½ç•¥ <code>snapshotFlow</code> çš„æ”¶é›†â€”â€”å®ƒä¼šæŒç»­è¿è¡Œ</li>
            <li>ä¸è¦åœ¨ <code>derivedStateOf</code> ä¸­æ‰§è¡Œå‰¯ä½œç”¨</li>
            <li>ä¸è¦æ‰‹åŠ¨ç®¡ç† Snapshot ç”Ÿå‘½å‘¨æœŸï¼ˆé™¤éä½ çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆï¼‰</li>
        </ul>

        <h2>æ€»ç»“</h2>

        <p>Snapshot ç³»ç»Ÿæ˜¯ Compose å“åº”å¼çš„åŸºçŸ³ï¼š</p>

        <ul>
            <li><strong>StateObject/StateRecord</strong>ï¼šå¤šç‰ˆæœ¬çŠ¶æ€å­˜å‚¨</li>
            <li><strong>è¯»å†™è¿½è¸ª</strong>ï¼šè‡ªåŠ¨æ”¶é›†ä¾èµ–å’Œè§¦å‘æ›´æ–°</li>
            <li><strong>äº‹åŠ¡éš”ç¦»</strong>ï¼šç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§</li>
            <li><strong>snapshotFlow</strong>ï¼šè¿æ¥ Compose å’Œ Flow</li>
            <li><strong>derivedStateOf</strong>ï¼šé«˜æ•ˆçš„æ´¾ç”ŸçŠ¶æ€</li>
        </ul>

        <p>ç†è§£ Snapshot ç³»ç»Ÿä¸ä»…èƒ½å¸®åŠ©ä½ å†™å‡ºæ›´é«˜æ•ˆçš„ Compose ä»£ç ï¼Œè¿˜èƒ½è®©ä½ åœ¨é‡åˆ°çŠ¶æ€ç›¸å…³é—®é¢˜æ—¶æ›´å®¹æ˜“å®šä½å’Œè§£å†³ã€‚</p>

        <div class="reference">
            <div class="reference-title">ğŸ“š æ¨èé˜…è¯»</div>
            <a href="https://developer.android.com/jetpack/compose/state" target="_blank">State and Jetpack Compose - Android Developers</a><br>
            <a href="https://www.youtube.com/watch?v=Q9MtlmmN4Q0" target="_blank">Compose Internals - Leland Richardson (Video)</a><br>
            <a href="https://jorgecastillo.dev/book/" target="_blank">Jetpack Compose Internals - Jorge Castillo</a>
        </div>
    </article>

    <footer class="footer">
        <p>&copy; 2024 Fidroid. <a href="../index.html">è¿”å›é¦–é¡µ</a></p>
    </footer>
</body>
</html>

