<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compose ç¨³å®šæ€§ç³»ç»Ÿï¼š@Stableã€@Immutable ä¸æ™ºèƒ½é‡ç»„ - Fidroid</title>
    <meta name="description" content="æ·±å…¥ç†è§£ Compose çš„ç¨³å®šæ€§æ¨æ–­æœºåˆ¶ï¼ŒæŒæ¡ @Stable å’Œ @Immutable æ³¨è§£çš„æ­£ç¡®ä½¿ç”¨ï¼Œé¿å…ä¸å¿…è¦çš„é‡ç»„ã€‚">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.8;
            color: #e5e7eb;
            background: #020617;
        }
        .navbar {
            background: rgba(15,23,42,0.98);
            backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }
        .nav-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #38bdf8;
            text-decoration: none;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .back-link { color: #9ca3af; text-decoration: none; font-size: 0.9rem; }
        .back-link:hover { color: #38bdf8; }

        .article-header {
            padding: 120px 20px 60px;
            background: radial-gradient(circle at top left, #059669 0, transparent 50%),
                        radial-gradient(circle at bottom right, #7c3aed 0, transparent 55%),
                        #020617;
            text-align: center;
        }
        .article-header h1 {
            max-width: 800px;
            margin: 0 auto 1rem;
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            color: #fff;
        }
        .article-meta { color: #9ca3af; font-size: 0.9rem; margin-bottom: 1.5rem; }
        .article-tags { display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem; }
        .article-tag {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            background: rgba(15,23,42,0.85);
            border: 1px solid rgba(5,150,105,0.4);
            color: #6ee7b7;
        }

        .article-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 60px 20px 80px;
        }
        .article-content h2 {
            font-size: 1.6rem;
            margin: 2.5rem 0 1rem;
            color: #f9fafb;
            border-left: 4px solid #059669;
            padding-left: 1rem;
        }
        .article-content h3 { font-size: 1.25rem; margin: 2rem 0 0.75rem; color: #e5e7eb; }
        .article-content p { margin-bottom: 1.25rem; color: #d1d5db; }
        .article-content ul, .article-content ol { margin: 1rem 0 1.5rem 1.5rem; color: #d1d5db; }
        .article-content li { margin-bottom: 0.5rem; }
        .article-content strong { color: #f9fafb; }
        .article-content a { color: #38bdf8; text-decoration: underline; }

        pre {
            background: #0f172a;
            border: 1px solid rgba(5,150,105,0.3);
            border-radius: 12px;
            padding: 1.25rem;
            overflow-x: auto;
            margin: 1.5rem 0;
            font-size: 0.85rem;
            line-height: 1.6;
        }
        code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; color: #e5e7eb; }
        .code-keyword { color: #c084fc; }
        .code-func { color: #38bdf8; }
        .code-type { color: #4ade80; }
        .code-string { color: #fb7185; }
        .code-comment { color: #6b7280; font-style: italic; }
        .code-number { color: #fbbf24; }
        .code-annotation { color: #f472b6; }

        .callout {
            background: rgba(5,150,105,0.1);
            border: 1px solid rgba(5,150,105,0.3);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            margin: 1.5rem 0;
        }
        .callout-title { font-weight: 600; color: #6ee7b7; margin-bottom: 0.5rem; }
        .callout p { margin-bottom: 0; color: #d1d5db; }

        .callout-warning {
            background: rgba(245,158,11,0.1);
            border: 1px solid rgba(245,158,11,0.3);
        }
        .callout-warning .callout-title { color: #fcd34d; }

        .callout-info {
            background: rgba(14,165,233,0.1);
            border: 1px solid rgba(14,165,233,0.3);
        }
        .callout-info .callout-title { color: #7dd3fc; }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.9rem;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid rgba(148,163,184,0.3);
            padding: 0.75rem 1rem;
            text-align: left;
        }
        .comparison-table th {
            background: rgba(15,23,42,0.8);
            color: #f9fafb;
        }
        .comparison-table td { color: #d1d5db; }

        .reference {
            background: rgba(15,23,42,0.6);
            border: 1px solid rgba(148,163,184,0.2);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        .reference-title {
            font-weight: 600;
            color: #94a3b8;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        .reference a { color: #38bdf8; }

        .diagram {
            background: #0f172a;
            border: 1px solid rgba(5,150,105,0.3);
            border-radius: 12px;
            padding: 2rem;
            margin: 1.5rem 0;
            text-align: center;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.85rem;
            line-height: 1.8;
            color: #94a3b8;
            overflow-x: auto;
        }
        .diagram .stable { color: #4ade80; }
        .diagram .unstable { color: #f87171; }
        .diagram .highlight { color: #c084fc; font-weight: bold; }

        .footer {
            background: #020617;
            border-top: 1px solid #111827;
            padding: 2rem;
            text-align: center;
            color: #6b7280;
        }
        .footer a { color: #38bdf8; text-decoration: none; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="logo">Fidroid</a>
            <a href="../index.html#blog" class="back-link">â† è¿”å›åšå®¢åˆ—è¡¨</a>
        </div>
    </nav>

    <header class="article-header">
        <h1>Compose ç¨³å®šæ€§ç³»ç»Ÿï¼š@Stableã€@Immutable ä¸æ™ºèƒ½é‡ç»„</h1>
        <p class="article-meta">2024-04-28 Â· 28 min Â· åŸç†æ·±åº¦è§£æ</p>
        <div class="article-tags">
            <span class="article-tag">Stability</span>
            <span class="article-tag">@Stable</span>
            <span class="article-tag">@Immutable</span>
            <span class="article-tag">Smart Recomposition</span>
        </div>
    </header>

    <article class="article-content">
        <p>ä¸ºä»€ä¹ˆæœ‰äº› Composable ä¼šè¢«è·³è¿‡é‡ç»„ï¼Œè€Œæœ‰äº›å´æ¯æ¬¡éƒ½é‡æ–°æ‰§è¡Œï¼Ÿç­”æ¡ˆåœ¨äº Compose çš„<strong>ç¨³å®šæ€§ç³»ç»Ÿï¼ˆStability Systemï¼‰</strong>ã€‚ç†è§£è¿™ä¸ªç³»ç»Ÿæ˜¯ä¼˜åŒ– Compose æ€§èƒ½çš„å…³é”®ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ç¨³å®šæ€§æ¨æ–­çš„åŸç†ã€<code>@Stable</code> å’Œ <code>@Immutable</code> æ³¨è§£çš„åŒºåˆ«ï¼Œä»¥åŠå¦‚ä½•è¯Šæ–­å’Œä¿®å¤ç¨³å®šæ€§é—®é¢˜ã€‚</p>

        <div class="reference">
            <div class="reference-title">ğŸ“š å®˜æ–¹å‚è€ƒ</div>
            <a href="https://developer.android.com/jetpack/compose/performance/stability" target="_blank">Stability in Compose - Android Developers</a><br>
            <a href="https://github.com/androidx/androidx/blob/androidx-main/compose/compiler/design/compiler-metrics.md" target="_blank">Compose Compiler Metrics</a>
        </div>

        <h2>ä¸€ã€ä»€ä¹ˆæ˜¯ç¨³å®šæ€§ï¼Ÿ</h2>

        <p>åœ¨ Compose ä¸­ï¼Œ<strong>ç¨³å®šæ€§</strong>æŒ‡çš„æ˜¯ç¼–è¯‘å™¨èƒ½å¦å®‰å…¨åœ°å‡è®¾ï¼šå¦‚æœä¸€ä¸ªå€¼çš„ <code>equals()</code> è¿”å› trueï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼åœ¨ä¸¤æ¬¡ç»„åˆä¹‹é—´æ²¡æœ‰å‘ç”Ÿå˜åŒ–ã€‚</p>

        <p>è¿™ä¸ªå‡è®¾éå¸¸é‡è¦ï¼Œå› ä¸ºå®ƒå†³å®šäº† Compose èƒ½å¦<strong>è·³è¿‡é‡ç»„</strong>ï¼š</p>

<pre><code><span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">UserCard</span>(user: <span class="code-type">User</span>) {
    <span class="code-comment">// å¦‚æœ user æ˜¯"ç¨³å®šçš„"ï¼Œä¸” equals() è¿”å› true</span>
    <span class="code-comment">// Compose å¯ä»¥è·³è¿‡è¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œ</span>
    <span class="code-func">Text</span>(user.name)
    <span class="code-func">Text</span>(user.email)
}</code></pre>

        <h3>ç¨³å®šæ€§çš„ä¸‰ä¸ªæ¡ä»¶</h3>

        <p>ä¸€ä¸ªç±»å‹è¢«è®¤ä¸ºæ˜¯<strong>ç¨³å®šçš„</strong>ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p>

        <ol>
            <li><strong>equals() ä¸€è‡´æ€§</strong>ï¼šå¯¹äºç›¸åŒçš„ä¸¤ä¸ªå®ä¾‹ï¼Œ<code>equals()</code> çš„ç»“æœæ°¸è¿œç›¸åŒ</li>
            <li><strong>å…¬å¼€å±æ€§å˜åŒ–é€šçŸ¥</strong>ï¼šå¦‚æœå…¬å¼€å±æ€§å‘ç”Ÿå˜åŒ–ï¼ŒComposition ä¼šè¢«é€šçŸ¥ï¼ˆé€šè¿‡ Snapshot ç³»ç»Ÿï¼‰</li>
            <li><strong>å…¬å¼€å±æ€§ä¹Ÿæ˜¯ç¨³å®šçš„</strong>ï¼šæ‰€æœ‰å…¬å¼€å±æ€§çš„ç±»å‹ä¹Ÿå¿…é¡»æ˜¯ç¨³å®šçš„</li>
        </ol>

        <div class="callout callout-info">
            <p class="callout-title">ğŸ’¡ æ ¸å¿ƒæ´å¯Ÿ</p>
            <p>ç¨³å®šæ€§ä¸æ˜¯å…³äº"å€¼æ˜¯å¦ä¼šå˜åŒ–"ï¼Œè€Œæ˜¯å…³äº"<strong>å¦‚æœå€¼å˜åŒ–äº†ï¼ŒCompose èƒ½å¦çŸ¥é“</strong>"ã€‚ä¸€ä¸ª <code>MutableState</code> æ˜¯ç¨³å®šçš„ï¼Œå› ä¸ºå®ƒçš„å˜åŒ–ä¼šé€šè¿‡ Snapshot ç³»ç»Ÿé€šçŸ¥ Composeã€‚</p>
        </div>

        <h2>äºŒã€ç¼–è¯‘å™¨çš„ç¨³å®šæ€§æ¨æ–­</h2>

        <p>Compose ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åˆ†æç±»å‹çš„ç¨³å®šæ€§ã€‚ä»¥ä¸‹ç±»å‹è¢«è‡ªåŠ¨è®¤ä¸ºæ˜¯ç¨³å®šçš„ï¼š</p>

        <table class="comparison-table">
            <thead>
                <tr>
                    <th>ç±»å‹</th>
                    <th>ç¨³å®šæ€§</th>
                    <th>åŸå› </th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>åŸºæœ¬ç±»å‹ (Int, Float, Boolean...)</td>
                    <td>âœ… ç¨³å®š</td>
                    <td>ä¸å¯å˜</td>
                </tr>
                <tr>
                    <td>String</td>
                    <td>âœ… ç¨³å®š</td>
                    <td>ä¸å¯å˜</td>
                </tr>
                <tr>
                    <td>å‡½æ•°ç±»å‹ (Lambda)</td>
                    <td>âœ… ç¨³å®š</td>
                    <td>å‡½æ•°æœ¬èº«ä¸å˜</td>
                </tr>
                <tr>
                    <td>MutableState&lt;T&gt;</td>
                    <td>âœ… ç¨³å®š</td>
                    <td>å˜åŒ–ä¼šé€šçŸ¥ Snapshot</td>
                </tr>
                <tr>
                    <td>åªå«ä¸å¯å˜å±æ€§çš„ data class</td>
                    <td>âœ… ç¨³å®š</td>
                    <td>ç¼–è¯‘å™¨æ¨æ–­</td>
                </tr>
                <tr>
                    <td>List, Set, Map</td>
                    <td>âŒ ä¸ç¨³å®š</td>
                    <td>å¯èƒ½æ˜¯å¯å˜å®ç°</td>
                </tr>
                <tr>
                    <td>å¤–éƒ¨æ¨¡å—çš„ç±»</td>
                    <td>âŒ ä¸ç¨³å®š</td>
                    <td>ç¼–è¯‘å™¨æ— æ³•åˆ†æ</td>
                </tr>
            </tbody>
        </table>

        <h3>ä¸ºä»€ä¹ˆ List ä¸ç¨³å®šï¼Ÿ</h3>

        <p>è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„å›°æƒ‘ç‚¹ã€‚è™½ç„¶ Kotlin çš„ <code>List</code> æ¥å£æ˜¯åªè¯»çš„ï¼Œä½†å®ƒå¯èƒ½æŒ‡å‘ä¸€ä¸ª <code>MutableList</code> å®ä¾‹ï¼š</p>

<pre><code><span class="code-keyword">val</span> mutableList = <span class="code-func">mutableListOf</span>(<span class="code-number">1</span>, <span class="code-number">2</span>, <span class="code-number">3</span>)
<span class="code-keyword">val</span> list: <span class="code-type">List</span>&lt;<span class="code-type">Int</span>&gt; = mutableList  <span class="code-comment">// ç±»å‹æ˜¯ Listï¼Œä½†å®é™…æ˜¯ MutableList</span>

mutableList.<span class="code-func">add</span>(<span class="code-number">4</span>)  <span class="code-comment">// ä¿®æ”¹äº†ï¼ä½† Compose ä¸çŸ¥é“</span>

<span class="code-comment">// list.equals(list) ä»ç„¶è¿”å› true</span>
<span class="code-comment">// ä½†å†…å®¹å·²ç»å˜äº†ï¼ŒCompose æ— æ³•æ£€æµ‹åˆ°</span></code></pre>

        <p>å› ä¸ºç¼–è¯‘å™¨æ— æ³•ä¿è¯ <code>List</code> çš„å®é™…å®ç°æ˜¯ä¸å¯å˜çš„ï¼Œæ‰€ä»¥å®ƒä¿å®ˆåœ°å°†å…¶æ ‡è®°ä¸ºä¸ç¨³å®šã€‚</p>

        <div class="reference">
            <div class="reference-title">ğŸ“š æ·±å…¥é˜…è¯»</div>
            <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.collections/-list/" target="_blank">Kotlin List Interface</a> - æ³¨æ„å®ƒåªæ˜¯"åªè¯»"è€Œé"ä¸å¯å˜"
        </div>

        <h2>ä¸‰ã€@Stable ä¸ @Immutable æ³¨è§£</h2>

        <p>å½“ç¼–è¯‘å™¨æ— æ³•è‡ªåŠ¨æ¨æ–­ç¨³å®šæ€§æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨æ³¨è§£æ¥æ‰‹åŠ¨å£°æ˜ï¼š</p>

        <h3>@Immutable</h3>

        <p><code>@Immutable</code> è¡¨ç¤ºä¸€ä¸ªç±»å‹æ˜¯<strong>å®Œå…¨ä¸å¯å˜çš„</strong>ï¼šåˆ›å»ºåï¼Œæ‰€æœ‰å±æ€§çš„å€¼æ°¸è¿œä¸ä¼šæ”¹å˜ã€‚</p>

<pre><code><span class="code-annotation">@Immutable</span>
<span class="code-keyword">data class</span> <span class="code-type">User</span>(
    <span class="code-keyword">val</span> id: <span class="code-type">String</span>,
    <span class="code-keyword">val</span> name: <span class="code-type">String</span>,
    <span class="code-keyword">val</span> email: <span class="code-type">String</span>
)

<span class="code-comment">// ä½¿ç”¨ @Immutable çš„æ‰¿è¯ºï¼š</span>
<span class="code-comment">// 1. æ‰€æœ‰å±æ€§éƒ½æ˜¯ valï¼ˆä¸å¯å˜ï¼‰</span>
<span class="code-comment">// 2. å±æ€§çš„ç±»å‹ä¹Ÿæ˜¯ä¸å¯å˜çš„</span>
<span class="code-comment">// 3. åˆ›å»ºåæ°¸è¿œä¸ä¼šè¢«ä¿®æ”¹</span></code></pre>

        <h3>@Stable</h3>

        <p><code>@Stable</code> æ˜¯ä¸€ä¸ªæ›´å®½æ¾çš„å¥‘çº¦ï¼šå€¼<strong>å¯ä»¥å˜åŒ–</strong>ï¼Œä½†å˜åŒ–ä¼šé€šè¿‡ Compose çš„ Snapshot ç³»ç»Ÿè¢«è¿½è¸ªã€‚</p>

<pre><code><span class="code-annotation">@Stable</span>
<span class="code-keyword">class</span> <span class="code-type">UserState</span>(
    initialName: <span class="code-type">String</span>
) {
    <span class="code-keyword">var</span> name <span class="code-keyword">by</span> <span class="code-func">mutableStateOf</span>(initialName)
        <span class="code-keyword">private set</span>
    
    <span class="code-keyword">fun</span> <span class="code-func">updateName</span>(newName: <span class="code-type">String</span>) {
        name = newName  <span class="code-comment">// å˜åŒ–ä¼šè¢« Snapshot è¿½è¸ª</span>
    }
}

<span class="code-comment">// ä½¿ç”¨ @Stable çš„æ‰¿è¯ºï¼š</span>
<span class="code-comment">// 1. equals() ç»“æœä¸€è‡´ï¼ˆç›¸åŒå®ä¾‹æ€»æ˜¯è¿”å› trueï¼‰</span>
<span class="code-comment">// 2. å±æ€§å˜åŒ–ä¼šé€šçŸ¥ Composition</span>
<span class="code-comment">// 3. æ‰€æœ‰å…¬å¼€å±æ€§ä¹Ÿæ˜¯ç¨³å®šçš„</span></code></pre>

        <h3>é€‰æ‹©å“ªä¸ªæ³¨è§£ï¼Ÿ</h3>

        <div class="diagram">
<pre>
<span class="highlight">å†³ç­–æµç¨‹</span>

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ ç±»çš„æ‰€æœ‰å±æ€§éƒ½æ˜¯  â”‚
                    â”‚ val ä¸”ä¸å¯å˜ï¼Ÿ    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                               â”‚
              â–¼                               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   æ˜¯    â”‚                     â”‚   å¦    â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
             â”‚                               â”‚
             â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ <span class="stable">@Immutable</span>     â”‚            â”‚ å¯å˜å±æ€§æ˜¯å¦é€šè¿‡    â”‚
    â”‚                â”‚            â”‚ MutableState ç®¡ç†ï¼Ÿ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                             â”‚
                              â–¼                             â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   æ˜¯    â”‚                   â”‚   å¦    â”‚
                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                             â”‚                             â”‚
                             â–¼                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ <span class="stable">@Stable</span>        â”‚           â”‚ <span class="unstable">ä¸è¦ä½¿ç”¨æ³¨è§£</span>    â”‚
                    â”‚                â”‚           â”‚ <span class="unstable">é‡æ„ä»£ç </span>        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
        </div>

        <div class="callout callout-warning">
            <p class="callout-title">âš ï¸ æ³¨è§£æ˜¯å¥‘çº¦ï¼Œä¸æ˜¯é­”æ³•</p>
            <p>è¿™äº›æ³¨è§£æ˜¯ä½ å¯¹ç¼–è¯‘å™¨çš„<strong>æ‰¿è¯º</strong>ã€‚å¦‚æœä½ æ ‡è®°äº† <code>@Immutable</code> ä½†å®é™…ä¸Šç±»æ˜¯å¯å˜çš„ï¼ŒCompose ä¼šåšå‡ºé”™è¯¯çš„è·³è¿‡å†³ç­–ï¼Œå¯¼è‡´ UI ä¸æ›´æ–°ã€‚ç¼–è¯‘å™¨ä¸ä¼šéªŒè¯ä½ çš„æ‰¿è¯ºï¼</p>
        </div>

        <h2>å››ã€è¯Šæ–­ç¨³å®šæ€§é—®é¢˜</h2>

        <h3>ä½¿ç”¨ Compose Compiler Reports</h3>

        <p>Compose ç¼–è¯‘å™¨å¯ä»¥ç”Ÿæˆè¯¦ç»†çš„ç¨³å®šæ€§æŠ¥å‘Šï¼š</p>

<pre><code><span class="code-comment">// build.gradle.kts</span>
composeCompiler {
    reportsDestination = <span class="code-func">layout</span>.buildDirectory.dir(<span class="code-string">"compose_reports"</span>)
    metricsDestination = <span class="code-func">layout</span>.buildDirectory.dir(<span class="code-string">"compose_metrics"</span>)
}</code></pre>

        <p>è¿è¡Œç¼–è¯‘åï¼Œä½ ä¼šåœ¨ <code>build/compose_reports/</code> ç›®å½•ä¸‹æ‰¾åˆ°ï¼š</p>

        <ul>
            <li><code>*-classes.txt</code>ï¼šæ¯ä¸ªç±»çš„ç¨³å®šæ€§åˆ†æ</li>
            <li><code>*-composables.txt</code>ï¼šæ¯ä¸ª Composable çš„å¯è·³è¿‡æ€§åˆ†æ</li>
            <li><code>*-composables.csv</code>ï¼šCSV æ ¼å¼çš„æ•°æ®ï¼Œä¾¿äºåˆ†æ</li>
        </ul>

        <h3>è§£è¯»æŠ¥å‘Š</h3>

<pre><code><span class="code-comment">// ç¤ºä¾‹ï¼šclasses.txt</span>
<span class="unstable">unstable</span> <span class="code-keyword">class</span> <span class="code-type">UserProfile</span> {
    <span class="stable">stable</span> <span class="code-keyword">val</span> id: <span class="code-type">String</span>
    <span class="stable">stable</span> <span class="code-keyword">val</span> name: <span class="code-type">String</span>
    <span class="unstable">unstable</span> <span class="code-keyword">val</span> friends: <span class="code-type">List</span>&lt;<span class="code-type">User</span>&gt;  <span class="code-comment">// â† è¿™é‡Œå¯¼è‡´æ•´ä¸ªç±»ä¸ç¨³å®šï¼</span>
}

<span class="code-comment">// ç¤ºä¾‹ï¼šcomposables.txt</span>
<span class="unstable">restartable</span> <span class="code-keyword">fun</span> <span class="code-func">UserCard</span>(
    <span class="unstable">unstable</span> user: <span class="code-type">UserProfile</span>  <span class="code-comment">// å‚æ•°ä¸ç¨³å®šï¼Œæ— æ³•è·³è¿‡</span>
)

<span class="stable">restartable skippable</span> <span class="code-keyword">fun</span> <span class="code-func">SimpleText</span>(
    <span class="stable">stable</span> text: <span class="code-type">String</span>  <span class="code-comment">// å‚æ•°ç¨³å®šï¼Œå¯ä»¥è·³è¿‡</span>
)</code></pre>

        <h3>ä½¿ç”¨ Layout Inspector</h3>

        <p>Android Studio çš„ Layout Inspector å¯ä»¥å®æ—¶æ˜¾ç¤º Recomposition æ¬¡æ•°ï¼š</p>

        <ol>
            <li>ä»¥ Debug æ¨¡å¼è¿è¡Œåº”ç”¨</li>
            <li>æ‰“å¼€ Tools â†’ Layout Inspector</li>
            <li>å¯ç”¨ "Show Recomposition Counts"</li>
            <li>è§‚å¯Ÿå“ªäº›ç»„ä»¶é¢‘ç¹é‡ç»„</li>
        </ol>

        <h2>äº”ã€å¸¸è§ç¨³å®šæ€§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h2>

        <h3>é—®é¢˜ 1ï¼šList/Set/Map å‚æ•°</h3>

<pre><code><span class="code-comment">// âŒ ä¸ç¨³å®šï¼šList ç±»å‹</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">UserList</span>(users: <span class="code-type">List</span>&lt;<span class="code-type">User</span>&gt;) { ... }

<span class="code-comment">// âœ… è§£å†³æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ Kotlinx Immutable Collections</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">UserList</span>(users: <span class="code-type">ImmutableList</span>&lt;<span class="code-type">User</span>&gt;) { ... }

<span class="code-comment">// âœ… è§£å†³æ–¹æ¡ˆ 2ï¼šåŒ…è£…åœ¨ç¨³å®šç±»ä¸­</span>
<span class="code-annotation">@Immutable</span>
<span class="code-keyword">data class</span> <span class="code-type">UserListWrapper</span>(<span class="code-keyword">val</span> users: <span class="code-type">List</span>&lt;<span class="code-type">User</span>&gt;)

<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">UserList</span>(wrapper: <span class="code-type">UserListWrapper</span>) { ... }</code></pre>

        <div class="reference">
            <div class="reference-title">ğŸ“š æ¨èåº“</div>
            <a href="https://github.com/Kotlin/kotlinx.collections.immutable" target="_blank">Kotlinx Immutable Collections</a> - Kotlin å®˜æ–¹çš„ä¸å¯å˜é›†åˆåº“
        </div>

        <h3>é—®é¢˜ 2ï¼šå¤–éƒ¨æ¨¡å—çš„ç±»</h3>

<pre><code><span class="code-comment">// âŒ å¤–éƒ¨åº“çš„ç±»ï¼Œç¼–è¯‘å™¨æ— æ³•åˆ†æ</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">DateDisplay</span>(date: <span class="code-type">java.time.LocalDate</span>) { ... }

<span class="code-comment">// âœ… è§£å†³æ–¹æ¡ˆï¼šé…ç½®ç¨³å®šæ€§é…ç½®æ–‡ä»¶</span>
<span class="code-comment">// stability_config.txt</span>
<span class="code-comment">java.time.LocalDate</span>
<span class="code-comment">java.time.LocalDateTime</span>
<span class="code-comment">kotlinx.datetime.*</span>

<span class="code-comment">// build.gradle.kts</span>
composeCompiler {
    stabilityConfigurationFile = <span class="code-func">file</span>(<span class="code-string">"stability_config.txt"</span>)
}</code></pre>

        <h3>é—®é¢˜ 3ï¼šLambda æ•è·</h3>

<pre><code><span class="code-comment">// âŒ Lambda æ•è·äº†ä¸ç¨³å®šçš„å€¼</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">ItemList</span>(items: <span class="code-type">List</span>&lt;<span class="code-type">Item</span>&gt;, viewModel: <span class="code-type">ViewModel</span>) {
    items.<span class="code-func">forEach</span> { item ->
        <span class="code-func">ItemRow</span>(
            item = item,
            onClick = { viewModel.<span class="code-func">onItemClick</span>(item) }  <span class="code-comment">// æ¯æ¬¡åˆ›å»ºæ–° lambda</span>
        )
    }
}

<span class="code-comment">// âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ remember æˆ–æ–¹æ³•å¼•ç”¨</span>
<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">ItemList</span>(items: <span class="code-type">List</span>&lt;<span class="code-type">Item</span>&gt;, viewModel: <span class="code-type">ViewModel</span>) {
    items.<span class="code-func">forEach</span> { item ->
        <span class="code-func">ItemRow</span>(
            item = item,
            onClick = <span class="code-func">remember</span>(item.id) { { viewModel.<span class="code-func">onItemClick</span>(item) } }
        )
    }
}</code></pre>

        <h3>é—®é¢˜ 4ï¼šå«æœ‰ var çš„ data class</h3>

<pre><code><span class="code-comment">// âŒ æœ‰ var å±æ€§ï¼Œä¸ç¨³å®š</span>
<span class="code-keyword">data class</span> <span class="code-type">Counter</span>(
    <span class="code-keyword">var</span> count: <span class="code-type">Int</span>  <span class="code-comment">// varï¼</span>
)

<span class="code-comment">// âœ… è§£å†³æ–¹æ¡ˆ 1ï¼šå…¨éƒ¨æ”¹ä¸º val</span>
<span class="code-keyword">data class</span> <span class="code-type">Counter</span>(
    <span class="code-keyword">val</span> count: <span class="code-type">Int</span>
)

<span class="code-comment">// âœ… è§£å†³æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ MutableState</span>
<span class="code-annotation">@Stable</span>
<span class="code-keyword">class</span> <span class="code-type">CounterState</span> {
    <span class="code-keyword">var</span> count <span class="code-keyword">by</span> <span class="code-func">mutableStateOf</span>(<span class="code-number">0</span>)
}</code></pre>

        <h2>å…­ã€ç¨³å®šæ€§ä¸æ€§èƒ½çš„å…³ç³»</h2>

        <p>è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªå®é™…ä¾‹å­æ¥è¯´æ˜ç¨³å®šæ€§å¯¹æ€§èƒ½çš„å½±å“ï¼š</p>

<pre><code><span class="code-comment">// åœºæ™¯ï¼šä¸€ä¸ªèŠå¤©åº”ç”¨çš„æ¶ˆæ¯åˆ—è¡¨</span>

<span class="code-comment">// âŒ ä¸ç¨³å®šç‰ˆæœ¬</span>
<span class="code-keyword">data class</span> <span class="code-type">Message</span>(
    <span class="code-keyword">val</span> id: <span class="code-type">String</span>,
    <span class="code-keyword">val</span> text: <span class="code-type">String</span>,
    <span class="code-keyword">val</span> reactions: <span class="code-type">List</span>&lt;<span class="code-type">Reaction</span>&gt;  <span class="code-comment">// List ä¸ç¨³å®šï¼</span>
)

<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">MessageList</span>(messages: <span class="code-type">List</span>&lt;<span class="code-type">Message</span>&gt;) {
    <span class="code-func">LazyColumn</span> {
        <span class="code-func">items</span>(messages, key = { it.id }) { message ->
            <span class="code-func">MessageItem</span>(message)  <span class="code-comment">// æ¯æ¬¡éƒ½é‡ç»„ï¼</span>
        }
    }
}

<span class="code-comment">// å½“ç”¨æˆ·å‘é€æ–°æ¶ˆæ¯æ—¶ï¼š</span>
<span class="code-comment">// - æ‰€æœ‰ MessageItem éƒ½ä¼šé‡ç»„</span>
<span class="code-comment">// - å³ä½¿å®ƒä»¬çš„å†…å®¹æ²¡æœ‰å˜åŒ–</span>
<span class="code-comment">// - å› ä¸º Message ç±»ä¸ç¨³å®š</span></code></pre>

<pre><code><span class="code-comment">// âœ… ç¨³å®šç‰ˆæœ¬</span>
<span class="code-annotation">@Immutable</span>
<span class="code-keyword">data class</span> <span class="code-type">Message</span>(
    <span class="code-keyword">val</span> id: <span class="code-type">String</span>,
    <span class="code-keyword">val</span> text: <span class="code-type">String</span>,
    <span class="code-keyword">val</span> reactions: <span class="code-type">ImmutableList</span>&lt;<span class="code-type">Reaction</span>&gt;  <span class="code-comment">// ä½¿ç”¨ä¸å¯å˜é›†åˆ</span>
)

<span class="code-keyword">@Composable</span>
<span class="code-keyword">fun</span> <span class="code-func">MessageList</span>(messages: <span class="code-type">ImmutableList</span>&lt;<span class="code-type">Message</span>&gt;) {
    <span class="code-func">LazyColumn</span> {
        <span class="code-func">items</span>(messages, key = { it.id }) { message ->
            <span class="code-func">MessageItem</span>(message)  <span class="code-comment">// åªæœ‰å˜åŒ–çš„æ¶ˆæ¯æ‰é‡ç»„</span>
        }
    }
}

<span class="code-comment">// å½“ç”¨æˆ·å‘é€æ–°æ¶ˆæ¯æ—¶ï¼š</span>
<span class="code-comment">// - åªæœ‰æ–°çš„ MessageItem ä¼šç»„åˆ</span>
<span class="code-comment">// - æ—§æ¶ˆæ¯çš„ MessageItem è¢«è·³è¿‡</span>
<span class="code-comment">// - æ€§èƒ½å¤§å¹…æå‡ï¼</span></code></pre>

        <h2>ä¸ƒã€Strong Skipping Modeï¼ˆå®éªŒæ€§ï¼‰</h2>

        <p>Compose 1.5.4+ å¼•å…¥äº† <strong>Strong Skipping Mode</strong>ï¼Œå®ƒæ”¹å˜äº†ç¨³å®šæ€§çš„é»˜è®¤è¡Œä¸ºï¼š</p>

<pre><code><span class="code-comment">// build.gradle.kts</span>
composeCompiler {
    enableStrongSkippingMode = <span class="code-keyword">true</span>
}</code></pre>

        <p>åœ¨ Strong Skipping Mode ä¸‹ï¼š</p>

        <ul>
            <li>æ‰€æœ‰ Composable å‡½æ•°éƒ½å¯ä»¥è¢«è·³è¿‡ï¼ˆä¸å†è¦æ±‚æ‰€æœ‰å‚æ•°éƒ½ç¨³å®šï¼‰</li>
            <li>ä¸ç¨³å®šå‚æ•°ä½¿ç”¨ <strong>å®ä¾‹ç›¸ç­‰æ€§ï¼ˆ===ï¼‰</strong> è€Œé <code>equals()</code> æ¥æ¯”è¾ƒ</li>
            <li>Lambda å‚æ•°ä¼šè¢«è‡ªåŠ¨è®°å¿†åŒ–</li>
        </ul>

        <div class="callout">
            <p class="callout-title">ğŸ”¬ Strong Skipping çš„æƒè¡¡</p>
            <p>Strong Skipping å‡å°‘äº†å¯¹ç¨³å®šæ€§æ³¨è§£çš„éœ€æ±‚ï¼Œä½†ä¹Ÿæ”¹å˜äº†æ¯”è¾ƒè¯­ä¹‰ã€‚å¦‚æœä½ ä¾èµ– <code>equals()</code> æ¥åˆ¤æ–­æ˜¯å¦é‡ç»„ï¼Œéœ€è¦æ³¨æ„è¿™ä¸ªå˜åŒ–ã€‚</p>
        </div>

        <div class="reference">
            <div class="reference-title">ğŸ“š æ·±å…¥é˜…è¯»</div>
            <a href="https://android-developers.googleblog.com/2024/02/jetpack-compose-strong-skipping-mode.html" target="_blank">Strong Skipping Mode Explained - Android Developers Blog</a>
        </div>

        <h2>å…«ã€æœ€ä½³å®è·µæ€»ç»“</h2>

        <h3>DO âœ…</h3>

        <ul>
            <li>ä¼˜å…ˆä½¿ç”¨ <code>val</code> å’Œä¸å¯å˜æ•°æ®ç»“æ„</li>
            <li>ä¸ºä¸å¯å˜ data class æ·»åŠ  <code>@Immutable</code></li>
            <li>ä¸ºåŒ…å« <code>MutableState</code> çš„ç±»æ·»åŠ  <code>@Stable</code></li>
            <li>ä½¿ç”¨ Kotlinx Immutable Collections æ›¿ä»£æ ‡å‡†é›†åˆ</li>
            <li>å®šæœŸæ£€æŸ¥ Compose Compiler Reports</li>
            <li>ä½¿ç”¨ Layout Inspector ç›‘æ§é‡ç»„</li>
        </ul>

        <h3>DON'T âŒ</h3>

        <ul>
            <li>ä¸è¦ä¸ºå¯å˜ç±»æ·»åŠ  <code>@Immutable</code></li>
            <li>ä¸è¦å¿½ç•¥ç¼–è¯‘å™¨æŠ¥å‘Šä¸­çš„ä¸ç¨³å®šè­¦å‘Š</li>
            <li>ä¸è¦åœ¨ Composable å†…éƒ¨åˆ›å»ºæ–°çš„ lambdaï¼ˆé™¤éå¿…è¦ï¼‰</li>
            <li>ä¸è¦å‡è®¾æ‰€æœ‰ data class éƒ½æ˜¯ç¨³å®šçš„</li>
        </ul>

        <h2>æ€»ç»“</h2>

        <p>Compose çš„ç¨³å®šæ€§ç³»ç»Ÿæ˜¯æ™ºèƒ½é‡ç»„çš„åŸºç¡€ï¼š</p>

        <ul>
            <li><strong>ç¨³å®šæ€§</strong>å†³å®šäº† Compose èƒ½å¦å®‰å…¨è·³è¿‡é‡ç»„</li>
            <li><strong>@Immutable</strong> ç”¨äºå®Œå…¨ä¸å¯å˜çš„ç±»å‹</li>
            <li><strong>@Stable</strong> ç”¨äºå˜åŒ–å¯è¢«è¿½è¸ªçš„ç±»å‹</li>
            <li><strong>ç¼–è¯‘å™¨æŠ¥å‘Š</strong>æ˜¯è¯Šæ–­é—®é¢˜çš„æœ€ä½³å·¥å…·</li>
            <li><strong>ä¸å¯å˜é›†åˆ</strong>æ˜¯è§£å†³é›†åˆç¨³å®šæ€§é—®é¢˜çš„å…³é”®</li>
        </ul>

        <p>ç†è§£å¹¶æ­£ç¡®ä½¿ç”¨ç¨³å®šæ€§ç³»ç»Ÿï¼Œå¯ä»¥æ˜¾è‘—æå‡ Compose åº”ç”¨çš„æ€§èƒ½ã€‚</p>

        <div class="reference">
            <div class="reference-title">ğŸ“š æ¨èé˜…è¯»</div>
            <a href="https://developer.android.com/jetpack/compose/performance/stability" target="_blank">Stability in Compose - Android Developers</a><br>
            <a href="https://chris.banes.dev/composable-metrics/" target="_blank">Composable Metrics - Chris Banes</a><br>
            <a href="https://www.jetpackcompose.app/articles/donut-hole-skipping-in-jetpack-compose" target="_blank">Donut-hole Skipping - Jetpack Compose App</a>
        </div>
    </article>

    <footer class="footer">
        <p>&copy; 2024 Fidroid. <a href="../index.html">è¿”å›é¦–é¡µ</a></p>
    </footer>
</body>
</html>


